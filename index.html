import React, { useState, useEffect, useCallback } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, orderBy, where, doc, updateDoc, writeBatch, deleteDoc } from 'firebase/firestore';

// Global variables provided by the Canvas environment
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
// FIX: Corrected the assignment of initialAuthToken to use __initial_auth_token
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

function App() {
    const [currentPage, setCurrentPage] = useState('receive'); // 'receive', 'issue', 'stock', 'stockByIV', 'report', 'items'
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [reportSelectedItem, setReportSelectedItem] = useState(''); // State to pass item name to report page

    // Initialize Firebase and authenticate
    useEffect(() => {
        try {
            const app = initializeApp(firebaseConfig);
            const firestore = getFirestore(app);
            const firebaseAuth = getAuth(app);

            setDb(firestore);
            setAuth(firebaseAuth);

            const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    // Sign in anonymously if no initial token or user
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(firebaseAuth, initialAuthToken);
                        } else {
                            await signInAnonymously(firebaseAuth);
                        }
                    } catch (authError) {
                        console.error("Firebase Auth Error:", authError);
                        setError("Failed to authenticate. Please try again.");
                    }
                }
                setIsAuthReady(true); // Auth state is ready
                setLoading(false);
            });

            return () => unsubscribe();
        } catch (e) {
            console.error("Failed to initialize Firebase:", e);
            setError("Failed to initialize the application. Please check your Firebase configuration.");
            setLoading(false);
        }
    }, []);

    if (loading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
                <div className="text-xl font-semibold text-gray-700">กำลังโหลด...</div>
            </div>
        );
    }

    if (error) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-red-100 text-red-700 p-4 rounded-lg">
                <div className="text-xl font-semibold">เกิดข้อผิดพลาด: {error}</div>
            </div>
        );
    }

    if (!isAuthReady || !userId) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-100">
                <div className="text-xl font-semibold text-gray-700">กำลังตรวจสอบสิทธิ์ผู้ใช้...</div>
            </div>
        );
    }

    // Base path for public data
    const publicDataPath = `artifacts/${appId}/public/data`;

    return (
        <div className="min-h-screen bg-gray-100 font-sans antialiased flex flex-col">
            <header className="bg-gradient-to-r from-blue-600 to-blue-800 text-white shadow-lg p-4">
                <div className="container mx-auto flex flex-col sm:flex-row justify-between items-center">
                    <h1 className="text-3xl font-bold mb-2 sm:mb-0">ระบบเบิกจ่ายสินค้า</h1>
                    <nav className="flex flex-wrap justify-center gap-2 sm:gap-4">
                        <button
                            onClick={() => setCurrentPage('receive')}
                            className={`px-4 py-2 rounded-lg transition-all duration-200 ${
                                currentPage === 'receive' ? 'bg-blue-400 shadow-md' : 'hover:bg-blue-700'
                            }`}
                        >
                            รับเข้าสินค้า
                        </button>
                        <button
                            onClick={() => setCurrentPage('issue')}
                            className={`px-4 py-2 rounded-lg transition-all duration-200 ${
                                currentPage === 'issue' ? 'bg-blue-400 shadow-md' : 'hover:bg-blue-700'
                            }`}
                        >
                            จ่ายออกสินค้า
                        </button>
                        <button
                            onClick={() => setCurrentPage('stock')}
                            className={`px-4 py-2 rounded-lg transition-all duration-200 ${
                                currentPage === 'stock' ? 'bg-blue-400 shadow-md' : 'hover:bg-blue-700'
                            }`}
                        >
                            สินค้าคงเหลือ
                        </button>
                        <button
                            onClick={() => setCurrentPage('stockByIV')}
                            className={`px-4 py-2 rounded-lg transition-all duration-200 ${
                                currentPage === 'stockByIV' ? 'bg-blue-400 shadow-md' : 'hover:bg-blue-700'
                            }`}
                        >
                            สินค้าคงเหลือ (แยกเลขที่ IV)
                        </button>
                        <button
                            onClick={() => setCurrentPage('report')}
                            className={`px-4 py-2 rounded-lg transition-all duration-200 ${
                                currentPage === 'report' ? 'bg-blue-400 shadow-md' : 'hover:bg-blue-700'
                            }`}
                        >
                            รายงานเคลื่อนไหวสินค้ารายตัว
                        </button>
                        <button
                            onClick={() => setCurrentPage('items')}
                            className={`px-4 py-2 rounded-lg transition-all duration-200 ${
                                currentPage === 'items' ? 'bg-blue-400 shadow-md' : 'hover:bg-blue-700'
                            }`}
                        >
                            เมนูสินค้า
                        </button>
                    </nav>
                </div>
            </header>

            <main className="flex-grow container mx-auto p-4 sm:p-6 lg:p-8">
                {currentPage === 'receive' && <ReceiveItems db={db} userId={userId} publicDataPath={publicDataPath} />}
                {currentPage === 'issue' && <IssueItems db={db} userId={userId} publicDataPath={publicDataPath} />}
                {currentPage === 'stock' && <StockBalance db={db} userId={userId} publicDataPath={publicDataPath} />}
                {currentPage === 'stockByIV' && <StockBalanceByIV db={db} userId={userId} publicDataPath={publicDataPath} setCurrentPage={setCurrentPage} setReportSelectedItem={setReportSelectedItem} />}
                {currentPage === 'report' && <ItemMovementReport db={db} userId={userId} publicDataPath={publicDataPath} initialSelectedItem={reportSelectedItem} setInitialSelectedItem={setReportSelectedItem} />}
                {currentPage === 'items' && <ItemMaster db={db} userId={userId} publicDataPath={publicDataPath} />}
            </main>

            <footer className="bg-gray-800 text-white p-4 text-center text-sm">
                <p>&copy; 2024 ระบบเบิกจ่ายสินค้า. ผู้ใช้งาน ID: {userId}</p>
            </footer>
        </div>
    );
}

// Utility function to format date
const formatDate = (timestamp) => {
    if (!timestamp) return '';
    const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
    return date.toLocaleDateString('th-TH', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
    });
};

// --- Confirmation Modal Component ---
function ConfirmationModal({ isOpen, title, message, onConfirm, onCancel }) {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
                <h3 className="text-lg font-semibold text-gray-900 mb-4">{title}</h3>
                <p className="text-gray-700 mb-6">{message}</p>
                <div className="flex justify-end space-x-3">
                    <button
                        onClick={onCancel}
                        className="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors duration-200"
                    >
                        ยกเลิก
                    </button>
                    <button
                        onClick={onConfirm}
                        className="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors duration-200"
                    >
                        ยืนยัน
                    </button>
                </div>
            </div>
        </div>
    );
}

// --- Receive Items Component ---
function ReceiveItems({ db, userId, publicDataPath }) {
    const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
    const [itemName, setItemName] = useState('');
    const [unit, setUnit] = useState('');
    const [quantity, setQuantity] = useState('');
    const [poNumber, setPoNumber] = useState('');
    const [ivNumber, setIvNumber] = useState('');
    const [message, setMessage] = useState('');
    const [messageType, setMessageType] = useState(''); // 'success' or 'error'
    const [items, setItems] = useState([]); // List of existing items for dropdown
    const [recentTransactions, setRecentTransactions] = useState([]);
    const [isLoading, setIsLoading] = useState(false);

    // Validation states
    const [itemNameError, setItemNameError] = useState('');
    const [unitError, setUnitError] = useState('');
    const [quantityError, setQuantityError] = useState('');
    const [ivNumberError, setIvNumberError] = useState('');

    const itemsCollectionRef = collection(db, `${publicDataPath}/items`);
    const transactionsCollectionRef = collection(db, `${publicDataPath}/transactions`);

    // Fetch existing items for dropdown and recent transactions
    useEffect(() => {
        if (!db || !userId) return;
        setIsLoading(true);

        // Fetch items
        const unsubscribeItems = onSnapshot(itemsCollectionRef, (snapshot) => {
            const itemsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setItems(itemsData);
        }, (error) => {
            console.error("Error fetching items:", error);
            setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลสินค้า.");
            setMessageType('error');
        });

        // Fetch recent receive transactions
        const q = query(transactionsCollectionRef, where('type', '==', 'receive'));
        const unsubscribeTransactions = onSnapshot(q, (snapshot) => {
            const transactionsData = snapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .sort((a, b) => b.date.toDate() - a.date.toDate()); // Sort in JavaScript
            setRecentTransactions(transactionsData);
            setIsLoading(false);
        }, (error) => {
            console.error("Error fetching recent transactions:", error);
            setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลการรับเข้าล่าสุด.");
            setMessageType('error');
            setIsLoading(false);
        });

        return () => {
            unsubscribeItems();
            unsubscribeTransactions();
        };
    }, [db, userId, publicDataPath]);

    const handleItemNameChange = (e) => {
        const selectedName = e.target.value;
        setItemName(selectedName);
        const selectedItem = items.find(item => item.name === selectedName);
        if (selectedItem) {
            setUnit(selectedItem.unit || '');
        } else {
            setUnit(''); // Clear unit if a new item name is typed
        }
        setItemNameError(''); // Clear error on change
    };

    const handleUnitChange = (e) => {
        setUnit(e.target.value);
        setUnitError('');
    };

    const handleQuantityChange = (e) => {
        setQuantity(e.target.value);
        setQuantityError('');
    };

    const handleIvNumberChange = (e) => {
        setIvNumber(e.target.value);
        setIvNumberError('');
    };

    const validateForm = () => {
        let isValid = true;
        if (!itemName) {
            setItemNameError('กรุณากรอกชื่อสินค้า');
            isValid = false;
        } else {
            setItemNameError('');
        }
        if (!unit) {
            setUnitError('กรุณากรอกหน่วยนับ');
            isValid = false;
        } else {
            setUnitError('');
        }
        if (isNaN(quantity) || parseFloat(quantity) <= 0) {
            setQuantityError('จำนวนรับเข้าต้องเป็นตัวเลขและมากกว่า 0');
            isValid = false;
        } else {
            setQuantityError('');
        }
        if (!ivNumber) {
            setIvNumberError('กรุณากรอกเลขที่ IV');
            isValid = false;
        } else {
            setIvNumberError('');
        }
        return isValid;
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setMessage('');
        setMessageType('');

        if (!validateForm()) {
            return;
        }

        setIsLoading(true);
        try {
            const batch = writeBatch(db);

            // 1. Add/Update item master data
            const existingItemQuery = query(itemsCollectionRef, where('name', '==', itemName));
            const existingItemSnapshot = await getDocs(existingItemQuery);

            let itemDocRef;
            if (existingItemSnapshot.empty) {
                // Item does not exist, add new item
                itemDocRef = doc(itemsCollectionRef); // Firestore will auto-generate ID
                batch.set(itemDocRef, {
                    name: itemName,
                    unit: unit,
                    minStock: 0, // Default minimum stock for new items
                });
            } else {
                // Item exists, update its unit if changed (or just ensure it exists)
                itemDocRef = existingItemSnapshot.docs[0].ref;
                if (existingItemSnapshot.docs[0].data().unit !== unit) {
                    batch.update(itemDocRef, { unit: unit });
                }
            }

            // 2. Add transaction
            await addDoc(transactionsCollectionRef, {
                date: new Date(date),
                itemName: itemName,
                unit: unit,
                quantity: parseFloat(quantity),
                type: 'receive',
                poNumber: poNumber,
                ivNumber: ivNumber,
                userId: userId,
            });

            setMessage('บันทึกการรับเข้าสินค้าเรียบร้อยแล้ว!');
            setMessageType('success');
            // Clear form
            setItemName('');
            setUnit('');
            setQuantity('');
            setPoNumber('');
            setIvNumber('');
            setDate(new Date().toISOString().split('T')[0]); // Reset date to today
            // Clear validation errors
            setItemNameError('');
            setUnitError('');
            setQuantityError('');
            setIvNumberError('');
        } catch (e) {
            console.error("Error adding document: ", e);
            setMessage('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + e.message);
            setMessageType('error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-xl mb-8">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">เมนูรับเข้าสินค้า</h2>
            {message && (
                <div className={`p-3 mb-4 rounded-md ${messageType === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                    {message}
                </div>
            )}
            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label htmlFor="receiveDate" className="block text-sm font-medium text-gray-700">วันที่:</label>
                    <input
                        type="date"
                        id="receiveDate"
                        value={date}
                        onChange={(e) => setDate(e.target.value)}
                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        required
                    />
                </div>
                <div>
                    <label htmlFor="itemName" className="block text-sm font-medium text-gray-700">ชื่อสินค้า:</label>
                    <input
                        list="item-names"
                        id="itemName"
                        value={itemName}
                        onChange={handleItemNameChange}
                        className={`mt-1 block w-full px-3 py-2 border ${itemNameError ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                        placeholder="เลือกหรือพิมพ์ชื่อสินค้า"
                        required
                    />
                    <datalist id="item-names">
                        {items.map(item => (
                            <option key={item.id} value={item.name} />
                        ))}
                    </datalist>
                    {itemNameError && <p className="text-red-500 text-xs mt-1">{itemNameError}</p>}
                </div>
                <div>
                    <label htmlFor="unit" className="block text-sm font-medium text-gray-700">หน่วยนับ:</label>
                    <input
                        type="text"
                        id="unit"
                        value={unit}
                        onChange={handleUnitChange}
                        className={`mt-1 block w-full px-3 py-2 border ${unitError ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                        placeholder="เช่น ชิ้น, กล่อง, กิโลกรัม"
                        required
                    />
                    {unitError && <p className="text-red-500 text-xs mt-1">{unitError}</p>}
                </div>
                <div>
                    <label htmlFor="quantity" className="block text-sm font-medium text-gray-700">จำนวนรับเข้า:</label>
                    <input
                        type="number"
                        id="quantity"
                        value={quantity}
                        onChange={handleQuantityChange}
                        className={`mt-1 block w-full px-3 py-2 border ${quantityError ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                        min="1"
                        required
                    />
                    {quantityError && <p className="text-red-500 text-xs mt-1">{quantityError}</p>}
                </div>
                <div>
                    <label htmlFor="poNumber" className="block text-sm font-medium text-gray-700">เลขที่ PO (ถ้ามี):</label>
                    <input
                        type="text"
                        id="poNumber"
                        value={poNumber}
                        onChange={(e) => setPoNumber(e.target.value)}
                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    />
                </div>
                <div>
                    <label htmlFor="ivNumber" className="block text-sm font-medium text-gray-700">เลขที่ IV:</label>
                    <input
                        type="text"
                        id="ivNumber"
                        value={ivNumber}
                        onChange={handleIvNumberChange}
                        className={`mt-1 block w-full px-3 py-2 border ${ivNumberError ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                        required
                    />
                    {ivNumberError && <p className="text-red-500 text-xs mt-1">{ivNumberError}</p>}
                </div>
                <div className="md:col-span-2 flex justify-end items-center">
                    <button
                        type="submit"
                        className="mt-4 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled={isLoading}
                    >
                        {isLoading ? 'กำลังบันทึก...' : 'บันทึกรับเข้า'}
                    </button>
                </div>
            </form>

            <h3 className="text-xl font-bold text-gray-800 mt-8 mb-4">รายการรับเข้าล่าสุด</h3>
            {isLoading ? (
                <div className="text-center text-gray-600">กำลังโหลดรายการ...</div>
            ) : recentTransactions.length === 0 ? (
                <p className="text-gray-600">ยังไม่มีรายการรับเข้า.</p>
            ) : (
                <div className="overflow-x-auto rounded-lg shadow-md">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อสินค้า</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">หน่วยนับ</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวน</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เลขที่ PO</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เลขที่ IV</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {recentTransactions.map((transaction) => (
                                <tr key={transaction.id}>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{formatDate(transaction.date)}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{transaction.itemName}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{transaction.unit}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{transaction.quantity}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{transaction.poNumber || '-'}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{transaction.ivNumber}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
}

// --- Issue Items Component ---
function IssueItems({ db, userId, publicDataPath }) {
    const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
    const [itemName, setItemName] = useState('');
    const [unit, setUnit] = useState('');
    const [quantity, setQuantity] = useState('');
    const [ivNumber, setIvNumber] = useState('');
    const [message, setMessage] = useState('');
    const [messageType, setMessageType] = useState('');
    const [items, setItems] = useState([]); // List of existing items for dropdown
    const [recentTransactions, setRecentTransactions] = useState([]);
    const [isLoading, setIsLoading] = useState(false);

    // Validation states
    const [itemNameError, setItemNameError] = useState('');
    const [unitError, setUnitError] = useState('');
    const [quantityError, setQuantityError] = useState('');
    const [ivNumberError, setIvNumberError] = useState('');

    const itemsCollectionRef = collection(db, `${publicDataPath}/items`);
    const transactionsCollectionRef = collection(db, `${publicDataPath}/transactions`);

    // Fetch existing items for dropdown and recent transactions
    useEffect(() => {
        if (!db || !userId) return;
        setIsLoading(true);

        // Fetch items
        const unsubscribeItems = onSnapshot(itemsCollectionRef, (snapshot) => {
            const itemsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setItems(itemsData);
        }, (error) => {
            console.error("Error fetching items:", error);
            setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลสินค้า.");
            setMessageType('error');
        });

        // Fetch recent issue transactions
        const q = query(transactionsCollectionRef, where('type', '==', 'issue'));
        const unsubscribeTransactions = onSnapshot(q, (snapshot) => {
            const transactionsData = snapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .sort((a, b) => b.date.toDate() - a.date.toDate()); // Sort in JavaScript
            setRecentTransactions(transactionsData);
            setIsLoading(false);
        }, (error) => {
            console.error("Error fetching recent transactions:", error);
            setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลการจ่ายออกล่าสุด.");
            setMessageType('error');
            setIsLoading(false);
        });

        return () => {
            unsubscribeItems();
            unsubscribeTransactions();
        };
    }, [db, userId, publicDataPath]);

    const handleItemNameChange = (e) => {
        const selectedName = e.target.value;
        setItemName(selectedName);
        const selectedItem = items.find(item => item.name === selectedName);
        if (selectedItem) {
            setUnit(selectedItem.unit || '');
        } else {
            setUnit(''); // Clear unit if a new item name is typed
        }
        setItemNameError('');
    };

    const handleUnitChange = (e) => {
        setUnit(e.target.value);
        setUnitError('');
    };

    const handleQuantityChange = (e) => {
        setQuantity(e.target.value);
        setQuantityError('');
    };

    const handleIvNumberChange = (e) => {
        setIvNumber(e.target.value);
        setIvNumberError('');
    };

    const validateForm = () => {
        let isValid = true;
        if (!itemName) {
            setItemNameError('กรุณาเลือกชื่อสินค้า');
            isValid = false;
        } else {
            setItemNameError('');
        }
        if (!unit) {
            setUnitError('กรุณากรอกหน่วยนับ');
            isValid = false;
        } else {
            setUnitError('');
        }
        if (isNaN(quantity) || parseFloat(quantity) <= 0) {
            setQuantityError('จำนวนจ่ายออกต้องเป็นตัวเลขและมากกว่า 0');
            isValid = false;
        } else {
            setQuantityError('');
        }
        if (!ivNumber) {
            setIvNumberError('กรุณากรอกเลขที่ IV');
            isValid = false;
        } else {
            setIvNumberError('');
        }
        return isValid;
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        setMessage('');
        setMessageType('');

        if (!validateForm()) {
            return;
        }

        setIsLoading(true);
        try {
            // Check if item exists in master data
            const existingItemQuery = query(itemsCollectionRef, where('name', '==', itemName));
            const existingItemSnapshot = await getDocs(existingItemQuery);

            if (existingItemSnapshot.empty) {
                setMessage(`สินค้าชื่อ "${itemName}" ไม่มีอยู่ในระบบ กรุณารับเข้าสินค้าก่อน.`);
                setMessageType('error');
                setIsLoading(false);
                return;
            }

            // Add transaction
            await addDoc(transactionsCollectionRef, {
                date: new Date(date),
                itemName: itemName,
                unit: unit,
                quantity: -parseFloat(quantity), // Negative for issue
                type: 'issue',
                poNumber: '', // PO Number is not applicable for issue
                ivNumber: ivNumber,
                userId: userId,
            });

            setMessage('บันทึกการจ่ายออกสินค้าเรียบร้อยแล้ว!');
            setMessageType('success');
            // Clear form
            setItemName('');
            setUnit('');
            setQuantity('');
            setIvNumber('');
            setDate(new Date().toISOString().split('T')[0]); // Reset date to today
            // Clear validation errors
            setItemNameError('');
            setUnitError('');
            setQuantityError('');
            setIvNumberError('');
        } catch (e) {
            console.error("Error adding document: ", e);
            setMessage('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + e.message);
            setMessageType('error');
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-xl mb-8">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">เมนูจ่ายออกสินค้า</h2>
            {message && (
                <div className={`p-3 mb-4 rounded-md ${messageType === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                    {message}
                </div>
            )}
            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label htmlFor="issueDate" className="block text-sm font-medium text-gray-700">วันที่:</label>
                    <input
                        type="date"
                        id="issueDate"
                        value={date}
                        onChange={(e) => setDate(e.target.value)}
                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        required
                    />
                </div>
                <div>
                    <label htmlFor="itemNameIssue" className="block text-sm font-medium text-gray-700">ชื่อสินค้า:</label>
                    <input
                        list="item-names-issue"
                        id="itemNameIssue"
                        value={itemName}
                        onChange={handleItemNameChange}
                        className={`mt-1 block w-full px-3 py-2 border ${itemNameError ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                        placeholder="เลือกชื่อสินค้า"
                        required
                    />
                    <datalist id="item-names-issue">
                        {items.map(item => (
                            <option key={item.id} value={item.name} />
                        ))}
                    </datalist>
                    {itemNameError && <p className="text-red-500 text-xs mt-1">{itemNameError}</p>}
                </div>
                <div>
                    <label htmlFor="unitIssue" className="block text-sm font-medium text-gray-700">หน่วยนับ:</label>
                    <input
                        type="text"
                        id="unitIssue"
                        value={unit}
                        onChange={handleUnitChange}
                        className={`mt-1 block w-full px-3 py-2 border ${unitError ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                        placeholder="เช่น ชิ้น, กล่อง"
                        required
                        readOnly // Unit should be read-only if selected from existing items
                    />
                    {unitError && <p className="text-red-500 text-xs mt-1">{unitError}</p>}
                </div>
                <div>
                    <label htmlFor="quantityIssue" className="block text-sm font-medium text-gray-700">จำนวนจ่ายออก:</label>
                    <input
                        type="number"
                        id="quantityIssue"
                        value={quantity}
                        onChange={handleQuantityChange}
                        className={`mt-1 block w-full px-3 py-2 border ${quantityError ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                        min="1"
                        required
                    />
                    {quantityError && <p className="text-red-500 text-xs mt-1">{quantityError}</p>}
                </div>
                <div>
                    <label htmlFor="ivNumberIssue" className="block text-sm font-medium text-gray-700">เลขที่ IV:</label>
                    <input
                        type="text"
                        id="ivNumberIssue"
                        value={ivNumber}
                        onChange={handleIvNumberChange}
                        className={`mt-1 block w-full px-3 py-2 border ${ivNumberError ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                        required
                    />
                    {ivNumberError && <p className="text-red-500 text-xs mt-1">{ivNumberError}</p>}
                </div>
                <div className="md:col-span-2 flex justify-end items-center">
                    <button
                        type="submit"
                        className="mt-4 px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled={isLoading}
                    >
                        {isLoading ? 'กำลังบันทึก...' : 'บันทึกจ่ายออก'}
                    </button>
                </div>
            </form>

            <h3 className="text-xl font-bold text-gray-800 mt-8 mb-4">รายการจ่ายออกล่าสุด</h3>
            {isLoading ? (
                <div className="text-center text-gray-600">กำลังโหลดรายการ...</div>
            ) : recentTransactions.length === 0 ? (
                <p className="text-gray-600">ยังไม่มีรายการจ่ายออก.</p>
            ) : (
                <div className="overflow-x-auto rounded-lg shadow-md">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อสินค้า</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">หน่วยนับ</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวน</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เลขที่ IV</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {recentTransactions.map((transaction) => (
                                <tr key={transaction.id}>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{formatDate(transaction.date)}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{transaction.itemName}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{transaction.unit}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{Math.abs(transaction.quantity)}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{transaction.ivNumber}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
}

// --- Stock Balance Component ---
function StockBalance({ db, userId, publicDataPath }) {
    const [stockItems, setStockItems] = useState([]);
    const [message, setMessage] = useState('');
    const [messageType, setMessageType] = useState('');
    const [isLoading, setIsLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');

    const itemsCollectionRef = collection(db, `${publicDataPath}/items`);
    const transactionsCollectionRef = collection(db, `${publicDataPath}/transactions`);

    // Function to calculate stock and reorder status
    const calculateStock = useCallback(async (itemsData, transactionsData) => {
        const stockMap = new Map();

        // Initialize stock with item master data
        itemsData.forEach(item => {
            stockMap.set(item.name, {
                name: item.name,
                unit: item.unit,
                currentStock: 0,
                minStock: item.minStock || 0,
                status: 'ปกติ',
                id: item.id, // Keep item ID for updating minStock
            });
        });

        // Apply transactions to calculate current stock
        transactionsData.forEach(transaction => {
            if (stockMap.has(transaction.itemName)) {
                const current = stockMap.get(transaction.itemName);
                current.currentStock += transaction.quantity;
                stockMap.set(transaction.itemName, current);
            } else {
                // If a transaction exists for an item not in master, add it
                stockMap.set(transaction.itemName, {
                    name: transaction.itemName,
                    unit: transaction.unit,
                    currentStock: transaction.quantity,
                    minStock: 0, // Default min stock for items only in transactions
                    status: 'ปกติ',
                    id: null, // No item master ID
                });
            }
        });

        // Determine reorder status
        const calculatedStock = Array.from(stockMap.values()).map(item => {
            item.status = item.currentStock < item.minStock ? 'ต้องเติม' : 'ปกติ';
            return item;
        });

        // Sort by item name
        calculatedStock.sort((a, b) => a.name.localeCompare(b.name));

        setStockItems(calculatedStock);
    }, []);

    // Fetch data for stock balance
    useEffect(() => {
        if (!db || !userId) return;
        setIsLoading(true);

        let unsubscribeItems;
        let unsubscribeTransactions;

        const fetchData = async () => {
            try {
                // Fetch all items
                unsubscribeItems = onSnapshot(itemsCollectionRef, (itemSnapshot) => {
                    const itemsData = itemSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Fetch all transactions
                    unsubscribeTransactions = onSnapshot(transactionsCollectionRef, (transactionSnapshot) => {
                        const transactionsData = transactionSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        calculateStock(itemsData, transactionsData);
                        setIsLoading(false);
                    }, (error) => {
                        console.error("Error fetching transactions for stock:", error);
                        setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลการเคลื่อนไหวสินค้า.");
                        setMessageType('error');
                        setIsLoading(false);
                    });
                }, (error) => {
                    console.error("Error fetching items for stock:", error);
                    setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลสินค้า.");
                    setMessageType('error');
                    setIsLoading(false);
                });

            } catch (e) {
                console.error("Error fetching stock data:", e);
                setMessage("เกิดข้อผิดพลาดในการโหลดข้อมูลสินค้าคงเหลือ.");
                setMessageType('error');
                setIsLoading(false);
            }
        };

        fetchData();

        return () => {
            if (unsubscribeItems) unsubscribeItems();
            if (unsubscribeTransactions) unsubscribeTransactions();
        };
    }, [db, userId, publicDataPath, calculateStock]);

    const handleMinStockChange = async (itemId, newMinStock) => {
        if (!db || !itemId) return;
        setMessage('');
        setMessageType('');

        if (isNaN(newMinStock) || newMinStock < 0) {
            setMessage('จำนวนขั้นต่ำต้องเป็นตัวเลขและไม่ติดลบ.');
            setMessageType('error');
            return;
        }

        try {
            const itemDocRef = doc(db, `${publicDataPath}/items`, itemId);
            await updateDoc(itemDocRef, { minStock: parseFloat(newMinStock) });
            setMessage('อัปเดตจำนวนขั้นต่ำเรียบร้อยแล้ว!');
            setMessageType('success');
        } catch (e) {
            console.error("Error updating min stock:", e);
            setMessage('เกิดข้อผิดพลาดในการอัปเดตจำนวนขั้นต่ำ: ' + e.message);
            setMessageType('error');
        }
    };

    // Filtered stock items based on search term
    const filteredStockItems = stockItems.filter(item =>
        item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        item.unit.toLowerCase().includes(searchTerm.toLowerCase()) ||
        item.status.toLowerCase().includes(searchTerm.toLowerCase())
    );

    // Function to add sample data if collections are empty
    const addSampleData = async () => {
        if (!db || !userId) return;
        setMessage('');
        setMessageType('');
        setIsLoading(true);

        try {
            const itemsSnapshot = await getDocs(itemsCollectionRef);
            const transactionsSnapshot = await getDocs(transactionsCollectionRef);

            if (itemsSnapshot.empty && transactionsSnapshot.empty) {
                const batch = writeBatch(db);

                // Sample Items
                const sampleItems = [
                    { name: 'ปากกาเจลสีน้ำเงิน', unit: 'ด้าม', minStock: 20 },
                    { name: 'กระดาษ A4', unit: 'รีม', minStock: 5 },
                    { name: 'แฟ้มเอกสาร', unit: 'อัน', minStock: 10 },
                    { name: 'หมึกพิมพ์ HP 680', unit: 'ตลับ', minStock: 3 },
                    { name: 'เทปกาวใส', unit: 'ม้วน', minStock: 15 },
                ];

                sampleItems.forEach(item => {
                    const itemDocRef = doc(itemsCollectionRef);
                    batch.set(itemDocRef, item);
                });

                // Sample Transactions
                const sampleTransactions = [
                    { date: new Date('2024-07-01'), itemName: 'ปากกาเจลสีน้ำเงิน', unit: 'ด้าม', quantity: 50, type: 'receive', poNumber: 'PO001', ivNumber: 'IV001', userId: userId },
                    { date: new Date('2024-07-02'), itemName: 'กระดาษ A4', unit: 'รีม', quantity: 10, type: 'receive', poNumber: 'PO002', ivNumber: 'IV002', userId: userId },
                    { date: new Date('2024-07-03'), itemName: 'ปากกาเจลสีน้ำเงิน', unit: 'ด้าม', quantity: -5, type: 'issue', ivNumber: 'IV003', userId: userId },
                    { date: new Date('2024-07-05'), itemName: 'แฟ้มเอกสาร', unit: 'อัน', quantity: 20, type: 'receive', poNumber: 'PO003', ivNumber: 'IV004', userId: userId },
                    { date: new Date('2024-07-06'), itemName: 'กระดาษ A4', unit: 'รีม', quantity: -2, type: 'issue', ivNumber: 'IV005', userId: userId },
                    { date: new Date('2024-07-08'), itemName: 'หมึกพิมพ์ HP 680', unit: 'ตลับ', quantity: 5, type: 'receive', poNumber: 'PO004', ivNumber: 'IV006', userId: userId },
                    { date: new Date('2024-07-10'), itemName: 'ปากกาเจลสีน้ำเงิน', unit: 'ด้าม', quantity: -10, type: 'issue', ivNumber: 'IV007', userId: userId },
                    { date: new Date('2024-07-12'), itemName: 'เทปกาวใส', unit: 'ม้วน', quantity: 30, type: 'receive', poNumber: 'PO005', ivNumber: 'IV008', userId: userId },
                    { date: new Date('2024-07-15'), itemName: 'แฟ้มเอกสาร', unit: 'อัน', quantity: -3, type: 'issue', ivNumber: 'IV009', userId: userId },
                    { date: new Date('2024-07-18'), itemName: 'หมึกพิมพ์ HP 680', unit: 'ตลับ', quantity: -1, type: 'issue', ivNumber: 'IV010', userId: userId },
                ];

                sampleTransactions.forEach(transaction => {
                    const transactionDocRef = doc(transactionsCollectionRef);
                    batch.set(transactionDocRef, transaction);
                });

                await batch.commit();
                setMessage('เพิ่มข้อมูลตัวอย่างเรียบร้อยแล้ว!');
                setMessageType('success');
            } else {
                setMessage('มีข้อมูลอยู่ในระบบแล้ว ไม่ได้เพิ่มข้อมูลตัวอย่าง.');
                setMessageType('info');
            }
        } catch (e) {
            console.error("Error adding sample data:", e);
            setMessage('เกิดข้อผิดพลาดในการเพิ่มข้อมูลตัวอย่าง: ' + e.message);
            setMessageType('error');
        } finally {
            setIsLoading(false);
        }
    };


    return (
        <div className="bg-white p-6 rounded-lg shadow-xl mb-8">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">เมนูสินค้าคงเหลือ</h2>
            {message && (
                <div className={`p-3 mb-4 rounded-md ${messageType === 'success' ? 'bg-green-100 text-green-700' : messageType === 'info' ? 'bg-blue-100 text-blue-700' : 'bg-red-100 text-red-700'}`}>
                    {message}
                </div>
            )}
            <div className="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                <button
                    onClick={addSampleData}
                    className="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled={isLoading}
                >
                    {isLoading ? 'กำลังเพิ่มข้อมูล...' : 'เพิ่มข้อมูลตัวอย่าง (ถ้าว่าง)'}
                </button>
                <div className="w-full sm:w-auto">
                    <input
                        type="text"
                        placeholder="ค้นหาสินค้า..."
                        value={searchTerm}
                        onChange={(e) => setSearchTerm(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    />
                </div>
            </div>

            {isLoading ? (
                <div className="text-center text-gray-600">กำลังโหลดข้อมูลสินค้าคงเหลือ...</div>
            ) : filteredStockItems.length === 0 ? (
                <p className="text-gray-600">ไม่พบข้อมูลสินค้าคงเหลือที่ตรงกับคำค้นหา.</p>
            ) : (
                <div className="overflow-x-auto rounded-lg shadow-md">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อสินค้า</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">หน่วยนับ</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนสินค้าคงเหลือ</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนขั้นต่ำ</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะการเติมสินค้า</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {filteredStockItems.map((item) => (
                                <tr key={item.name}>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item.name}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item.unit}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item.currentStock}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                        <input
                                            type="number"
                                            value={item.minStock}
                                            onChange={(e) => handleMinStockChange(item.id, e.target.value)}
                                            className="w-20 px-2 py-1 border border-gray-300 rounded-md text-sm"
                                            min="0"
                                        />
                                    </td>
                                    <td className={`px-6 py-4 whitespace-nowrap text-sm font-semibold ${item.status === 'ต้องเติม' ? 'text-red-600' : 'text-green-600'}`}>
                                        {item.status}
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}
        </div>
    );
}

// --- Stock Balance by IV Component ---
function StockBalanceByIV({ db, userId, publicDataPath, setCurrentPage, setReportSelectedItem }) {
    const [allTransactions, setAllTransactions] = useState([]); // Store all transactions
    const [transactionsByIV, setTransactionsByIV] = useState({}); // Grouped and filtered
    const [message, setMessage] = useState('');
    const [messageType, setMessageType] = useState('');
    const [isLoading, setIsLoading] = useState(true);
    const [searchTermIV, setSearchTermIV] = useState('');
    const [searchTermItemInIV, setSearchTermItemInIV] = useState('');
    const [startDate, setStartDate] = useState('');
    const [endDate, setEndDate] = useState('');
    const [expandedIVs, setExpandedIVs] = useState(new Set()); // To manage collapsible sections

    const transactionsCollectionRef = collection(db, `${publicDataPath}/transactions`);

    // Fetch all transactions
    useEffect(() => {
        if (!db || !userId) return;
        setIsLoading(true);

        const unsubscribe = onSnapshot(transactionsCollectionRef, (snapshot) => {
            const fetchedTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setAllTransactions(fetchedTransactions);
            setIsLoading(false);
        }, (error) => {
            console.error("Error fetching transactions:", error);
            setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลรายการ.");
            setMessageType('error');
            setIsLoading(false);
        });

        return () => unsubscribe();
    }, [db, userId, publicDataPath]);

    // Process and filter transactions whenever allTransactions or filters change
    useEffect(() => {
        const filteredAndGrouped = {};
        const sDate = startDate ? new Date(startDate) : null;
        const eDate = endDate ? new Date(endDate) : null;

        allTransactions.forEach(data => {
            const iv = data.ivNumber;
            if (!iv) return; // Skip if no IV number

            // Filter by IV number search term
            if (searchTermIV && !iv.toLowerCase().includes(searchTermIV.toLowerCase())) {
                return;
            }

            // Filter by date range
            const transactionDate = data.date.toDate();
            if (sDate && transactionDate < sDate) return;
            if (eDate && transactionDate > eDate) return;

            if (!filteredAndGrouped[iv]) {
                filteredAndGrouped[iv] = {
                    transactions: [],
                    totalReceived: 0,
                    totalIssued: 0,
                    uniqueItems: new Set(),
                    firstDate: new Date('2099-01-01'), // Initialize with a future date
                    lastDate: new Date('1900-01-01'),  // Initialize with a past date
                };
            }

            // Filter by item name within IV
            if (searchTermItemInIV && !data.itemName.toLowerCase().includes(searchTermItemInIV.toLowerCase())) {
                // Do not add to this IV's list if it doesn't match item search
                return;
            }

            filteredAndGrouped[iv].transactions.push(data);
            if (data.quantity > 0) {
                filteredAndGrouped[iv].totalReceived += data.quantity;
            } else {
                filteredAndGrouped[iv].totalIssued += Math.abs(data.quantity);
            }
            filteredAndGrouped[iv].uniqueItems.add(data.itemName);

            // Update first and last dates
            if (transactionDate < filteredAndGrouped[iv].firstDate) {
                filteredAndGrouped[iv].firstDate = transactionDate;
            }
            if (transactionDate > filteredAndGrouped[iv].lastDate) {
                filteredAndGrouped[iv].lastDate = transactionDate;
            }
        });

        // Sort IV numbers and transactions within each IV
        const sortedIVs = Object.keys(filteredAndGrouped).sort().reduce(
            (obj, key) => {
                // Sort transactions within each IV by date
                filteredAndGrouped[key].transactions.sort((a, b) => a.date.toDate() - b.date.toDate());
                obj[key] = filteredAndGrouped[key];
                return obj;
            },
            {}
        );

        setTransactionsByIV(sortedIVs);
    }, [allTransactions, searchTermIV, startDate, endDate, searchTermItemInIV]);

    const toggleExpand = (ivNumber) => {
        setExpandedIVs(prev => {
            const newSet = new Set(prev);
            if (newSet.has(ivNumber)) {
                newSet.delete(ivNumber);
            } else {
                newSet.add(ivNumber);
            }
            return newSet;
        });
    };

    const handleExportCSV = () => {
        let csvContent = "เลขที่ IV,วันที่,ชื่อสินค้า,หน่วยนับ,ประเภท,จำนวน,เลขที่ PO\n";

        Object.entries(transactionsByIV).forEach(([ivNumber, data]) => {
            csvContent += `"${ivNumber}","","","","","",""\n`; // IV header row
            data.transactions.forEach(transaction => {
                const dateFormatted = formatDate(transaction.date);
                const typeText = transaction.type === 'receive' ? 'รับเข้า' : 'จ่ายออก';
                const quantityAbs = Math.abs(transaction.quantity);
                const po = transaction.poNumber || '';
                csvContent += `"", "${dateFormatted}","${transaction.itemName}","${transaction.unit}","${typeText}",${quantityAbs},"${po}"\n`;
            });
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `รายงานสินค้าคงเหลือ_แยกIV_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    };

    const navigateToReport = (itemName) => {
        setReportSelectedItem(itemName);
        setCurrentPage('report');
    };


    return (
        <div className="bg-white p-6 rounded-lg shadow-xl mb-8">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">เมนูสินค้าคงเหลือ (แยกเลขที่ IV)</h2>
            {message && (
                <div className={`p-3 mb-4 rounded-md ${messageType === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                    {message}
                </div>
            )}

            {/* Filter Section */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 p-4 border border-gray-200 rounded-lg shadow-sm">
                <div>
                    <label htmlFor="searchIV" className="block text-sm font-medium text-gray-700">ค้นหาเลขที่ IV:</label>
                    <input
                        type="text"
                        id="searchIV"
                        value={searchTermIV}
                        onChange={(e) => setSearchTermIV(e.target.value)}
                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        placeholder="ค้นหาเลขที่ IV"
                    />
                </div>
                <div>
                    <label htmlFor="startDate" className="block text-sm font-medium text-gray-700">วันที่เริ่มต้น:</label>
                    <input
                        type="date"
                        id="startDate"
                        value={startDate}
                        onChange={(e) => setStartDate(e.target.value)}
                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    />
                </div>
                <div>
                    <label htmlFor="endDate" className="block text-sm font-medium text-gray-700">วันที่สิ้นสุด:</label>
                    <input
                        type="date"
                        id="endDate"
                        value={endDate}
                        onChange={(e) => setEndDate(e.target.value)}
                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    />
                </div>
                <div className="md:col-span-3 flex justify-end">
                    <button
                        onClick={handleExportCSV}
                        className="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled={isLoading || Object.keys(transactionsByIV).length === 0}
                    >
                        ส่งออกเป็น CSV
                    </button>
                </div>
            </div>

            {isLoading ? (
                <div className="text-center text-gray-600">กำลังโหลดรายการตามเลขที่ IV...</div>
            ) : Object.keys(transactionsByIV).length === 0 ? (
                <p className="text-gray-600">ไม่พบรายการเคลื่อนไหวสินค้าที่ระบุเลขที่ IV ที่ตรงกับเงื่อนไข.</p>
            ) : (
                <div className="space-y-6">
                    {Object.entries(transactionsByIV).map(([ivNumber, data]) => (
                        <div key={ivNumber} className="border border-gray-200 rounded-lg shadow-sm">
                            <div
                                className="bg-gray-50 p-4 cursor-pointer flex justify-between items-center rounded-t-lg"
                                onClick={() => toggleExpand(ivNumber)}
                            >
                                <h3 className="text-xl font-semibold text-gray-700">
                                    เลขที่ IV: {ivNumber}
                                </h3>
                                <span className="text-gray-600 text-sm">
                                    {expandedIVs.has(ivNumber) ? 'ซ่อนรายละเอียด ▲' : 'แสดงรายละเอียด ▼'}
                                </span>
                            </div>

                            {/* Summary Section */}
                            <div className="p-4 border-b border-gray-200 bg-white grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-2 text-sm text-gray-700">
                                <p><strong>รับเข้าทั้งหมด:</strong> {data.totalReceived} หน่วย</p>
                                <p><strong>จ่ายออกทั้งหมด:</strong> {data.totalIssued} หน่วย</p>
                                <p><strong>สินค้าไม่ซ้ำ:</strong> {data.uniqueItems.size} ชนิด</p>
                                <p><strong>ช่วงวันที่:</strong> {formatDate(data.firstDate)} - {formatDate(data.lastDate)}</p>
                            </div>

                            {expandedIVs.has(ivNumber) && (
                                <div className="p-4 bg-white">
                                    <div className="mb-4">
                                        <label htmlFor={`searchItemInIV-${ivNumber}`} className="block text-sm font-medium text-gray-700">ค้นหาสินค้าใน IV นี้:</label>
                                        <input
                                            type="text"
                                            id={`searchItemInIV-${ivNumber}`}
                                            value={searchTermItemInIV}
                                            onChange={(e) => setSearchTermItemInIV(e.target.value)}
                                            className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                            placeholder="ค้นหาชื่อสินค้า..."
                                        />
                                    </div>
                                    <div className="overflow-x-auto rounded-lg border border-gray-200">
                                        <table className="min-w-full divide-y divide-gray-200">
                                            <thead className="bg-gray-50">
                                                <tr>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อสินค้า</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">หน่วยนับ</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภท</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวน</th>
                                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เลขที่ PO</th>
                                                </tr>
                                            </thead>
                                            <tbody className="bg-white divide-y divide-gray-200">
                                                {data.transactions.length === 0 ? (
                                                    <tr>
                                                        <td colSpan="6" className="px-6 py-4 text-center text-sm text-gray-500">ไม่พบรายการสินค้าที่ตรงกับคำค้นหาใน IV นี้.</td>
                                                    </tr>
                                                ) : (
                                                    data.transactions.map((transaction, index) => (
                                                        <tr key={index}>
                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{formatDate(transaction.date)}</td>
                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-blue-600 hover:underline cursor-pointer" onClick={() => navigateToReport(transaction.itemName)}>
                                                                {transaction.itemName}
                                                            </td>
                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{transaction.unit}</td>
                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                                    transaction.type === 'receive' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                                                }`}>
                                                                    {transaction.type === 'receive' ? 'รับเข้า' : 'จ่ายออก'}
                                                                </span>
                                                            </td>
                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{Math.abs(transaction.quantity)}</td>
                                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{transaction.poNumber || '-'}</td>
                                                        </tr>
                                                    ))
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

// --- Item Movement Report Component ---
function ItemMovementReport({ db, userId, publicDataPath, initialSelectedItem, setInitialSelectedItem }) {
    const [selectedItem, setSelectedItem] = useState(initialSelectedItem || '');
    const [items, setItems] = useState([]);
    const [itemMovements, setItemMovements] = useState([]);
    const [message, setMessage] = useState('');
    const [messageType, setMessageType] = useState('');
    const [isLoading, setIsLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');

    const itemsCollectionRef = collection(db, `${publicDataPath}/items`);
    const transactionsCollectionRef = collection(db, `${publicDataPath}/transactions`);

    // Set initial selected item when component mounts or initialSelectedItem changes
    useEffect(() => {
        if (initialSelectedItem) {
            setSelectedItem(initialSelectedItem);
            setInitialSelectedItem(''); // Clear it after setting to avoid re-triggering
        }
    }, [initialSelectedItem, setInitialSelectedItem]);

    // Fetch all item names for the dropdown
    useEffect(() => {
        if (!db || !userId) return;
        setIsLoading(true);

        const unsubscribe = onSnapshot(itemsCollectionRef, (snapshot) => {
            const itemsData = snapshot.docs.map(doc => doc.data().name);
            setItems(itemsData);
            setIsLoading(false);
        }, (error) => {
            console.error("Error fetching item names:", error);
            setMessage("เกิดข้อผิดพลาดในการดึงชื่อสินค้า.");
            setMessageType('error');
            setIsLoading(false);
        });

        return () => unsubscribe();
    }, [db, userId, publicDataPath]);

    // Fetch movements for selected item and calculate running balance
    useEffect(() => {
        if (!db || !userId || !selectedItem) {
            setItemMovements([]);
            return;
        }
        setIsLoading(true);

        const q = query(
            transactionsCollectionRef,
            where('itemName', '==', selectedItem)
        );

        const unsubscribe = onSnapshot(q, (snapshot) => {
            let currentBalance = 0;
            const movements = snapshot.docs
                .map(doc => ({ id: doc.id, ...doc.data() }))
                .sort((a, b) => a.date.toDate() - b.date.toDate()) // Ensure sorted by date for correct running balance
                .map(movement => {
                    currentBalance += movement.quantity;
                    return { ...movement, runningBalance: currentBalance };
                });
            setItemMovements(movements);
            setIsLoading(false);
        }, (error) => {
            console.error("Error fetching item movements:", error);
            setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลการเคลื่อนไหวสินค้า.");
            setMessageType('error');
            setIsLoading(false);
        });

        return () => unsubscribe();
    }, [db, userId, selectedItem, publicDataPath]);

    // Filtered movements based on search term
    const filteredMovements = itemMovements.filter(movement =>
        movement.itemName.toLowerCase().includes(searchTerm.toLowerCase()) ||
        movement.unit.toLowerCase().includes(searchTerm.toLowerCase()) ||
        movement.type.toLowerCase().includes(searchTerm.toLowerCase()) ||
        (movement.poNumber && movement.poNumber.toLowerCase().includes(searchTerm.toLowerCase())) ||
        (movement.ivNumber && movement.ivNumber.toLowerCase().includes(searchTerm.toLowerCase())) ||
        formatDate(movement.date).toLowerCase().includes(searchTerm.toLowerCase()) ||
        movement.runningBalance.toString().includes(searchTerm.toLowerCase()) // Allow search by running balance
    );

    return (
        <div className="bg-white p-6 rounded-lg shadow-xl mb-8">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">รายงานเคลื่อนไหวสินค้ารายตัว</h2>
            {message && (
                <div className={`p-3 mb-4 rounded-md ${messageType === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                    {message}
                </div>
            )}
            <div className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                <div className="w-full sm:w-1/2">
                    <label htmlFor="selectItem" className="block text-sm font-medium text-gray-700 mb-2">เลือกสินค้า:</label>
                    <select
                        id="selectItem"
                        value={selectedItem}
                        onChange={(e) => setSelectedItem(e.target.value)}
                        className="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    >
                        <option value="">-- เลือกสินค้า --</option>
                        {items.map((name, index) => (
                            <option key={index} value={name}>{name}</option>
                        ))}
                    </select>
                </div>
                {selectedItem && (
                    <div className="w-full sm:w-1/2">
                        <label htmlFor="searchMovement" className="block text-sm font-medium text-gray-700 mb-2">ค้นหาในรายการเคลื่อนไหว:</label>
                        <input
                            type="text"
                            id="searchMovement"
                            placeholder="ค้นหาด้วยชื่อ, หน่วยนับ, เลขที่ IV/PO, ยอดคงเหลือ..."
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        />
                    </div>
                )}
            </div>

            {selectedItem && (
                <>
                    <h3 className="text-xl font-bold text-gray-800 mt-8 mb-4">
                        รายงานการเคลื่อนไหวของ: {selectedItem}
                    </h3>
                    {isLoading ? (
                        <div className="text-center text-gray-600">กำลังโหลดรายการเคลื่อนไหว...</div>
                    ) : filteredMovements.length === 0 ? (
                        <p className="text-gray-600">ไม่พบการเคลื่อนไหวสำหรับสินค้านี้ที่ตรงกับคำค้นหา.</p>
                    ) : (
                        <div className="overflow-x-auto rounded-lg shadow-md">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภท</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวน</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">หน่วยนับ</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เลขที่ PO</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">เลขที่ IV</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ยอดคงเหลือ</th> {/* New Column */}
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredMovements.map((movement) => (
                                        <tr key={movement.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{formatDate(movement.date)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                    movement.type === 'receive' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                                }`}>
                                                    {movement.type === 'receive' ? 'รับเข้า' : 'จ่ายออก'}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{Math.abs(movement.quantity)}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{movement.unit}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{movement.poNumber || '-'}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{movement.ivNumber}</td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">{movement.runningBalance}</td> {/* Display running balance */}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </>
            )}
        </div>
    );
}

// --- Item Master Component ---
function ItemMaster({ db, userId, publicDataPath }) {
    const [items, setItems] = useState([]);
    const [itemName, setItemName] = useState('');
    const [unit, setUnit] = useState('');
    const [minStock, setMinStock] = useState('');
    const [message, setMessage] = useState('');
    const [messageType, setMessageType] = useState('');
    const [editingItem, setEditingItem] = useState(null); // Stores item being edited
    const [isLoading, setIsLoading] = useState(false);

    // Confirmation Modal states
    const [showConfirmModal, setShowConfirmModal] = useState(false);
    const [itemToDelete, setItemToDelete] = useState(null);

    // Validation states
    const [itemNameError, setItemNameError] = useState('');
    const [unitError, setUnitError] = useState('');
    const [minStockError, setMinStockError] = useState('');

    const itemsCollectionRef = collection(db, `${publicDataPath}/items`);
    const transactionsCollectionRef = collection(db, `${publicDataPath}/transactions`);

    // Fetch items from Firestore
    useEffect(() => {
        if (!db || !userId) return;
        setIsLoading(true);

        const unsubscribe = onSnapshot(itemsCollectionRef, (snapshot) => {
            const itemsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            setItems(itemsData.sort((a, b) => a.name.localeCompare(b.name))); // Sort by name
            setIsLoading(false);
        }, (error) => {
            console.error("Error fetching items:", error);
            setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลสินค้า.");
            setMessageType('error');
            setIsLoading(false);
        });

        return () => unsubscribe();
    }, [db, userId, publicDataPath]);

    const validateForm = () => {
        let isValid = true;
        if (!itemName) {
            setItemNameError('กรุณากรอกชื่อสินค้า');
            isValid = false;
        } else {
            setItemNameError('');
        }
        if (!unit) {
            setUnitError('กรุณากรอกหน่วยนับ');
            isValid = false;
        } else {
            setUnitError('');
        }
        if (isNaN(minStock) || parseFloat(minStock) < 0) {
            setMinStockError('จำนวนขั้นต่ำต้องเป็นตัวเลขและไม่ติดลบ');
            isValid = false;
        } else {
            setMinStockError('');
        }
        return isValid;
    };

    const handleAddItem = async (e) => {
        e.preventDefault();
        setMessage('');
        setMessageType('');

        if (!validateForm()) {
            return;
        }

        setIsLoading(true);
        try {
            // Check if item name already exists
            const existingItemQuery = query(itemsCollectionRef, where('name', '==', itemName));
            const existingItemSnapshot = await getDocs(existingItemQuery);

            if (!existingItemSnapshot.empty) {
                setMessage(`ชื่อสินค้า "${itemName}" มีอยู่ในระบบแล้ว.`);
                setMessageType('error');
                setIsLoading(false);
                return;
            }

            await addDoc(itemsCollectionRef, {
                name: itemName,
                unit: unit,
                minStock: parseFloat(minStock),
            });
            setMessage('เพิ่มสินค้าใหม่เรียบร้อยแล้ว!');
            setMessageType('success');
            setItemName('');
            setUnit('');
            setMinStock('');
            // Clear validation errors
            setItemNameError('');
            setUnitError('');
            setMinStockError('');
        } catch (e) {
            console.error("Error adding item:", e);
            setMessage('เกิดข้อผิดพลาดในการเพิ่มสินค้า: ' + e.message);
            setMessageType('error');
        } finally {
            setIsLoading(false);
        }
    };

    const handleUpdateItem = async (e) => {
        e.preventDefault();
        setMessage('');
        setMessageType('');

        if (!editingItem) return; // Should not happen if editingItem is set
        // Re-validate only unit and minStock as itemName is readOnly
        let isValid = true;
        if (!unit) {
            setUnitError('กรุณากรอกหน่วยนับ');
            isValid = false;
        } else {
            setUnitError('');
        }
        if (isNaN(minStock) || parseFloat(minStock) < 0) {
            setMinStockError('จำนวนขั้นต่ำต้องเป็นตัวเลขและไม่ติดลบ');
            isValid = false;
        } else {
            setMinStockError('');
        }
        if (!isValid) return;


        setIsLoading(true);
        try {
            const itemDocRef = doc(db, `${publicDataPath}/items`, editingItem.id);
            await updateDoc(itemDocRef, {
                unit: unit,
                minStock: parseFloat(minStock),
            });
            setMessage('อัปเดตข้อมูลสินค้าเรียบร้อยแล้ว!');
            setMessageType('success');
            setEditingItem(null);
            setItemName('');
            setUnit('');
            setMinStock('');
            // Clear validation errors
            setItemNameError('');
            setUnitError('');
            setMinStockError('');
        } catch (e) {
            console.error("Error updating item:", e);
            setMessage('เกิดข้อผิดพลาดในการอัปเดตสินค้า: ' + e.message);
            setMessageType('error');
        } finally {
            setIsLoading(false);
        }
    };

    const confirmDeleteItem = (item) => {
        setItemToDelete(item);
        setShowConfirmModal(true);
    };

    const handleActualDelete = async () => {
        if (!itemToDelete) return;

        setMessage('');
        setMessageType('');
        setIsLoading(true);
        setShowConfirmModal(false); // Close the modal immediately

        try {
            // Before deleting item, check if there are any transactions associated with it
            const transactionsQuery = query(transactionsCollectionRef, where('itemName', '==', itemToDelete.name));
            const transactionsSnapshot = await getDocs(transactionsQuery);

            if (!transactionsSnapshot.empty) {
                setMessage(`ไม่สามารถลบสินค้า "${itemToDelete.name}" ได้ เนื่องจากมีรายการเคลื่อนไหวสินค้าที่เกี่ยวข้อง. กรุณาลบรายการเคลื่อนไหวสินค้านั้นก่อน.`);
                setMessageType('error');
                return;
            }

            const itemDocRef = doc(db, `${publicDataPath}/items`, itemToDelete.id);
            await deleteDoc(itemDocRef);
            setMessage('ลบสินค้าเรียบร้อยแล้ว!');
            setMessageType('success');
        } catch (e) {
            console.error("Error deleting item:", e);
            setMessage('เกิดข้อผิดพลาดในการลบสินค้า: ' + e.message);
            setMessageType('error');
        } finally {
            setIsLoading(false);
            setItemToDelete(null);
        }
    };

    const cancelDelete = () => {
        setShowConfirmModal(false);
        setItemToDelete(null);
    };

    const startEditing = (item) => {
        setEditingItem(item);
        setItemName(item.name);
        setUnit(item.unit);
        setMinStock(item.minStock);
        // Clear previous validation errors when starting edit
        setItemNameError('');
        setUnitError('');
        setMinStockError('');
    };

    const cancelEditing = () => {
        setEditingItem(null);
        setItemName('');
        setUnit('');
        setMinStock('');
        setMessage('');
        setMessageType('');
        // Clear validation errors
        setItemNameError('');
        setUnitError('');
        setMinStockError('');
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-xl mb-8">
            <h2 className="text-2xl font-bold text-gray-800 mb-6">เมนูสินค้า</h2>
            {message && (
                <div className={`p-3 mb-4 rounded-md ${messageType === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                    {message}
                </div>
            )}

            {/* Form for Add/Edit Item */}
            <form onSubmit={editingItem ? handleUpdateItem : handleAddItem} className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 p-4 border border-gray-200 rounded-lg shadow-sm">
                <h3 className="md:col-span-2 text-xl font-semibold text-gray-700 mb-4">
                    {editingItem ? 'แก้ไขข้อมูลสินค้า' : 'เพิ่มสินค้าใหม่'}
                </h3>
                <div>
                    <label htmlFor="itemNameMaster" className="block text-sm font-medium text-gray-700">ชื่อสินค้า:</label>
                    <input
                        type="text"
                        id="itemNameMaster"
                        value={itemName}
                        onChange={(e) => { setItemName(e.target.value); setItemNameError(''); }}
                        className={`mt-1 block w-full px-3 py-2 border ${itemNameError ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                        placeholder="ชื่อสินค้า"
                        required
                        readOnly={!!editingItem} // Make item name read-only when editing
                    />
                    {editingItem && <p className="text-xs text-gray-500 mt-1">ไม่สามารถแก้ไขชื่อสินค้าได้เมื่ออยู่ในโหมดแก้ไข</p>}
                    {itemNameError && <p className="text-red-500 text-xs mt-1">{itemNameError}</p>}
                </div>
                <div>
                    <label htmlFor="unitMaster" className="block text-sm font-medium text-gray-700">หน่วยนับ:</label>
                    <input
                        type="text"
                        id="unitMaster"
                        value={unit}
                        onChange={(e) => { setUnit(e.target.value); setUnitError(''); }}
                        className={`mt-1 block w-full px-3 py-2 border ${unitError ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                        placeholder="เช่น ชิ้น, กล่อง"
                        required
                    />
                    {unitError && <p className="text-red-500 text-xs mt-1">{unitError}</p>}
                </div>
                <div>
                    <label htmlFor="minStockMaster" className="block text-sm font-medium text-gray-700">จำนวนขั้นต่ำ:</label>
                    <input
                        type="number"
                        id="minStockMaster"
                        value={minStock}
                        onChange={(e) => { setMinStock(e.target.value); setMinStockError(''); }}
                        className={`mt-1 block w-full px-3 py-2 border ${minStockError ? 'border-red-500' : 'border-gray-300'} rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm`}
                        min="0"
                        required
                    />
                    {minStockError && <p className="text-red-500 text-xs mt-1">{minStockError}</p>}
                </div>
                <div className="md:col-span-2 flex justify-end gap-2 items-center">
                    <button
                        type="submit"
                        className="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                        disabled={isLoading}
                    >
                        {isLoading ? (editingItem ? 'กำลังบันทึก...' : 'กำลังเพิ่ม...') : (editingItem ? 'บันทึกการแก้ไข' : 'เพิ่มสินค้า')}
                    </button>
                    {editingItem && (
                        <button
                            type="button"
                            onClick={cancelEditing}
                            className="px-6 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled={isLoading}
                        >
                            ยกเลิก
                        </button>
                    )}
                </div>
            </form>

            {/* Item List Table */}
            <h3 className="text-xl font-bold text-gray-800 mt-8 mb-4">รายการสินค้าทั้งหมด</h3>
            {isLoading ? (
                <div className="text-center text-gray-600">กำลังโหลดรายการสินค้า...</div>
            ) : items.length === 0 ? (
                <p className="text-gray-600">ยังไม่มีสินค้าในระบบ. ลองเพิ่มสินค้าใหม่.</p>
            ) : (
                <div className="overflow-x-auto rounded-lg shadow-md">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อสินค้า</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">หน่วยนับ</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนขั้นต่ำ</th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การดำเนินการ</th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {items.map((item) => (
                                <tr key={item.id}>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item.name}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item.unit}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{item.minStock}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm">
                                        <button
                                            onClick={() => startEditing(item)}
                                            className="text-blue-600 hover:text-blue-900 mr-4 disabled:opacity-50 disabled:cursor-not-allowed"
                                            disabled={isLoading}
                                        >
                                            แก้ไข
                                        </button>
                                        <button
                                            onClick={() => confirmDeleteItem(item)}
                                            className="text-red-600 hover:text-red-900 disabled:opacity-50 disabled:cursor-not-allowed"
                                            disabled={isLoading}
                                        >
                                            ลบ
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            )}

            {/* Confirmation Modal */}
            <ConfirmationModal
                isOpen={showConfirmModal}
                title="ยืนยันการลบสินค้า"
                message={`คุณแน่ใจหรือไม่ที่จะลบสินค้า "${itemToDelete?.name}"? การดำเนินการนี้ไม่สามารถย้อนกลับได้.`}
                onConfirm={handleActualDelete}
                onCancel={cancelDelete}
            />
        </div>
    );
}

export default App;
