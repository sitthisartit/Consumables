<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจัดการคลังสินค้า</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .hover-scale { transition: transform 0.2s; }
        .hover-scale:hover { transform: scale(1.02); }
        .sticker { 
            width: 200px; 
            height: 150px; 
            border: 2px solid #333; 
            padding: 10px; 
            margin: 10px; 
            display: inline-block; 
            background: white;
            page-break-inside: avoid;
        }
        .scanner-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 300px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9f9f9;
        }
        
        /* Enhanced Toast Animations */
        .toast {
            animation: slideInRight 0.3s ease-out;
        }
        .toast.removing {
            animation: slideOutRight 0.3s ease-in;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Card View for Mobile Tables */
        .mobile-card {
            display: none;
        }
        
        @media (max-width: 768px) {
            .desktop-table {
                display: none;
            }
            .mobile-card {
                display: block;
            }
        }
        
        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        @media print {
            .no-print { display: none !important; }
            .sticker { margin: 5px; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-warehouse text-3xl"></i>
                    <h1 class="text-2xl font-bold">ระบบจัดการคลังสินค้า</h1>
                </div>
                <div class="text-sm opacity-90">
                    <i class="fas fa-clock mr-2"></i>
                    <span id="currentTime"></span>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow-md sticky top-0 z-40">
        <div class="container mx-auto px-2 sm:px-4">
            <!-- Mobile Menu Button -->
            <div class="flex justify-between items-center md:hidden py-3">
                <h2 id="currentTabTitle" class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-box mr-2 text-blue-600"></i>ข้อมูลสินค้า
                </h2>
                <button onclick="toggleMobileMenu()" id="mobileMenuBtn" class="p-2 rounded-lg hover:bg-gray-100 transition-colors">
                    <i class="fas fa-bars text-xl text-gray-600"></i>
                </button>
            </div>
            
            <!-- Desktop Navigation -->
            <div class="hidden md:flex space-x-2 lg:space-x-4 overflow-x-auto">
                <button onclick="showTab('itemMaster')" id="tab-itemMaster" class="tab-btn py-3 lg:py-4 px-3 lg:px-6 border-b-2 border-transparent hover:border-blue-500 transition-colors font-medium text-gray-700 hover:text-blue-600 whitespace-nowrap text-sm lg:text-base">
                    <i class="fas fa-box mr-1 lg:mr-2"></i>
                    <span class="hidden lg:inline">ข้อมูลสินค้า</span>
                    <span class="lg:hidden">สินค้า</span>
                </button>
                <button onclick="showTab('qrSticker')" id="tab-qrSticker" class="tab-btn py-3 lg:py-4 px-3 lg:px-6 border-b-2 border-transparent hover:border-blue-500 transition-colors font-medium text-gray-700 hover:text-blue-600 whitespace-nowrap text-sm lg:text-base">
                    <i class="fas fa-qrcode mr-1 lg:mr-2"></i>
                    <span class="hidden lg:inline">สร้างสติกเกอร์</span>
                    <span class="lg:hidden">QR</span>
                </button>
                <button onclick="showTab('receive')" id="tab-receive" class="tab-btn py-3 lg:py-4 px-3 lg:px-6 border-b-2 border-transparent hover:border-blue-500 transition-colors font-medium text-gray-700 hover:text-blue-600 whitespace-nowrap text-sm lg:text-base">
                    <i class="fas fa-arrow-down mr-1 lg:mr-2"></i>
                    <span class="hidden lg:inline">รับเข้าสินค้า</span>
                    <span class="lg:hidden">รับเข้า</span>
                </button>
                <button onclick="showTab('issue')" id="tab-issue" class="tab-btn py-3 lg:py-4 px-3 lg:px-6 border-b-2 border-transparent hover:border-blue-500 transition-colors font-medium text-gray-700 hover:text-blue-600 whitespace-nowrap text-sm lg:text-base">
                    <i class="fas fa-arrow-up mr-1 lg:mr-2"></i>
                    <span class="hidden lg:inline">จ่ายออกสินค้า</span>
                    <span class="lg:hidden">จ่ายออก</span>
                </button>
                <button onclick="showTab('dashboard')" id="tab-dashboard" class="tab-btn py-3 lg:py-4 px-3 lg:px-6 border-b-2 border-transparent hover:border-blue-500 transition-colors font-medium text-gray-700 hover:text-blue-600 whitespace-nowrap text-sm lg:text-base">
                    <i class="fas fa-chart-bar mr-1 lg:mr-2"></i>
                    <span class="hidden lg:inline">แดชบอร์ด</span>
                    <span class="lg:hidden">รายงาน</span>
                </button>
            </div>
            
            <!-- Mobile Navigation Menu -->
            <div id="mobileMenu" class="md:hidden hidden bg-white border-t border-gray-200 py-2">
                <div class="grid grid-cols-2 gap-2 px-2">
                    <button onclick="showTab('itemMaster'); closeMobileMenu();" class="mobile-tab-btn flex flex-col items-center py-3 px-2 rounded-lg hover:bg-blue-50 transition-colors text-gray-700 hover:text-blue-600">
                        <i class="fas fa-box text-xl mb-1"></i>
                        <span class="text-xs font-medium">ข้อมูลสินค้า</span>
                    </button>
                    <button onclick="showTab('qrSticker'); closeMobileMenu();" class="mobile-tab-btn flex flex-col items-center py-3 px-2 rounded-lg hover:bg-blue-50 transition-colors text-gray-700 hover:text-blue-600">
                        <i class="fas fa-qrcode text-xl mb-1"></i>
                        <span class="text-xs font-medium">สร้างสติกเกอร์</span>
                    </button>
                    <button onclick="showTab('receive'); closeMobileMenu();" class="mobile-tab-btn flex flex-col items-center py-3 px-2 rounded-lg hover:bg-blue-50 transition-colors text-gray-700 hover:text-blue-600">
                        <i class="fas fa-arrow-down text-xl mb-1"></i>
                        <span class="text-xs font-medium">รับเข้าสินค้า</span>
                    </button>
                    <button onclick="showTab('issue'); closeMobileMenu();" class="mobile-tab-btn flex flex-col items-center py-3 px-2 rounded-lg hover:bg-blue-50 transition-colors text-gray-700 hover:text-blue-600">
                        <i class="fas fa-arrow-up text-xl mb-1"></i>
                        <span class="text-xs font-medium">จ่ายออกสินค้า</span>
                    </button>
                </div>
                <div class="px-2 mt-2">
                    <button onclick="showTab('dashboard'); closeMobileMenu();" class="mobile-tab-btn w-full flex items-center justify-center py-3 px-2 rounded-lg hover:bg-blue-50 transition-colors text-gray-700 hover:text-blue-600">
                        <i class="fas fa-chart-bar text-xl mr-2"></i>
                        <span class="text-sm font-medium">แดชบอร์ดและรายงาน</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50"></div>

    <!-- Main Content -->
    <main class="container mx-auto px-2 sm:px-4 py-4 sm:py-8">
        <!-- Item Master Tab -->
        <div id="itemMaster" class="tab-content">
            <div class="bg-white rounded-lg card-shadow p-3 sm:p-6 mb-4 sm:mb-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-4 sm:mb-6">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 lg:mb-0">
                        <i class="fas fa-box text-blue-600 mr-2 sm:mr-3"></i>ข้อมูลสินค้า
                    </h2>
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                        <button onclick="showAddForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 sm:px-6 py-2 rounded-lg transition-colors hover-scale text-sm sm:text-base">
                            <i class="fas fa-plus mr-1 sm:mr-2"></i>เพิ่มสินค้าใหม่
                        </button>
                        <button onclick="exportData()" id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 sm:px-6 py-2 rounded-lg transition-colors hover-scale text-sm sm:text-base flex items-center">
                            <div id="exportSpinner" class="spinner mr-2 hidden"></div>
                            <i id="exportIcon" class="fas fa-download mr-1 sm:mr-2"></i>Export Excel
                        </button>
                        <input type="file" id="importFile" accept=".xlsx,.xls" onchange="importData()" class="hidden">
                        <button onclick="document.getElementById('importFile').click()" id="importBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 sm:px-6 py-2 rounded-lg transition-colors hover-scale text-sm sm:text-base flex items-center">
                            <div id="importSpinner" class="spinner mr-2 hidden"></div>
                            <i id="importIcon" class="fas fa-upload mr-1 sm:mr-2"></i>Import
                        </button>
                    </div>
                </div>

                <!-- Search -->
                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="ค้นหาด้วย Job No., รหัสสินค้า, หรือชื่อลูกค้า..." 
                               class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               oninput="searchItems()">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <!-- Desktop Table -->
                <div class="desktop-table overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job No.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รหัสสินค้า</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อสินค้า</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ลูกค้า</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนผลิต</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="itemsTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Items will be populated here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Mobile Card View -->
                <div id="itemsCardContainer" class="mobile-card space-y-4">
                    <!-- Mobile cards will be populated here -->
                </div>
            </div>
        </div>

        <!-- QR Sticker Tab -->
        <div id="qrSticker" class="tab-content hidden">
            <div class="bg-white rounded-lg card-shadow p-3 sm:p-6 mb-4 sm:mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6">
                    <i class="fas fa-qrcode text-blue-600 mr-2 sm:mr-3"></i>สร้างสติกเกอร์ QR Code
                </h2>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Job Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">เลือก Job No.</label>
                        <select id="jobSelect" onchange="loadJobData()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">-- เลือก Job No. --</option>
                        </select>
                    </div>

                    <!-- Bag Quantity -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">จำนวนถุง</label>
                        <input type="number" id="bagQuantity" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="กรอกจำนวนถุง">
                    </div>
                </div>

                <!-- Job Details -->
                <div id="jobDetails" class="mt-6 p-4 bg-gray-50 rounded-lg hidden">
                    <h3 class="font-semibold text-gray-800 mb-3">รายละเอียดงาน</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-sm">
                        <div><span class="font-medium">วันที่:</span> <span id="detail-date"></span></div>
                        <div><span class="font-medium">MC:</span> <span id="detail-mc"></span></div>
                        <div><span class="font-medium">กำหนดส่ง:</span> <span id="detail-delivery"></span></div>
                        <div><span class="font-medium">OE:</span> <span id="detail-oe"></span></div>
                        <div><span class="font-medium">รหัสสินค้า:</span> <span id="detail-productCode"></span></div>
                        <div><span class="font-medium">ชื่อสินค้า:</span> <span id="detail-productName"></span></div>
                        <div><span class="font-medium">ขนาด:</span> <span id="detail-size"></span></div>
                        <div><span class="font-medium">สี:</span> <span id="detail-color"></span></div>
                        <div><span class="font-medium">ลูกค้า:</span> <span id="detail-customer"></span></div>
                        <div><span class="font-medium">จำนวนผลิต:</span> <span id="detail-quantity"></span></div>
                        <div><span class="font-medium">บรรจุ/ถุง:</span> <span id="detail-packPerBag"></span></div>
                        <div><span class="font-medium">จำนวนถุง:</span> <span id="detail-bagCount"></span></div>
                        <div><span class="font-medium">เศษ:</span> <span id="detail-remainder"></span></div>
                    </div>
                </div>

                <!-- Generate Button -->
                <div class="mt-6">
                    <button onclick="generateStickers()" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg transition-colors hover-scale font-medium">
                        <i class="fas fa-magic mr-2"></i>สร้างสติกเกอร์
                    </button>
                </div>

                <!-- Stickers Preview -->
                <div id="stickersPreview" class="mt-8 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">ตัวอย่างสติกเกอร์</h3>
                        <div class="space-x-3">
                            <button onclick="printStickers()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-print mr-2"></i>พิมพ์
                            </button>
                            <button onclick="exportPDF()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                                <i class="fas fa-file-pdf mr-2"></i>Export PDF
                            </button>
                        </div>
                    </div>
                    <div id="stickersContainer" class="border rounded-lg p-4 bg-gray-50">
                        <!-- Stickers will be generated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Receive Tab -->
        <div id="receive" class="tab-content hidden">
            <div class="bg-white rounded-lg card-shadow p-3 sm:p-6 mb-4 sm:mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6">
                    <i class="fas fa-arrow-down text-green-600 mr-2 sm:mr-3"></i>รับเข้าสินค้า
                </h2>

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <!-- QR Scanner & Job Selection -->
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">สแกน QR Code หรือเลือก Job No.</label>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <input type="text" id="qrInput" placeholder="สแกน QR Code หรือพิมพ์ Job No." 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       oninput="searchJobByQR()">
                                <button onclick="openAndStartQRScanner()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors whitespace-nowrap">
                                    <i class="fas fa-qrcode mr-2"></i>สแกน QR
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">หรือเลือกจากรายการ</label>
                            <select id="receiveJobSelect" onchange="loadReceiveJobData()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">-- เลือก Job No. --</option>
                            </select>
                        </div>

                        <!-- QR Scanner Modal -->
                        <div id="qrScannerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold">สแกน QR Code</h3>
                                    <button onclick="closeQRScanner()" class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="scanner-container mx-auto mb-4 relative">
                                    <video id="qrVideo" class="w-full h-64 object-cover rounded-lg hidden"></video>
                                    <canvas id="qrCanvas" class="hidden"></canvas>
                                    <div id="scannerPlaceholder" class="text-center text-gray-500 flex flex-col items-center justify-center h-64">
                                        <i class="fas fa-qrcode text-4xl mb-2"></i>
                                        <p>กดปุ่มเริ่มสแกนเพื่อเปิดกล้อง</p>
                                    </div>
                                    <div id="scannerOverlay" class="absolute inset-0 hidden">
                                        <div class="absolute inset-4 border-2 border-blue-500 rounded-lg opacity-50"></div>
                                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-32 h-32 border-4 border-green-500 rounded-lg animate-pulse shadow-lg"></div>
                                        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-70 text-white px-3 py-1 rounded-full text-sm">
                                            วาง QR Code ในกรอบสีเขียว
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-center space-x-3">
                                    <button id="startScanBtn" onclick="startCameraScanning()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors hidden">
                                        <i class="fas fa-camera mr-2"></i>เริ่มสแกน
                                    </button>
                                    <button id="stopScanBtn" onclick="stopCameraScanning()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors hidden">
                                        <i class="fas fa-stop mr-2"></i>หยุดสแกน
                                    </button>
                                </div>
                                
                                <!-- Manual QR Input Fallback -->
                                <div id="qrFallbackSection" class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg hidden">
                                    <div class="text-center mb-3">
                                        <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                        <span class="text-yellow-800 font-medium">ไม่สามารถใช้กล้องได้</span>
                                    </div>
                                    <div class="text-sm text-yellow-700 mb-3 text-center">
                                        กรุณากรอก QR Code หรือ Job No. ด้วยตนเอง
                                    </div>
                                    <div class="flex gap-2">
                                        <input type="text" id="manualQrInput" placeholder="พิมพ์ QR Code หรือ Job No." 
                                               class="flex-1 px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                               onkeypress="if(event.key==='Enter') submitManualQR()">
                                        <button onclick="submitManualQR()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition-colors whitespace-nowrap">
                                            <i class="fas fa-check mr-2"></i>ตกลง
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="scanResult" class="mt-4 p-3 bg-green-100 text-green-800 rounded-lg hidden">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span id="scanResultText"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Job Details & Receive Form -->
                    <div>
                        <div id="receiveJobDetails" class="p-4 bg-gray-50 rounded-lg mb-6 hidden">
                            <h3 class="font-semibold text-gray-800 mb-3">รายละเอียดงาน</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                                <div><span class="font-medium">MC:</span> <span id="receive-mc"></span></div>
                                <div><span class="font-medium">OE:</span> <span id="receive-oe"></span></div>
                                <div><span class="font-medium">รหัสสินค้า:</span> <span id="receive-productCode"></span></div>
                                <div><span class="font-medium">ชื่อสินค้า:</span> <span id="receive-productName"></span></div>
                                <div><span class="font-medium">ขนาด:</span> <span id="receive-size"></span></div>
                                <div><span class="font-medium">สี:</span> <span id="receive-color"></span></div>
                                <div><span class="font-medium">ลูกค้า:</span> <span id="receive-customerName"></span></div>
                                <div><span class="font-medium">รหัสฝา:</span> <span id="receive-lidCode"></span></div>
                                <div><span class="font-medium">จำนวนผลิต:</span> <span id="receive-quantity"></span></div>
                                <div><span class="font-medium">บรรจุ/ถุง:</span> <span id="receive-packPerBag"></span></div>
                                <div><span class="font-medium">จำนวนถุง:</span> <span id="receive-bagCount"></span></div>
                                <div><span class="font-medium">เศษ:</span> <span id="receive-remainder"></span></div>
                            </div>
                            
                            <!-- Storage Progress -->
                            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <h4 class="font-semibold text-blue-800 mb-2">
                                    <i class="fas fa-chart-pie mr-2"></i>สถานะการเก็บ
                                </h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                    <div class="text-center">
                                        <div class="text-lg font-bold text-green-600" id="receive-storedBags">0</div>
                                        <div class="text-gray-600">เก็บแล้ว (ถุง)</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-bold text-orange-600" id="receive-remainingBags">0</div>
                                        <div class="text-gray-600">ต้องเก็บเพิ่ม (ถุง)</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-bold text-blue-600" id="receive-progressPercent">0%</div>
                                        <div class="text-gray-600">ความคืบหน้า</div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <div class="w-full bg-gray-200 rounded-full h-2">
                                        <div id="receive-progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <form id="receiveForm" onsubmit="saveReceive(event)" class="space-y-4">
                            <input type="hidden" id="selectedJobIndex" value="">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">วันที่รับเข้า *</label>
                                    <input type="date" name="receiveDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">เลือกโซนจัดเก็บ *</label>
                                    <input type="hidden" name="storageArea" required>
                                    
                                    <!-- Main Zone Selection -->
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
                                        <button type="button" onclick="selectMainZone('A')" id="main-zone-A" class="main-zone-btn p-4 border-2 border-gray-300 rounded-lg text-center hover:border-blue-500 transition-colors">
                                            <div class="font-bold text-lg">โซน A</div>
                                            <div class="text-xs text-green-600" id="zone-A-status">5/5 ว่าง</div>
                                        </button>
                                        <button type="button" onclick="selectMainZone('B')" id="main-zone-B" class="main-zone-btn p-4 border-2 border-gray-300 rounded-lg text-center hover:border-blue-500 transition-colors">
                                            <div class="font-bold text-lg">โซน B</div>
                                            <div class="text-xs text-green-600" id="zone-B-status">5/5 ว่าง</div>
                                        </button>
                                        <button type="button" onclick="selectMainZone('C')" id="main-zone-C" class="main-zone-btn p-4 border-2 border-gray-300 rounded-lg text-center hover:border-blue-500 transition-colors">
                                            <div class="font-bold text-lg">โซน C</div>
                                            <div class="text-xs text-green-600" id="zone-C-status">5/5 ว่าง</div>
                                        </button>
                                        <button type="button" onclick="selectMainZone('D')" id="main-zone-D" class="main-zone-btn p-4 border-2 border-gray-300 rounded-lg text-center hover:border-blue-500 transition-colors">
                                            <div class="font-bold text-lg">โซน D</div>
                                            <div class="text-xs text-green-600" id="zone-D-status">5/5 ว่าง</div>
                                        </button>
                                    </div>

                                    <!-- Position Selection -->
                                    <div id="positionSelection" class="hidden">
                                        <div class="flex justify-between items-center mb-2">
                            <label class="block text-sm font-medium text-gray-700">เลือกตำแหน่งจัดเก็บ *</label>
                            <button type="button" onclick="selectAutoPosition()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-lg text-sm transition-colors">
                                <i class="fas fa-magic mr-1"></i> เลือกตำแหน่งว่าง
                            </button>
                        </div>
                                        <div class="grid grid-cols-5 gap-2 mb-3" id="positionGrid">
                                            <!-- Position buttons will be generated here -->
                                        </div>
                                    </div>

                                    <div id="selectedZoneDisplay" class="text-sm text-gray-600 hidden">
                                        <i class="fas fa-map-marker-alt mr-1"></i>
                                        เลือกตำแหน่ง: <span id="selectedZoneText"></span>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">จำนวนถุง *</label>
                                    <input type="number" name="bagCount" min="1" required 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                           oninput="calculateReceiveQuantity()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">จำนวนรับเข้า</label>
                                    <input type="number" id="receiveQuantity" readonly 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Waste</label>
                                    <input type="number" name="waste" min="0" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
                                <textarea name="remarks" rows="3" 
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                          placeholder="หมายเหตุเพิ่มเติม (ถ้ามี)"></textarea>
                            </div>

                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="clearReceiveForm()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                                    ล้างข้อมูล
                                </button>
                                <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                                    <i class="fas fa-save mr-2"></i>บันทึกการรับเข้า
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Receive History -->
            <div class="bg-white rounded-lg card-shadow p-3 sm:p-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-4 sm:mb-6">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 lg:mb-0">
                        <i class="fas fa-history text-green-600 mr-2"></i>ประวัติการรับเข้า
                    </h3>
                    <button onclick="exportReceiveData()" class="bg-green-600 hover:bg-green-700 text-white px-3 sm:px-4 py-2 rounded-lg transition-colors text-sm sm:text-base">
                        <i class="fas fa-download mr-1 sm:mr-2"></i>Export
                    </button>
                </div>

                <!-- Search Receive History -->
                <div class="mb-4">
                    <div class="relative">
                        <input type="text" id="searchReceiveInput" placeholder="ค้นหาด้วย Job No., สินค้า, PO, IV..." 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               oninput="searchReceiveHistory()">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <!-- Receive History Table -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่รับ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job No.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สินค้า</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ลูกค้า</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนถุง</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนรับ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">โซน</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="receiveHistoryBody" class="bg-white divide-y divide-gray-200">
                            <!-- Receive history will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Issue Tab -->
        <div id="issue" class="tab-content hidden">
            <div class="bg-white rounded-lg card-shadow p-3 sm:p-6 mb-4 sm:mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4 sm:mb-6">
                    <i class="fas fa-arrow-up text-red-600 mr-2 sm:mr-3"></i>จ่ายออกสินค้า
                </h2>

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <!-- QR Scanner & Job Selection -->
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">สแกน QR Code หรือเลือก Job No.</label>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <input type="text" id="issueQrInput" placeholder="สแกน QR Code หรือพิมพ์ Job No." 
                                       class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       oninput="searchIssueJobByQR()">
                                <button onclick="openAndStartIssueQRScanner()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors whitespace-nowrap">
                                    <i class="fas fa-qrcode mr-2"></i>สแกน QR
                                </button>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">หรือเลือกจากรายการ</label>
                            <select id="issueJobSelect" onchange="loadIssueJobData()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">-- เลือก Job No. --</option>
                            </select>
                        </div>

                        <!-- QR Scanner Modal for Issue -->
                        <div id="issueQrScannerModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
                            <div class="bg-white rounded-lg p-6 max-w-md w-full">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-semibold">สแกน QR Code</h3>
                                    <button onclick="closeIssueQRScanner()" class="text-gray-400 hover:text-gray-600">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="scanner-container mx-auto mb-4 relative">
                                    <video id="issueQrVideo" class="w-full h-64 object-cover rounded-lg hidden"></video>
                                    <canvas id="issueQrCanvas" class="hidden"></canvas>
                                    <div id="issueScannerPlaceholder" class="text-center text-gray-500 flex flex-col items-center justify-center h-64">
                                        <i class="fas fa-qrcode text-4xl mb-2"></i>
                                        <p>กดปุ่มเริ่มสแกนเพื่อเปิดกล้อง</p>
                                    </div>
                                    <div id="issueScannerOverlay" class="absolute inset-0 hidden">
                                        <div class="absolute inset-4 border-2 border-red-500 rounded-lg opacity-50"></div>
                                        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-32 h-32 border-4 border-green-500 rounded-lg animate-pulse shadow-lg"></div>
                                        <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-70 text-white px-3 py-1 rounded-full text-sm">
                                            วาง QR Code ในกรอบสีเขียว
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-center space-x-3">
                                    <button id="issueStartScanBtn" onclick="startIssueCameraScanning()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors hidden">
                                        <i class="fas fa-camera mr-2"></i>เริ่มสแกน
                                    </button>
                                    <button id="issueStopScanBtn" onclick="stopIssueCameraScanning()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors hidden">
                                        <i class="fas fa-stop mr-2"></i>หยุดสแกน
                                    </button>
                                </div>
                                
                                <!-- Manual QR Input Fallback for Issue -->
                                <div id="issueQrFallbackSection" class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg hidden">
                                    <div class="text-center mb-3">
                                        <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                        <span class="text-yellow-800 font-medium">ไม่สามารถใช้กล้องได้</span>
                                    </div>
                                    <div class="text-sm text-yellow-700 mb-3 text-center">
                                        กรุณากรอก QR Code หรือ Job No. ด้วยตนเอง
                                    </div>
                                    <div class="flex gap-2">
                                        <input type="text" id="issueManualQrInput" placeholder="พิมพ์ QR Code หรือ Job No." 
                                               class="flex-1 px-3 py-2 border border-yellow-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent"
                                               onkeypress="if(event.key==='Enter') submitIssueManualQR()">
                                        <button onclick="submitIssueManualQR()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition-colors whitespace-nowrap">
                                            <i class="fas fa-check mr-2"></i>ตกลง
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="issueScanResult" class="mt-4 p-3 bg-green-100 text-green-800 rounded-lg hidden">
                                    <i class="fas fa-check-circle mr-2"></i>
                                    <span id="issueScanResultText"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Stock Information -->
                        <div id="stockInfo" class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg hidden">
                            <h4 class="font-semibold text-yellow-800 mb-2">
                                <i class="fas fa-warehouse mr-2"></i>ข้อมูลสต็อก
                            </h4>
                            <div class="text-sm text-yellow-700">
                                <div>คงเหลือในคลัง: <span id="stockQuantity" class="font-semibold">0</span> ชิ้น</div>
                                <div>จำนวนถุงคงเหลือ: <span id="stockBags" class="font-semibold">0</span> ถุง</div>
                            </div>
                        </div>
                    </div>

                    <!-- Job Details & Issue Form -->
                    <div>
                        <div id="issueJobDetails" class="p-4 bg-gray-50 rounded-lg mb-6 hidden">
                            <h3 class="font-semibold text-gray-800 mb-3">รายละเอียดงาน</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div><span class="font-medium">MC:</span> <span id="issue-mc"></span></div>
                                <div><span class="font-medium">OE:</span> <span id="issue-oe"></span></div>
                                <div><span class="font-medium">รหัสสินค้า:</span> <span id="issue-productCode"></span></div>
                                <div><span class="font-medium">ชื่อสินค้า:</span> <span id="issue-productName"></span></div>
                                <div><span class="font-medium">ขนาด:</span> <span id="issue-size"></span></div>
                                <div><span class="font-medium">สี:</span> <span id="issue-color"></span></div>
                                <div><span class="font-medium">ลูกค้า:</span> <span id="issue-customerName"></span></div>
                                <div><span class="font-medium">รหัสฝา:</span> <span id="issue-lidCode"></span></div>
                                <div><span class="font-medium">บรรจุ/ถุง:</span> <span id="issue-packPerBag"></span></div>
                            </div>
                        </div>

                        <form id="issueForm" onsubmit="saveIssue(event)" class="space-y-4">
                            <input type="hidden" id="selectedIssueJobIndex" value="">
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">วันที่จ่ายออก *</label>
                                    <input type="date" name="issueDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ผู้รับ</label>
                                    <input type="text" name="recipient" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="ชื่อผู้รับสินค้า">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">จำนวนถุงที่จ่าย *</label>
                                    <input type="number" name="issueBagCount" min="1" required 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                           oninput="calculateIssueQuantity()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">จำนวนจ่ายออก</label>
                                    <input type="number" id="issueQuantity" readonly 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Waste</label>
                                    <input type="number" name="issueWaste" min="0" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ</label>
                                <textarea name="issueRemarks" rows="3" 
                                          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                          placeholder="หมายเหตุเพิ่มเติม (ถ้ามี)"></textarea>
                            </div>

                            <div class="flex justify-end space-x-3">
                                <button type="button" onclick="clearIssueForm()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                                    ล้างข้อมูล
                                </button>
                                <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                    <i class="fas fa-save mr-2"></i>บันทึกการจ่ายออก
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Issue History -->
            <div class="bg-white rounded-lg card-shadow p-3 sm:p-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-4 sm:mb-6">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 lg:mb-0">
                        <i class="fas fa-history text-red-600 mr-2"></i>ประวัติการจ่ายออก
                    </h3>
                    <button onclick="exportIssueData()" class="bg-red-600 hover:bg-red-700 text-white px-3 sm:px-4 py-2 rounded-lg transition-colors text-sm sm:text-base">
                        <i class="fas fa-download mr-1 sm:mr-2"></i>Export
                    </button>
                </div>

                <!-- Search Issue History -->
                <div class="mb-4">
                    <div class="relative">
                        <input type="text" id="searchIssueInput" placeholder="ค้นหาด้วย Job No., สินค้า, PO, IV..." 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               oninput="searchIssueHistory()">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>

                <!-- Issue History Table -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">วันที่จ่าย</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job No.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สินค้า</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ลูกค้า</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนถุง</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนจ่าย</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ผู้รับ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="issueHistoryBody" class="bg-white divide-y divide-gray-200">
                            <!-- Issue history will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content hidden">
            <!-- Dashboard Header with Filters -->
            <div class="bg-white rounded-lg card-shadow p-4 mb-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 lg:mb-0">
                        <i class="fas fa-chart-bar text-purple-600 mr-2"></i>แดชบอร์ดและรายงาน
                    </h2>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium text-gray-700">ช่วงเวลา:</label>
                            <select id="dashboardPeriod" onchange="updateDashboardPeriod()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="today">วันนี้</option>
                                <option value="week">7 วันที่ผ่านมา</option>
                                <option value="month" selected>30 วันที่ผ่านมา</option>
                                <option value="all">ทั้งหมด</option>
                            </select>
                        </div>
                        <button onclick="refreshDashboard()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm flex items-center">
                            <div id="dashboardSpinner" class="spinner mr-2 hidden"></div>
                            <i id="dashboardRefreshIcon" class="fas fa-sync-alt mr-2"></i>รีเฟรช
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Summary Cards -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-6 mb-6 sm:mb-8">
                <div class="bg-white rounded-lg card-shadow p-3 sm:p-6">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 rounded-full bg-blue-100 text-blue-600">
                            <i class="fas fa-boxes text-lg sm:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-4">
                            <p class="text-xs sm:text-sm font-medium text-gray-600">รายการสินค้า</p>
                            <p id="totalItems" class="text-lg sm:text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg card-shadow p-3 sm:p-6">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 rounded-full bg-green-100 text-green-600">
                            <i class="fas fa-arrow-down text-lg sm:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-4">
                            <p class="text-xs sm:text-sm font-medium text-gray-600">รับเข้าวันนี้</p>
                            <p id="todayReceived" class="text-lg sm:text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg card-shadow p-3 sm:p-6">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 rounded-full bg-red-100 text-red-600">
                            <i class="fas fa-arrow-up text-lg sm:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-4">
                            <p class="text-xs sm:text-sm font-medium text-gray-600">จ่ายออกวันนี้</p>
                            <p id="todayIssued" class="text-lg sm:text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg card-shadow p-3 sm:p-6">
                    <div class="flex items-center">
                        <div class="p-2 sm:p-3 rounded-full bg-yellow-100 text-yellow-600">
                            <i class="fas fa-warehouse text-lg sm:text-xl"></i>
                        </div>
                        <div class="ml-2 sm:ml-4">
                            <p class="text-xs sm:text-sm font-medium text-gray-600">สต็อกรวม</p>
                            <p id="totalStock" class="text-lg sm:text-2xl font-bold text-gray-900">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts and Heatmap -->
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 sm:gap-8 mb-6 sm:mb-8">
                <!-- Top 5 Stock Chart -->
                <div class="bg-white rounded-lg card-shadow p-3 sm:p-6">
                    <div class="flex justify-between items-center mb-4 sm:mb-6">
                        <h3 class="text-base sm:text-lg font-bold text-gray-800">
                            <i class="fas fa-trophy text-yellow-600 mr-2"></i>Top 5 Job สต็อกสูงสุด
                        </h3>
                        <div class="flex items-center space-x-2">
                            <div id="chartUpdateIndicator" class="w-2 h-2 bg-green-400 rounded-full animate-pulse hidden"></div>
                            <button onclick="refreshCharts()" class="text-blue-600 hover:text-blue-800 transition-colors">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="h-80">
                        <canvas id="topStockChart" width="400" height="320"></canvas>
                    </div>
                </div>

                <!-- Real-time Storage Zone Heatmap -->
                <div class="bg-white rounded-lg card-shadow p-3 sm:p-6">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 sm:mb-6">
                        <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-2 sm:mb-0">
                            <i class="fas fa-fire text-red-600 mr-2"></i>แผนที่โซนจัดเก็บ (Real-time)
                        </h3>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center space-x-4 text-sm">
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-green-200 rounded mr-2"></div>
                                    <span>ว่าง (0-30%)</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-yellow-400 rounded mr-2"></div>
                                    <span>ปานกลาง (31-70%)</span>
                                </div>
                                <div class="flex items-center">
                                    <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
                                    <span>เต็ม (71-100%)</span>
                                </div>
                            </div>
                            <div id="heatmapUpdateIndicator" class="w-2 h-2 bg-blue-400 rounded-full animate-pulse hidden"></div>
                        </div>
                    </div>
                    <div id="heatmapContainer" class="grid grid-cols-5 gap-2">
                        <!-- Heatmap zones will be generated here -->
                    </div>
                    <div class="mt-4 text-center">
                        <div class="text-sm text-gray-600">
                            <i class="fas fa-info-circle mr-1"></i>
                            คลิกที่โซนเพื่อดูรายละเอียดและกรองข้อมูล
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stock Trend Chart -->
            <div class="bg-white rounded-lg card-shadow p-3 sm:p-6 mb-6 sm:mb-8">
                <div class="flex justify-between items-center mb-4 sm:mb-6">
                    <h3 class="text-base sm:text-lg font-bold text-gray-800">
                        <i class="fas fa-chart-line text-green-600 mr-2"></i>แนวโน้มสต็อกเข้า-ออกรายวัน
                    </h3>
                    <div class="flex items-center space-x-2">
                        <div id="trendUpdateIndicator" class="w-2 h-2 bg-green-400 rounded-full animate-pulse hidden"></div>
                        <button onclick="refreshTrendChart()" class="text-blue-600 hover:text-blue-800 transition-colors">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="stockTrendChart" width="800" height="300"></canvas>
                </div>
            </div>

            <!-- Inventory Report -->
            <div class="bg-white rounded-lg card-shadow p-3 sm:p-6">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-4 sm:mb-6">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4 lg:mb-0">
                        <i class="fas fa-clipboard-list text-purple-600 mr-2"></i>รายงานสต็อกคงเหลือ
                    </h3>
                    <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                        <button onclick="exportInventoryPDF()" class="bg-red-600 hover:bg-red-700 text-white px-3 sm:px-4 py-2 rounded-lg transition-colors text-sm sm:text-base">
                            <i class="fas fa-file-pdf mr-1 sm:mr-2"></i>Export PDF
                        </button>
                        <button onclick="exportInventoryExcel()" class="bg-green-600 hover:bg-green-700 text-white px-3 sm:px-4 py-2 rounded-lg transition-colors text-sm sm:text-base">
                            <i class="fas fa-file-excel mr-1 sm:mr-2"></i>Export Excel
                        </button>
                        <button onclick="refreshInventory()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 sm:px-4 py-2 rounded-lg transition-colors text-sm sm:text-base">
                            <i class="fas fa-sync-alt mr-1 sm:mr-2"></i>รีเฟรช
                        </button>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="relative">
                        <input type="text" id="inventorySearch" placeholder="ค้นหา Job No., รหัสสินค้า, ชื่อสินค้า..." 
                               class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                               oninput="filterInventory()">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div>
                        <select id="zoneFilter" onchange="filterInventory()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">ทุกโซน</option>
                            <optgroup label="โซน A">
                                <option value="A1">A1</option>
                                <option value="A2">A2</option>
                                <option value="A3">A3</option>
                                <option value="A4">A4</option>
                                <option value="A5">A5</option>
                            </optgroup>
                            <optgroup label="โซน B">
                                <option value="B1">B1</option>
                                <option value="B2">B2</option>
                                <option value="B3">B3</option>
                                <option value="B4">B4</option>
                                <option value="B5">B5</option>
                            </optgroup>
                            <optgroup label="โซน C">
                                <option value="C1">C1</option>
                                <option value="C2">C2</option>
                                <option value="C3">C3</option>
                                <option value="C4">C4</option>
                                <option value="C5">C5</option>
                            </optgroup>
                            <optgroup label="โซน D">
                                <option value="D1">D1</option>
                                <option value="D2">D2</option>
                                <option value="D3">D3</option>
                                <option value="D4">D4</option>
                                <option value="D5">D5</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <select id="stockFilter" onchange="filterInventory()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">ทุกสถานะ</option>
                            <option value="instock">มีสต็อก</option>
                            <option value="lowstock">สต็อกต่ำ</option>
                            <option value="outofstock">หมดสต็อก</option>
                        </select>
                    </div>
                </div>

                <!-- Inventory Table -->
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job No.</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รหัสสินค้า</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อสินค้า</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ลูกค้า</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">รับเข้า</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">จ่ายออก</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">คงเหลือ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">โซนจัดเก็บ</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">สถานะ</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTableBody" class="bg-white divide-y divide-gray-200">
                            <!-- Inventory data will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-800">เพิ่มสินค้าใหม่</h3>
                    <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form id="itemForm" onsubmit="saveItem(event)">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">วันที่ *</label>
                            <input type="date" name="date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">MC</label>
                            <input type="text" name="mc" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Job No. *</label>
                            <input type="text" name="jobNo" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">กำหนดส่งสินค้า</label>
                            <input type="date" name="deliveryDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">OE</label>
                            <input type="text" name="oe" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">รหัสสินค้า *</label>
                            <input type="text" name="productCode" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อสินค้า *</label>
                            <input type="text" name="productName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ขนาด</label>
                            <input type="text" name="size" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">สี</label>
                            <input type="text" name="color" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">รหัสลูกค้า</label>
                            <input type="text" name="customerCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ชื่อลูกค้า *</label>
                            <input type="text" name="customerName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">โลโก้</label>
                            <input type="text" name="logo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">วัสดุประกอบ</label>
                            <input type="text" name="material" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">รหัสฝาประกอบ</label>
                            <input type="text" name="lidCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">จำนวนผลิต *</label>
                            <input type="number" name="quantity" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">บรรจุ/ถุง</label>
                            <input type="number" name="packPerBag" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">จำนวนถุง</label>
                            <input type="number" name="bagCount" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">เศษ</label>
                            <input type="number" name="remainder" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
                            ยกเลิก
                        </button>
                        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>บันทึก
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let items = JSON.parse(localStorage.getItem('warehouseItems')) || [];
        let receiveHistory = JSON.parse(localStorage.getItem('receiveHistory')) || [];
        let issueHistory = JSON.parse(localStorage.getItem('issueHistory')) || [];
        let editingIndex = -1;
        let editingReceiveIndex = -1;
        let editingIssueIndex = -1;
        let currentStream = null;
        let isScanning = false;
        let scanningInterval = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            showTab('itemMaster');
            renderItems();
            populateJobSelect();
            populateReceiveJobSelect();
            populateIssueJobSelect();
            renderReceiveHistory();
            renderIssueHistory();
            updateZoneStatus();
            
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="date"]').value = today;
            document.querySelector('input[name="receiveDate"]').value = today;
            document.querySelector('input[name="issueDate"]').value = today;
        });

        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('th-TH', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'text-blue-600');
                btn.classList.add('border-transparent', 'text-gray-700');
            });
            
            // Remove active class from mobile tab buttons
            document.querySelectorAll('.mobile-tab-btn').forEach(btn => {
                btn.classList.remove('bg-blue-50', 'text-blue-600');
                btn.classList.add('text-gray-700');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.remove('hidden');
            
            // Add active class to selected tab button
            const activeBtn = document.getElementById(`tab-${tabName}`);
            if (activeBtn) {
                activeBtn.classList.remove('border-transparent', 'text-gray-700');
                activeBtn.classList.add('border-blue-500', 'text-blue-600');
            }
            
            // Update mobile tab title and active state
            updateMobileTabTitle(tabName);
            
            if (tabName === 'qrSticker') {
                populateJobSelect();
            } else if (tabName === 'receive') {
                populateReceiveJobSelect();
                renderReceiveHistory();
            } else if (tabName === 'issue') {
                populateIssueJobSelect();
                renderIssueHistory();
            } else if (tabName === 'dashboard') {
                updateDashboard();
            }
        }

        function updateMobileTabTitle(tabName) {
            const titleElement = document.getElementById('currentTabTitle');
            const titles = {
                'itemMaster': '<i class="fas fa-box mr-2 text-blue-600"></i>ข้อมูลสินค้า',
                'qrSticker': '<i class="fas fa-qrcode mr-2 text-blue-600"></i>สร้างสติกเกอร์',
                'receive': '<i class="fas fa-arrow-down mr-2 text-green-600"></i>รับเข้าสินค้า',
                'issue': '<i class="fas fa-arrow-up mr-2 text-red-600"></i>จ่ายออกสินค้า',
                'dashboard': '<i class="fas fa-chart-bar mr-2 text-purple-600"></i>แดชบอร์ด'
            };
            titleElement.innerHTML = titles[tabName] || titles['itemMaster'];
        }

        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const menuBtn = document.getElementById('mobileMenuBtn');
            const icon = menuBtn.querySelector('i');
            
            if (mobileMenu.classList.contains('hidden')) {
                mobileMenu.classList.remove('hidden');
                icon.classList.remove('fa-bars');
                icon.classList.add('fa-times');
            } else {
                mobileMenu.classList.add('hidden');
                icon.classList.remove('fa-times');
                icon.classList.add('fa-bars');
            }
        }

        function closeMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            const menuBtn = document.getElementById('mobileMenuBtn');
            const icon = menuBtn.querySelector('i');
            
            mobileMenu.classList.add('hidden');
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
        }

        function showAddForm() {
            editingIndex = -1;
            document.getElementById('modalTitle').textContent = 'เพิ่มสินค้าใหม่';
            document.getElementById('itemForm').reset();
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="date"]').value = today;
            document.getElementById('itemModal').classList.remove('hidden');
        }

        function editItem(index) {
            editingIndex = index;
            const item = items[index];
            document.getElementById('modalTitle').textContent = 'แก้ไขข้อมูลสินค้า';
            
            // Populate form with item data
            const form = document.getElementById('itemForm');
            Object.keys(item).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    input.value = item[key] || '';
                }
            });
            
            document.getElementById('itemModal').classList.remove('hidden');
        }

        function deleteItem(index) {
            if (confirm('คุณต้องการลบรายการนี้หรือไม่?')) {
                items.splice(index, 1);
                localStorage.setItem('warehouseItems', JSON.stringify(items));
                renderItems();
                populateJobSelect();
                populateReceiveJobSelect();
                populateIssueJobSelect();
                updateDashboardIfVisible();
                showNotification('ลบรายการเรียบร้อยแล้ว', 'success');
            }
        }

        function closeModal() {
            document.getElementById('itemModal').classList.add('hidden');
        }

        function saveItem(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const item = {};
            
            for (let [key, value] of formData.entries()) {
                item[key] = value;
            }
            
            // Validation
            if (!validateItem(item)) {
                return;
            }
            
            if (editingIndex >= 0) {
                items[editingIndex] = item;
                showNotification('แก้ไขข้อมูลเรียบร้อยแล้ว', 'success');
            } else {
                items.push(item);
                showNotification('เพิ่มสินค้าเรียบร้อยแล้ว', 'success');
            }
            
            localStorage.setItem('warehouseItems', JSON.stringify(items));
            renderItems();
            populateJobSelect();
            populateReceiveJobSelect();
            populateIssueJobSelect();
            updateDashboardIfVisible();
            closeModal();
        }

        function validateItem(item) {
            // Check for duplicate Job No.
            const existingIndex = items.findIndex(existingItem => 
                existingItem.jobNo === item.jobNo && 
                (editingIndex < 0 || items.indexOf(existingItem) !== editingIndex)
            );
            
            if (existingIndex >= 0) {
                showNotification('Job No. นี้มีอยู่แล้ว กรุณาใช้หมายเลขอื่น', 'error');
                return false;
            }
            
            // Validate numbers
            if (item.quantity && isNaN(item.quantity)) {
                showNotification('จำนวนผลิตต้องเป็นตัวเลข', 'error');
                return false;
            }
            
            if (item.packPerBag && isNaN(item.packPerBag)) {
                showNotification('บรรจุ/ถุงต้องเป็นตัวเลข', 'error');
                return false;
            }
            
            return true;
        }

        function renderItems() {
            const tbody = document.getElementById('itemsTableBody');
            const cardContainer = document.getElementById('itemsCardContainer');
            tbody.innerHTML = '';
            cardContainer.innerHTML = '';
            
            if (items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-box-open text-4xl mb-2 opacity-50"></i>
                            <div>ยังไม่มีข้อมูลสินค้า</div>
                        </td>
                    </tr>
                `;
                cardContainer.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-box-open text-4xl mb-2 opacity-50"></i>
                        <div>ยังไม่มีข้อมูลสินค้า</div>
                    </div>
                `;
                return;
            }
            
            items.forEach((item, index) => {
                // Desktop table row
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900">${formatDate(item.date)}</td>
                    <td class="px-4 py-3 text-sm font-medium text-blue-600">${item.jobNo}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${item.productCode}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${item.productName}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${item.customerName}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${Number(item.quantity).toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex space-x-2">
                            <button onclick="editItem(${index})" class="text-blue-600 hover:text-blue-800 transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteItem(${index})" class="text-red-600 hover:text-red-800 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Mobile card
                const card = document.createElement('div');
                card.className = 'bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-1">
                            <div class="font-medium text-blue-600 text-lg">${item.jobNo}</div>
                            <div class="text-sm text-gray-600">${formatDate(item.date)}</div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editItem(${index})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteItem(${index})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500">รหัสสินค้า:</span>
                            <span class="text-sm font-medium">${item.productCode}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500">ชื่อสินค้า:</span>
                            <span class="text-sm font-medium">${item.productName}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500">ลูกค้า:</span>
                            <span class="text-sm font-medium">${item.customerName}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-sm text-gray-500">จำนวนผลิต:</span>
                            <span class="text-sm font-medium text-green-600">${Number(item.quantity).toLocaleString()}</span>
                        </div>
                    </div>
                `;
                cardContainer.appendChild(card);
            });
        }

        function searchItems() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const tbody = document.getElementById('itemsTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH');
        }

        function populateJobSelect() {
            const select = document.getElementById('jobSelect');
            select.innerHTML = '<option value="">-- เลือก Job No. --</option>';
            
            items.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${item.jobNo} - ${item.productName}`;
                select.appendChild(option);
            });
        }

        function populateReceiveJobSelect() {
            const select = document.getElementById('receiveJobSelect');
            select.innerHTML = '<option value="">-- เลือก Job No. --</option>';
            
            items.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${item.jobNo} - ${item.productName}`;
                select.appendChild(option);
            });
        }

        function loadJobData() {
            const select = document.getElementById('jobSelect');
            const selectedIndex = select.value;
            
            if (selectedIndex === '') {
                document.getElementById('jobDetails').classList.add('hidden');
                return;
            }
            
            const item = items[selectedIndex];
            
            // Populate job details
            document.getElementById('detail-date').textContent = formatDate(item.date);
            document.getElementById('detail-mc').textContent = item.mc || '-';
            document.getElementById('detail-delivery').textContent = formatDate(item.deliveryDate);
            document.getElementById('detail-oe').textContent = item.oe || '-';
            document.getElementById('detail-productCode').textContent = item.productCode;
            document.getElementById('detail-productName').textContent = item.productName;
            document.getElementById('detail-size').textContent = item.size || '-';
            document.getElementById('detail-color').textContent = item.color || '-';
            document.getElementById('detail-customer').textContent = item.customerName;
            document.getElementById('detail-quantity').textContent = item.quantity ? Number(item.quantity).toLocaleString() : '-';
            document.getElementById('detail-packPerBag').textContent = item.packPerBag || '-';
            document.getElementById('detail-bagCount').textContent = item.bagCount || '-';
            document.getElementById('detail-remainder').textContent = item.remainder || '-';
            
            document.getElementById('jobDetails').classList.remove('hidden');
        }

        // Receive Functions
        function searchJobByQR() {
            const qrValue = document.getElementById('qrInput').value.trim();
            if (!qrValue) {
                clearReceiveJobData();
                return;
            }
            
            const jobIndex = items.findIndex(item => item.jobNo === qrValue);
            if (jobIndex >= 0) {
                document.getElementById('receiveJobSelect').value = jobIndex;
                loadReceiveJobData();
                showNotification('พบข้อมูล Job No. แล้ว', 'success');
            } else {
                clearReceiveJobData();
                showNotification('ไม่พบ Job No. นี้ในระบบ', 'error');
            }
        }

        // ===== REUSABLE QR SCANNER FUNCTIONS =====
        
        function openAndStartQRScanner() {
            document.getElementById('qrScannerModal').classList.remove('hidden');
            // Auto-start camera immediately
            setTimeout(() => {
                startCameraScanning();
            }, 100);
        }

        function closeQRScanner() {
            stopCameraScanning();
            document.getElementById('qrScannerModal').classList.add('hidden');
            // Reset fallback input
            document.getElementById('manualQrInput').value = '';
            document.getElementById('qrFallbackSection').classList.add('hidden');
        }

        function startCameraScanning() {
            startQRScannerGeneric(
                'qrVideo', 
                'qrCanvas', 
                'scannerPlaceholder', 
                'scannerOverlay',
                'startScanBtn',
                'stopScanBtn',
                'scanResult',
                'scanResultText',
                handleQRScanResult,
                showQRFallback // Add fallback callback
            );
        }

        function stopCameraScanning() {
            stopQRScannerGeneric();
            // Reset UI elements
            document.getElementById('startScanBtn').classList.add('hidden');
            document.getElementById('stopScanBtn').classList.add('hidden');
            document.getElementById('qrVideo').classList.add('hidden');
            document.getElementById('scannerOverlay').classList.add('hidden');
            document.getElementById('scannerPlaceholder').classList.remove('hidden');
            document.getElementById('scanResult').classList.add('hidden');
        }

        function handleQRScanResult(qrData) {
            stopCameraScanning();
            if (navigator.vibrate) navigator.vibrate(150);
            document.getElementById('qrInput').value = qrData;
            searchJobByQR();
            setTimeout(() => closeQRScanner(), 500);
        }

        function showQRFallback() {
            // Show manual input fallback when camera fails
            document.getElementById('qrFallbackSection').classList.remove('hidden');
            document.getElementById('manualQrInput').focus();
        }

        function submitManualQR() {
            const manualInput = document.getElementById('manualQrInput').value.trim();
            if (manualInput) {
                handleQRScanResult(manualInput);
            } else {
                showNotification('กรุณากรอก QR Code', 'error');
            }
        }

        async function startQRScannerGeneric(videoId, canvasId, placeholderId, overlayId, startBtnId, stopBtnId, resultId, resultTextId, onResult, onFallback) {
            try {
                // Check if camera is available
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Camera not supported on this device');
                }

                // Check if running on HTTPS or localhost
                const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
                if (!isSecure) {
                    throw new Error('Camera requires HTTPS or localhost');
                }

                const video = document.getElementById(videoId);
                const canvas = document.getElementById(canvasId);
                const context = canvas.getContext('2d');
                
                // Show loading state
                document.getElementById(placeholderId).innerHTML = `
                    <div class="text-center text-gray-500 flex flex-col items-center justify-center h-64">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
                        <p>กำลังเปิดกล้อง...</p>
                    </div>
                `;
                
                // Request camera access with fallback options
                try {
                    currentStream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            facingMode: 'environment', // Use back camera on mobile
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }
                    });
                } catch (envError) {
                    // Fallback to any available camera
                    currentStream = await navigator.mediaDevices.getUserMedia({
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        }
                    });
                }
                
                video.srcObject = currentStream;
                video.play();
                
                // Show video and hide placeholder
                document.getElementById(placeholderId).classList.add('hidden');
                document.getElementById(overlayId).classList.remove('hidden');
                video.classList.remove('hidden');
                
                // Toggle buttons
                document.getElementById(startBtnId).classList.add('hidden');
                document.getElementById(stopBtnId).classList.remove('hidden');
                
                isScanning = true;
                
                video.addEventListener('loadedmetadata', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    
                    // Start scanning
                    scanningInterval = setInterval(() => {
                        if (isScanning && video.readyState === video.HAVE_ENOUGH_DATA) {
                            context.drawImage(video, 0, 0, canvas.width, canvas.height);
                            const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                            const code = jsQR(imageData.data, imageData.width, imageData.height);
                            
                            if (code) {
                                handleQRScanResultGeneric(code.data, resultId, resultTextId, onResult);
                            }
                        }
                    }, 100);
                });
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                
                // Reset placeholder to original state
                document.getElementById(placeholderId).innerHTML = `
                    <i class="fas fa-qrcode text-4xl mb-2"></i>
                    <p>ไม่สามารถเปิดกล้องได้</p>
                `;
                document.getElementById(placeholderId).classList.remove('hidden');
                
                let errorMessage = 'ไม่สามารถเข้าถึงกล้องได้';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'กรุณาอนุญาตการใช้งานกล้องในเบราว์เซอร์';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'ไม่พบกล้องในอุปกรณ์นี้';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = 'เบราว์เซอร์ไม่รองรับการใช้งานกล้อง';
                } else if (error.message.includes('HTTPS') || error.message.includes('localhost')) {
                    errorMessage = 'กล้องต้องใช้งานผ่าน HTTPS หรือ localhost เท่านั้น';
                }
                
                showNotification(errorMessage, 'error');
                
                // Show fallback input if callback provided
                if (onFallback && typeof onFallback === 'function') {
                    setTimeout(() => {
                        onFallback();
                    }, 1000);
                }
            }
        }

        function stopQRScannerGeneric() {
            isScanning = false;
            
            if (scanningInterval) {
                clearInterval(scanningInterval);
                scanningInterval = null;
            }
            
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
        }

        function handleQRScanResultGeneric(qrData, resultId, resultTextId, onResult) {
            stopQRScannerGeneric();
            
            // Haptic feedback - ให้มือถือสั่นเมื่อสแกนสำเร็จ
            if (navigator.vibrate) {
                navigator.vibrate(150); // การสั่นสั้นๆ เพียงครั้งเดียว
            }

            // แสดงผลลัพธ์การสแกน
            if (resultId && resultTextId) {
                document.getElementById(resultTextId).textContent = `สแกนสำเร็จ: ${qrData}`;
                document.getElementById(resultId).classList.remove('hidden');
            }

            // เรียก callback ทันที
            onResult(qrData);
            showNotification('สแกน QR Code สำเร็จ!', 'success');
        }

        function loadReceiveJobData() {
            const select = document.getElementById('receiveJobSelect');
            const selectedIndex = select.value;
            
            if (selectedIndex === '') {
                clearReceiveJobData();
                return;
            }
            
            const item = items[selectedIndex];
            document.getElementById('selectedJobIndex').value = selectedIndex;
            
            // Update QR input
            document.getElementById('qrInput').value = item.jobNo;
            
            // Populate receive job details
            document.getElementById('receive-mc').textContent = item.mc || '-';
            document.getElementById('receive-oe').textContent = item.oe || '-';
            document.getElementById('receive-productCode').textContent = item.productCode;
            document.getElementById('receive-productName').textContent = item.productName;
            document.getElementById('receive-size').textContent = item.size || '-';
            document.getElementById('receive-color').textContent = item.color || '-';
            document.getElementById('receive-customerName').textContent = item.customerName;
            document.getElementById('receive-lidCode').textContent = item.lidCode || '-';
            document.getElementById('receive-quantity').textContent = item.quantity ? Number(item.quantity).toLocaleString() : '-';
            document.getElementById('receive-packPerBag').textContent = item.packPerBag || '-';
            document.getElementById('receive-bagCount').textContent = item.bagCount || '-';
            document.getElementById('receive-remainder').textContent = item.remainder || '-';
            
            // Calculate and show storage progress
            updateStorageProgress(item.jobNo, item.bagCount);
            
            document.getElementById('receiveJobDetails').classList.remove('hidden');
            calculateReceiveQuantity();
        }

        function updateStorageProgress(jobNo, totalBags) {
            // Calculate total bags already stored for this job
            const storedBags = receiveHistory
                .filter(r => r.jobNo === jobNo)
                .reduce((sum, r) => sum + r.bagCount, 0);
            
            const totalBagsNum = parseInt(totalBags) || 0;
            const remainingBags = Math.max(0, totalBagsNum - storedBags);
            const progressPercent = totalBagsNum > 0 ? Math.round((storedBags / totalBagsNum) * 100) : 0;
            
            // Update display
            document.getElementById('receive-storedBags').textContent = storedBags.toLocaleString();
            document.getElementById('receive-remainingBags').textContent = remainingBags.toLocaleString();
            document.getElementById('receive-progressPercent').textContent = progressPercent + '%';
            document.getElementById('receive-progressBar').style.width = progressPercent + '%';
            
            // Update progress bar color based on completion
            const progressBar = document.getElementById('receive-progressBar');
            if (progressPercent >= 100) {
                progressBar.className = 'bg-green-600 h-2 rounded-full transition-all duration-300';
            } else if (progressPercent >= 75) {
                progressBar.className = 'bg-blue-600 h-2 rounded-full transition-all duration-300';
            } else if (progressPercent >= 50) {
                progressBar.className = 'bg-yellow-500 h-2 rounded-full transition-all duration-300';
            } else {
                progressBar.className = 'bg-orange-500 h-2 rounded-full transition-all duration-300';
            }
        }

        function clearReceiveJobData() {
            document.getElementById('receiveJobDetails').classList.add('hidden');
            document.getElementById('selectedJobIndex').value = '';
            document.getElementById('receiveQuantity').value = '';
        }

        function calculateReceiveQuantity() {
            const selectedIndex = document.getElementById('selectedJobIndex').value;
            const bagCount = document.querySelector('input[name="bagCount"]').value;
            
            if (selectedIndex && bagCount) {
                const item = items[selectedIndex];
                const packPerBag = parseInt(item.packPerBag) || 0;
                const totalQuantity = parseInt(bagCount) * packPerBag;
                document.getElementById('receiveQuantity').value = totalQuantity;
            } else {
                document.getElementById('receiveQuantity').value = '';
            }
        }

        let selectedMainZone = '';
        let selectedPosition = '';

        function selectMainZone(zone) {
            selectedMainZone = zone;
            selectedPosition = '';
            
            // Clear all main zone selections
            document.querySelectorAll('.main-zone-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700');
                btn.classList.add('border-gray-300');
            });
            
            // Highlight selected main zone
            const selectedBtn = document.getElementById(`main-zone-${zone}`);
            selectedBtn.classList.remove('border-gray-300');
            selectedBtn.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700');
            
            // Show position selection
            showPositionSelection(zone);
            
            // Hide final selection display
            document.getElementById('selectedZoneDisplay').classList.add('hidden');
            document.querySelector('input[name="storageArea"]').value = '';
            
            showNotification(`เลือกโซน ${zone} แล้ว กรุณาเลือกตำแหน่ง`, 'info');
        }

        function showPositionSelection(zone) {
            const positionGrid = document.getElementById('positionGrid');
            positionGrid.innerHTML = '';
            
            // Generate position buttons (1-5 for each zone)
            for (let i = 1; i <= 5; i++) {
                const position = `${zone}${i}`;
                const isOccupied = checkPositionOccupied(position);
                
                const button = document.createElement('button');
                button.type = 'button';
                button.id = `position-${position}`;
                button.className = `position-btn p-3 border-2 rounded-lg text-center transition-colors ${
                    isOccupied 
                        ? 'border-red-300 bg-red-50 text-red-700 cursor-not-allowed' 
                        : 'border-gray-300 hover:border-green-500'
                }`;
                button.onclick = () => selectPosition(position);
                button.disabled = isOccupied;
                
                button.innerHTML = `
                    <div class="font-bold">${position}</div>
                    <div class="text-xs ${isOccupied ? 'text-red-600' : 'text-green-600'}">
                        ${isOccupied ? 'ใช้งาน' : 'ว่าง'}
                    </div>
                `;
                
                positionGrid.appendChild(button);
            }
            
            document.getElementById('positionSelection').classList.remove('hidden');
        }

        function selectPosition(position) {
            if (checkPositionOccupied(position)) {
                showNotification('ตำแหน่งนี้ถูกใช้งานแล้ว', 'error');
                return;
            }
            
            selectedPosition = position;
            
            // Clear all position selections
            document.querySelectorAll('.position-btn').forEach(btn => {
                btn.classList.remove('border-green-500', 'bg-green-50', 'text-green-700');
                if (!btn.disabled) {
                    btn.classList.add('border-gray-300');
                }
            });
            
            // Highlight selected position
            const selectedBtn = document.getElementById(`position-${position}`);
            selectedBtn.classList.remove('border-gray-300');
            selectedBtn.classList.add('border-green-500', 'bg-green-50', 'text-green-700');
            
            // Set hidden input value
            document.querySelector('input[name="storageArea"]').value = position;
            
            // Show selected position display
            document.getElementById('selectedZoneText').textContent = position;
            document.getElementById('selectedZoneDisplay').classList.remove('hidden');
            
            showNotification(`เลือกตำแหน่ง ${position} แล้ว`, 'success');
        }

        function checkPositionOccupied(position) {
            // Get all receives in this position
            const positionReceives = receiveHistory.filter(r => r.storageArea === position);
            
            // Calculate remaining stock using the same logic as heatmap
            let positionStock = 0;
            const jobsInPosition = new Set();
            
            positionReceives.forEach(receive => {
                const jobNo = receive.jobNo;
                jobsInPosition.add(jobNo);
                
                // Calculate total received for this job across all zones
                const totalJobReceived = receiveHistory
                    .filter(r => r.jobNo === jobNo)
                    .reduce((sum, r) => sum + (r.receiveQuantity || 0), 0);
                
                // Calculate total issued for this job across all zones
                const totalJobIssued = issueHistory
                    .filter(i => i.jobNo === jobNo)
                    .reduce((sum, i) => sum + (i.issueQuantity || 0), 0);
                
                // Calculate remaining stock for this job
                const jobRemainingStock = Math.max(0, totalJobReceived - totalJobIssued);
                
                // If this job has remaining stock, add proportional amount to position stock
                if (jobRemainingStock > 0) {
                    const jobReceivedInPosition = receiveHistory
                        .filter(r => r.jobNo === jobNo && r.storageArea === position)
                        .reduce((sum, r) => sum + (r.receiveQuantity || 0), 0);
                    
                    if (jobReceivedInPosition > 0 && totalJobReceived > 0) {
                        // Proportional allocation of remaining stock to this position
                        const positionRatio = jobReceivedInPosition / totalJobReceived;
                        positionStock += Math.floor(jobRemainingStock * positionRatio);
                    }
                }
            });
            
            return positionStock > 0;
        }

        function updateZoneStatus() {
            const zones = ['A', 'B', 'C', 'D'];
            
            zones.forEach(zone => {
                let availablePositions = 0;
                
                for (let i = 1; i <= 5; i++) {
                    const position = `${zone}${i}`;
                    if (!checkPositionOccupied(position)) {
                        availablePositions++;
                    }
                }
                
                const statusElement = document.getElementById(`zone-${zone}-status`);
                statusElement.textContent = `${availablePositions}/5 ว่าง`;
                statusElement.className = availablePositions > 3 ? 'text-xs text-green-600' :
                                        availablePositions > 1 ? 'text-xs text-yellow-600' :
                                        'text-xs text-red-600';
            });
        }

        function clearReceiveForm() {
            document.getElementById('receiveForm').reset();
            document.getElementById('qrInput').value = '';
            document.getElementById('receiveJobSelect').value = '';
            clearReceiveJobData();
            
            // Clear zone and position selections
            selectedMainZone = '';
            selectedPosition = '';
            
            document.querySelectorAll('.main-zone-btn').forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700');
                btn.classList.add('border-gray-300');
            });
            
            document.getElementById('positionSelection').classList.add('hidden');
            document.getElementById('selectedZoneDisplay').classList.add('hidden');
            
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="receiveDate"]').value = today;
        }

        function saveReceive(event) {
            event.preventDefault();
            
            const selectedIndex = document.getElementById('selectedJobIndex').value;
            if (!selectedIndex) {
                showNotification('กรุณาเลือก Job No.', 'error');
                return;
            }
            
            const formData = new FormData(event.target);
            const receiveData = {
                id: Date.now(),
                jobIndex: selectedIndex,
                jobNo: items[selectedIndex].jobNo,
                productCode: items[selectedIndex].productCode,
                productName: items[selectedIndex].productName,
                customerName: items[selectedIndex].customerName,
                mc: items[selectedIndex].mc,
                oe: items[selectedIndex].oe,
                size: items[selectedIndex].size,
                color: items[selectedIndex].color,
                lidCode: items[selectedIndex].lidCode,
                packPerBag: items[selectedIndex].packPerBag,
                receiveDate: formData.get('receiveDate'),
                storageArea: formData.get('storageArea'),
                bagCount: parseInt(formData.get('bagCount')),
                receiveQuantity: parseInt(document.getElementById('receiveQuantity').value),
                waste: parseInt(formData.get('waste')) || 0,
                remarks: formData.get('remarks'),
                timestamp: new Date().toISOString()
            };
            
            if (editingReceiveIndex >= 0) {
                receiveHistory[editingReceiveIndex] = receiveData;
                showNotification('แก้ไขข้อมูลการรับเข้าเรียบร้อยแล้ว', 'success');
                editingReceiveIndex = -1;
            } else {
                receiveHistory.push(receiveData);
                showNotification('บันทึกการรับเข้าเรียบร้อยแล้ว', 'success');
            }
            
            localStorage.setItem('receiveHistory', JSON.stringify(receiveHistory));
            renderReceiveHistory();
            updateZoneStatus();
            updateDashboardIfVisible();
            
            // Update storage progress after saving
            const item = items[selectedIndex];
            updateStorageProgress(item.jobNo, item.bagCount);
            
            clearReceiveForm();
        }

        function renderReceiveHistory() {
            const tbody = document.getElementById('receiveHistoryBody');
            tbody.innerHTML = '';
            
            if (receiveHistory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-2 opacity-50"></i>
                            <div>ยังไม่มีประวัติการรับเข้า</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            receiveHistory.slice().reverse().forEach((receive, index) => {
                const actualIndex = receiveHistory.length - 1 - index;
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900">${formatDate(receive.receiveDate)}</td>
                    <td class="px-4 py-3 text-sm font-medium text-blue-600">${receive.jobNo}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${receive.productName}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${receive.customerName}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${receive.bagCount}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${receive.receiveQuantity.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">${receive.storageArea}</span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex space-x-2">
                            <button onclick="editReceive(${actualIndex})" class="text-blue-600 hover:text-blue-800 transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteReceive(${actualIndex})" class="text-red-600 hover:text-red-800 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editReceive(index) {
            editingReceiveIndex = index;
            const receive = receiveHistory[index];
            
            // Set job selection
            document.getElementById('receiveJobSelect').value = receive.jobIndex;
            document.getElementById('qrInput').value = receive.jobNo;
            loadReceiveJobData();
            
            // Populate form
            document.querySelector('input[name="receiveDate"]').value = receive.receiveDate;
            document.querySelector('input[name="bagCount"]').value = receive.bagCount;
            document.querySelector('input[name="waste"]').value = receive.waste;
            document.querySelector('textarea[name="remarks"]').value = receive.remarks;
            
            // Set zone and position selection
            if (receive.storageArea) {
                const zone = receive.storageArea.charAt(0); // Get first character (A, B, C, D)
                selectMainZone(zone);
                
                // Wait for position grid to be generated, then select position
                setTimeout(() => {
                    selectPosition(receive.storageArea);
                }, 100);
            }
            
            calculateReceiveQuantity();
            
            // Scroll to form
            document.getElementById('receive').scrollIntoView({ behavior: 'smooth' });
            showNotification('กรอกข้อมูลเพื่อแก้ไข', 'info');
        }

        function deleteReceive(index) {
            if (confirm('คุณต้องการลบรายการรับเข้านี้หรือไม่?')) {
                receiveHistory.splice(index, 1);
                localStorage.setItem('receiveHistory', JSON.stringify(receiveHistory));
                renderReceiveHistory();
                showNotification('ลบรายการรับเข้าเรียบร้อยแล้ว', 'success');
            }
        }

        function searchReceiveHistory() {
            const searchTerm = document.getElementById('searchReceiveInput').value.toLowerCase();
            const tbody = document.getElementById('receiveHistoryBody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function exportReceiveData() {
            if (receiveHistory.length === 0) {
                showNotification('ไม่มีข้อมูลให้ Export', 'error');
                return;
            }
            
            const headers = ['วันที่รับ', 'Job No.', 'รหัสสินค้า', 'ชื่อสินค้า', 'ลูกค้า', 'จำนวนถุง', 'จำนวนรับ', 'โซน', 'Waste', 'หมายเหตุ'];
            
            const data = receiveHistory.map(receive => [
                receive.receiveDate || '', receive.jobNo || '', receive.productCode || '', receive.productName || '',
                receive.customerName || '', receive.bagCount || '', receive.receiveQuantity || '', receive.storageArea || '',
                receive.waste || '', receive.remarks || ''
            ]);
            
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Receive History');
            
            // Auto-size columns
            const colWidths = headers.map((_, i) => {
                const maxLength = Math.max(
                    headers[i].length,
                    ...data.map(row => String(row[i] || '').length)
                );
                return { wch: Math.min(maxLength + 2, 30) };
            });
            ws['!cols'] = colWidths;
            
            XLSX.writeFile(wb, `receive-history-${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('Export Excel การรับเข้าเรียบร้อยแล้ว', 'success');
        }

        // Issue Functions
        function populateIssueJobSelect() {
            const select = document.getElementById('issueJobSelect');
            select.innerHTML = '<option value="">-- เลือก Job No. --</option>';
            
            items.forEach((item, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${item.jobNo} - ${item.productName}`;
                select.appendChild(option);
            });
        }

        function searchIssueJobByQR() {
            const qrValue = document.getElementById('issueQrInput').value.trim();
            if (!qrValue) {
                clearIssueJobData();
                return;
            }
            
            const jobIndex = items.findIndex(item => item.jobNo === qrValue);
            if (jobIndex >= 0) {
                document.getElementById('issueJobSelect').value = jobIndex;
                loadIssueJobData();
                showNotification('พบข้อมูล Job No. แล้ว', 'success');
            } else {
                clearIssueJobData();
                showNotification('ไม่พบ Job No. นี้ในระบบ', 'error');
            }
        }

        function openAndStartIssueQRScanner() {
            document.getElementById('issueQrScannerModal').classList.remove('hidden');
            // Auto-start camera immediately
            setTimeout(() => {
                startIssueCameraScanning();
            }, 100);
        }

        function closeIssueQRScanner() {
            stopIssueCameraScanning();
            document.getElementById('issueQrScannerModal').classList.add('hidden');
            // Reset fallback input
            document.getElementById('issueManualQrInput').value = '';
            document.getElementById('issueQrFallbackSection').classList.add('hidden');
        }

        function startIssueCameraScanning() {
            startQRScannerGeneric(
                'issueQrVideo', 
                'issueQrCanvas', 
                'issueScannerPlaceholder', 
                'issueScannerOverlay',
                'issueStartScanBtn',
                'issueStopScanBtn',
                'issueScanResult',
                'issueScanResultText',
                handleIssueQRScanResult,
                showIssueQRFallback // Add fallback callback
            );
        }

        function stopIssueCameraScanning() {
            stopQRScannerGeneric();
            // Reset UI elements
            document.getElementById('issueStartScanBtn').classList.add('hidden');
            document.getElementById('issueStopScanBtn').classList.add('hidden');
            document.getElementById('issueQrVideo').classList.add('hidden');
            document.getElementById('issueScannerOverlay').classList.add('hidden');
            document.getElementById('issueScannerPlaceholder').classList.remove('hidden');
            document.getElementById('issueScanResult').classList.add('hidden');
        }

        function handleIssueQRScanResult(qrData) {
            stopIssueCameraScanning();
            if (navigator.vibrate) navigator.vibrate(150);
            document.getElementById('issueQrInput').value = qrData;
            searchIssueJobByQR();
            setTimeout(() => closeIssueQRScanner(), 500);
        }

        function showIssueQRFallback() {
            // Show manual input fallback when camera fails
            document.getElementById('issueQrFallbackSection').classList.remove('hidden');
            document.getElementById('issueManualQrInput').focus();
        }

        function submitIssueManualQR() {
            const manualInput = document.getElementById('issueManualQrInput').value.trim();
            if (manualInput) {
                handleIssueQRScanResult(manualInput);
            } else {
                showNotification('กรุณากรอก QR Code', 'error');
            }
        }

        function loadIssueJobData() {
            const select = document.getElementById('issueJobSelect');
            const selectedIndex = select.value;
            
            if (selectedIndex === '') {
                clearIssueJobData();
                return;
            }
            
            const item = items[selectedIndex];
            document.getElementById('selectedIssueJobIndex').value = selectedIndex;
            
            // Update QR input
            document.getElementById('issueQrInput').value = item.jobNo;
            
            // Populate issue job details
            document.getElementById('issue-mc').textContent = item.mc || '-';
            document.getElementById('issue-oe').textContent = item.oe || '-';
            document.getElementById('issue-productCode').textContent = item.productCode;
            document.getElementById('issue-productName').textContent = item.productName;
            document.getElementById('issue-size').textContent = item.size || '-';
            document.getElementById('issue-color').textContent = item.color || '-';
            document.getElementById('issue-customerName').textContent = item.customerName;
            document.getElementById('issue-lidCode').textContent = item.lidCode || '-';
            document.getElementById('issue-packPerBag').textContent = item.packPerBag || '-';
            
            document.getElementById('issueJobDetails').classList.remove('hidden');
            
            // Calculate and show stock information
            updateStockInfo(selectedIndex);
            calculateIssueQuantity();
        }

        function clearIssueJobData() {
            document.getElementById('issueJobDetails').classList.add('hidden');
            document.getElementById('stockInfo').classList.add('hidden');
            document.getElementById('selectedIssueJobIndex').value = '';
            document.getElementById('issueQuantity').value = '';
        }

        function updateStockInfo(jobIndex) {
            const item = items[jobIndex];
            const jobNo = item.jobNo;
            
            // Calculate total received
            const totalReceived = receiveHistory
                .filter(r => r.jobNo === jobNo)
                .reduce((sum, r) => sum + r.receiveQuantity, 0);
            
            // Calculate total issued
            const totalIssued = issueHistory
                .filter(i => i.jobNo === jobNo)
                .reduce((sum, i) => sum + i.issueQuantity, 0);
            
            // Calculate remaining stock
            const remainingStock = totalReceived - totalIssued;
            const packPerBag = parseInt(item.packPerBag) || 1;
            const remainingBags = Math.floor(remainingStock / packPerBag);
            
            document.getElementById('stockQuantity').textContent = remainingStock.toLocaleString();
            document.getElementById('stockBags').textContent = remainingBags.toLocaleString();
            document.getElementById('stockInfo').classList.remove('hidden');
        }

        function calculateIssueQuantity() {
            const selectedIndex = document.getElementById('selectedIssueJobIndex').value;
            const bagCount = document.querySelector('input[name="issueBagCount"]').value;
            
            if (selectedIndex && bagCount) {
                const item = items[selectedIndex];
                const packPerBag = parseInt(item.packPerBag) || 0;
                const totalQuantity = parseInt(bagCount) * packPerBag;
                document.getElementById('issueQuantity').value = totalQuantity;
                
                // Check if issue quantity exceeds stock
                const stockQuantity = parseInt(document.getElementById('stockQuantity').textContent.replace(/,/g, '')) || 0;
                if (totalQuantity > stockQuantity) {
                    showNotification('จำนวนที่จ่ายออกเกินสต็อกคงเหลือ', 'error');
                }
            } else {
                document.getElementById('issueQuantity').value = '';
            }
        }

        function clearIssueForm() {
            document.getElementById('issueForm').reset();
            document.getElementById('issueQrInput').value = '';
            document.getElementById('issueJobSelect').value = '';
            clearIssueJobData();
            const today = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="issueDate"]').value = today;
        }

        function saveIssue(event) {
            event.preventDefault();
            
            const selectedIndex = document.getElementById('selectedIssueJobIndex').value;
            if (!selectedIndex) {
                showNotification('กรุณาเลือก Job No.', 'error');
                return;
            }
            
            const formData = new FormData(event.target);
            const issueQuantity = parseInt(document.getElementById('issueQuantity').value);
            const stockQuantity = parseInt(document.getElementById('stockQuantity').textContent.replace(/,/g, '')) || 0;
            
            // Check stock availability
            if (issueQuantity > stockQuantity) {
                showNotification('จำนวนที่จ่ายออกเกินสต็อกคงเหลือ', 'error');
                return;
            }
            
            const issueData = {
                id: Date.now(),
                jobIndex: selectedIndex,
                jobNo: items[selectedIndex].jobNo,
                productCode: items[selectedIndex].productCode,
                productName: items[selectedIndex].productName,
                customerName: items[selectedIndex].customerName,
                mc: items[selectedIndex].mc,
                oe: items[selectedIndex].oe,
                size: items[selectedIndex].size,
                color: items[selectedIndex].color,
                lidCode: items[selectedIndex].lidCode,
                packPerBag: items[selectedIndex].packPerBag,
                issueDate: formData.get('issueDate'),
                recipient: formData.get('recipient'),
                issueBagCount: parseInt(formData.get('issueBagCount')),
                issueQuantity: issueQuantity,
                waste: parseInt(formData.get('issueWaste')) || 0,
                remarks: formData.get('issueRemarks'),
                timestamp: new Date().toISOString()
            };
            
            if (editingIssueIndex >= 0) {
                issueHistory[editingIssueIndex] = issueData;
                showNotification('แก้ไขข้อมูลการจ่ายออกเรียบร้อยแล้ว', 'success');
                editingIssueIndex = -1;
            } else {
                issueHistory.push(issueData);
                showNotification('บันทึกการจ่ายออกเรียบร้อยแล้ว', 'success');
            }
            
            localStorage.setItem('issueHistory', JSON.stringify(issueHistory));
            renderIssueHistory();
            updateStockInfo(selectedIndex); // Update stock info after saving
            updateZoneStatus();
            updateDashboardIfVisible();
            clearIssueForm();
        }

        function renderIssueHistory() {
            const tbody = document.getElementById('issueHistoryBody');
            tbody.innerHTML = '';
            
            if (issueHistory.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-box-open text-4xl mb-2 opacity-50"></i>
                            <div>ยังไม่มีประวัติการจ่ายออก</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            issueHistory.slice().reverse().forEach((issue, index) => {
                const actualIndex = issueHistory.length - 1 - index;
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900">${formatDate(issue.issueDate)}</td>
                    <td class="px-4 py-3 text-sm font-medium text-blue-600">${issue.jobNo}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${issue.productName}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${issue.customerName}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${issue.issueBagCount}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${issue.issueQuantity.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${issue.recipient || '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        <div class="flex space-x-2">
                            <button onclick="editIssue(${actualIndex})" class="text-blue-600 hover:text-blue-800 transition-colors">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteIssue(${actualIndex})" class="text-red-600 hover:text-red-800 transition-colors">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function editIssue(index) {
            editingIssueIndex = index;
            const issue = issueHistory[index];
            
            // Set job selection
            document.getElementById('issueJobSelect').value = issue.jobIndex;
            document.getElementById('issueQrInput').value = issue.jobNo;
            loadIssueJobData();
            
            // Populate form
            document.querySelector('input[name="issueDate"]').value = issue.issueDate;
            document.querySelector('input[name="recipient"]').value = issue.recipient;
            document.querySelector('input[name="issueBagCount"]').value = issue.issueBagCount;
            document.querySelector('input[name="issueWaste"]').value = issue.waste;
            document.querySelector('textarea[name="issueRemarks"]').value = issue.remarks;
            
            calculateIssueQuantity();
            
            // Scroll to form
            document.getElementById('issue').scrollIntoView({ behavior: 'smooth' });
            showNotification('กรอกข้อมูลเพื่อแก้ไข', 'info');
        }

        function deleteIssue(index) {
            if (confirm('คุณต้องการลบรายการจ่ายออกนี้หรือไม่?')) {
                issueHistory.splice(index, 1);
                localStorage.setItem('issueHistory', JSON.stringify(issueHistory));
                renderIssueHistory();
                showNotification('ลบรายการจ่ายออกเรียบร้อยแล้ว', 'success');
            }
        }

        function searchIssueHistory() {
            const searchTerm = document.getElementById('searchIssueInput').value.toLowerCase();
            const tbody = document.getElementById('issueHistoryBody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function exportIssueData() {
            if (issueHistory.length === 0) {
                showNotification('ไม่มีข้อมูลให้ Export', 'error');
                return;
            }
            
            const headers = ['วันที่จ่าย', 'Job No.', 'รหัสสินค้า', 'ชื่อสินค้า', 'ลูกค้า', 'จำนวนถุง', 'จำนวนจ่าย', 'ผู้รับ', 'Waste', 'หมายเหตุ'];
            
            const data = issueHistory.map(issue => [
                issue.issueDate || '', issue.jobNo || '', issue.productCode || '', issue.productName || '',
                issue.customerName || '', issue.issueBagCount || '', issue.issueQuantity || '', issue.recipient || '',
                issue.waste || '', issue.remarks || ''
            ]);
            
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Issue History');
            
            // Auto-size columns
            const colWidths = headers.map((_, i) => {
                const maxLength = Math.max(
                    headers[i].length,
                    ...data.map(row => String(row[i] || '').length)
                );
                return { wch: Math.min(maxLength + 2, 30) };
            });
            ws['!cols'] = colWidths;
            
            XLSX.writeFile(wb, `issue-history-${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('Export Excel การจ่ายออกเรียบร้อยแล้ว', 'success');
        }

        // QR Sticker Functions (existing)
        function generateStickers() {
            const select = document.getElementById('jobSelect');
            const bagQuantity = document.getElementById('bagQuantity').value;
            
            if (!select.value) {
                showNotification('กรุณาเลือก Job No.', 'error');
                return;
            }
            
            if (!bagQuantity || bagQuantity < 1) {
                showNotification('กรุณากรอกจำนวนถุงที่ถูกต้อง', 'error');
                return;
            }
            
            const item = items[select.value];
            const container = document.getElementById('stickersContainer');
            container.innerHTML = '';
            
            for (let i = 1; i <= bagQuantity; i++) {
                const sticker = createSticker(item, i, bagQuantity);
                container.appendChild(sticker);
            }
            
            document.getElementById('stickersPreview').classList.remove('hidden');
            showNotification(`สร้างสติกเกอร์ ${bagQuantity} ใบเรียบร้อยแล้ว`, 'success');
        }

        function createSticker(item, bagNumber, totalBags) {
            const sticker = document.createElement('div');
            sticker.className = 'sticker';
            
            const qrData = item.jobNo;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=80x80&data=${encodeURIComponent(qrData)}`;
            
            sticker.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                    <div style="flex: 1;">
                        <div style="font-size: 12px; font-weight: bold;">${item.jobNo}</div>
                        <div style="font-size: 10px;">${item.productName}</div>
                        <div style="font-size: 10px;">${item.customerName}</div>
                    </div>
                    <img src="${qrUrl}" alt="QR Code" style="width: 60px; height: 60px;" onerror="this.style.display='none';">
                </div>
                <div style="text-align: center; font-size: 14px; font-weight: bold; border-top: 1px solid #333; padding-top: 5px;">
                    ถุงที่ ${bagNumber}/${totalBags}
                </div>
            `;
            
            return sticker;
        }

        function printStickers() {
            window.print();
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            const stickers = document.querySelectorAll('.sticker');
            if (stickers.length === 0) {
                showNotification('ไม่มีสติกเกอร์ให้ Export', 'error');
                return;
            }
            
            pdf.setFontSize(12);
            pdf.text('QR Code Stickers', 20, 20);
            
            let yPosition = 40;
            stickers.forEach((sticker, index) => {
                if (yPosition > 250) {
                    pdf.addPage();
                    yPosition = 20;
                }
                
                const text = sticker.textContent.replace(/\s+/g, ' ').trim();
                pdf.text(text, 20, yPosition);
                yPosition += 30;
            });
            
            pdf.save('qr-stickers.pdf');
            showNotification('Export PDF เรียบร้อยแล้ว', 'success');
        }

        function exportData() {
            if (items.length === 0) {
                showNotification('ไม่มีข้อมูลให้ Export', 'error');
                return;
            }
            
            // Show loading state
            showLoadingState('export');
            
            setTimeout(() => {
                try {
                    const headers = ['วันที่', 'MC', 'Job No.', 'กำหนดส่งสินค้า', 'OE', 'รหัสสินค้า', 'ชื่อสินค้า', 'ขนาด', 'สี', 'รหัสลูกค้า', 'ชื่อลูกค้า', 'โลโก้', 'วัสดุประกอบ', 'รหัสฝาประกอบ', 'จำนวนผลิต', 'บรรจุ/ถุง', 'จำนวนถุง', 'เศษ'];
                    
                    const data = items.map(item => [
                        item.date || '', item.mc || '', item.jobNo || '', item.deliveryDate || '', item.oe || '',
                        item.productCode || '', item.productName || '', item.size || '', item.color || '',
                        item.customerCode || '', item.customerName || '', item.logo || '', item.material || '',
                        item.lidCode || '', item.quantity || '', item.packPerBag || '', item.bagCount || '', item.remainder || ''
                    ]);
                    
                    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Items');
                    
                    // Auto-size columns
                    const colWidths = headers.map((_, i) => {
                        const maxLength = Math.max(
                            headers[i].length,
                            ...data.map(row => String(row[i] || '').length)
                        );
                        return { wch: Math.min(maxLength + 2, 30) };
                    });
                    ws['!cols'] = colWidths;
                    
                    XLSX.writeFile(wb, `warehouse-items-${new Date().toISOString().split('T')[0]}.xlsx`);
                    showNotification('Export Excel เรียบร้อยแล้ว', 'success');
                } catch (error) {
                    showNotification('เกิดข้อผิดพลาดในการ Export', 'error');
                } finally {
                    hideLoadingState('export');
                }
            }, 500);
        }

        function importData() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    if (jsonData.length < 2) {
                        showNotification('ไฟล์ Excel ไม่มีข้อมูล', 'error');
                        return;
                    }
                    
                    const headers = jsonData[0];
                    const importedItems = [];
                    
                    // Map Excel columns to item properties
                    const fieldMap = {
                        'วันที่': 'date', 'MC': 'mc', 'Job No.': 'jobNo',
                        'กำหนดส่งสินค้า': 'deliveryDate', 'OE': 'oe',
                        'รหัสสินค้า': 'productCode', 'ชื่อสินค้า': 'productName',
                        'ขนาด': 'size', 'สี': 'color', 'รหัสลูกค้า': 'customerCode',
                        'ชื่อลูกค้า': 'customerName', 'โลโก้': 'logo',
                        'วัสดุประกอบ': 'material', 'รหัสฝาประกอบ': 'lidCode',
                        'จำนวนผลิต': 'quantity', 'บรรจุ/ถุง': 'packPerBag',
                        'จำนวนถุง': 'bagCount', 'เศษ': 'remainder'
                    };
                    
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row && row.length > 0) {
                            const item = {};
                            
                            headers.forEach((header, index) => {
                                const field = fieldMap[header];
                                if (field && row[index] !== undefined && row[index] !== null && row[index] !== '') {
                                    // Handle date fields
                                    if (field === 'date' || field === 'deliveryDate') {
                                        if (typeof row[index] === 'number') {
                                            // Excel date serial number
                                            const excelDate = new Date((row[index] - 25569) * 86400 * 1000);
                                            item[field] = excelDate.toISOString().split('T')[0];
                                        } else {
                                            item[field] = row[index];
                                        }
                                    } else {
                                        item[field] = String(row[index]).trim();
                                    }
                                }
                            });
                            
                            if (item.jobNo && item.productName) {
                                importedItems.push(item);
                            }
                        }
                    }
                    
                    if (importedItems.length > 0) {
                        items.push(...importedItems);
                        localStorage.setItem('warehouseItems', JSON.stringify(items));
                        renderItems();
                        populateJobSelect();
                        populateReceiveJobSelect();
                        populateIssueJobSelect();
                        showNotification(`Import ข้อมูล ${importedItems.length} รายการเรียบร้อยแล้ว`, 'success');
                    } else {
                        showNotification('ไม่พบข้อมูลที่ถูกต้องในไฟล์ Excel', 'error');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    showNotification('เกิดข้อผิดพลาดในการอ่านไฟล์ Excel', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Dashboard Functions
        let inventoryData = [];
        let stockChart = null;
        let dashboardUpdateTimeout = null;

        function updateDashboard() {
            calculateInventoryData();
            updateSummaryCards();
            renderTopStockChart();
            renderStockTrendChart();
            renderRealTimeHeatmap();
            renderInventoryTable();
        }

        function updateDashboardIfVisible() {
            // Check if dashboard tab is currently visible
            const dashboardTab = document.getElementById('dashboard');
            if (!dashboardTab.classList.contains('hidden')) {
                // Show update indicators
                showUpdateIndicators();
                
                // Debounce updates to avoid too frequent refreshes
                if (dashboardUpdateTimeout) {
                    clearTimeout(dashboardUpdateTimeout);
                }
                
                dashboardUpdateTimeout = setTimeout(() => {
                    updateDashboard();
                    hideUpdateIndicators();
                }, 500);
            }
        }

        function showUpdateIndicators() {
            document.getElementById('chartUpdateIndicator').classList.remove('hidden');
            document.getElementById('heatmapUpdateIndicator').classList.remove('hidden');
        }

        function hideUpdateIndicators() {
            setTimeout(() => {
                document.getElementById('chartUpdateIndicator').classList.add('hidden');
                document.getElementById('heatmapUpdateIndicator').classList.add('hidden');
            }, 1000);
        }

        function calculateInventoryData() {
            inventoryData = [];
            
            items.forEach(item => {
                const jobNo = item.jobNo;
                
                // Calculate total received for this job
                const totalReceived = receiveHistory
                    .filter(r => r.jobNo === jobNo)
                    .reduce((sum, r) => sum + (r.receiveQuantity || 0), 0);
                
                // Calculate total issued for this job
                const totalIssued = issueHistory
                    .filter(i => i.jobNo === jobNo)
                    .reduce((sum, i) => sum + (i.issueQuantity || 0), 0);
                
                // Get storage zones for this job (only zones with remaining stock)
                const jobReceives = receiveHistory.filter(r => r.jobNo === jobNo);
                const storageZones = [];
                
                jobReceives.forEach(receive => {
                    if (receive.storageArea) {
                        // Calculate remaining stock in this specific zone for this job
                        const zoneReceived = receiveHistory
                            .filter(r => r.jobNo === jobNo && r.storageArea === receive.storageArea)
                            .reduce((sum, r) => sum + (r.receiveQuantity || 0), 0);
                        
                        const zoneIssued = issueHistory
                            .filter(i => i.jobNo === jobNo)
                            .reduce((sum, i) => sum + (i.issueQuantity || 0), 0);
                        
                        // Only include zone if it has remaining stock
                        if (zoneReceived > 0 && !storageZones.includes(receive.storageArea)) {
                            storageZones.push(receive.storageArea);
                        }
                    }
                });
                
                const remainingStock = Math.max(0, totalReceived - totalIssued);
                
                inventoryData.push({
                    jobNo: jobNo,
                    productCode: item.productCode,
                    productName: item.productName,
                    customerName: item.customerName,
                    totalReceived: totalReceived,
                    totalIssued: totalIssued,
                    remainingStock: remainingStock,
                    storageZones: storageZones,
                    status: remainingStock > 100 ? 'instock' : remainingStock > 0 ? 'lowstock' : 'outofstock'
                });
            });
        }

        function updateSummaryCards() {
            const today = new Date().toISOString().split('T')[0];
            
            // Total items
            document.getElementById('totalItems').textContent = items.length;
            
            // Today's received
            const todayReceived = receiveHistory
                .filter(r => r.receiveDate === today)
                .reduce((sum, r) => sum + r.receiveQuantity, 0);
            document.getElementById('todayReceived').textContent = todayReceived.toLocaleString();
            
            // Today's issued
            const todayIssued = issueHistory
                .filter(i => i.issueDate === today)
                .reduce((sum, i) => sum + i.issueQuantity, 0);
            document.getElementById('todayIssued').textContent = todayIssued.toLocaleString();
            
            // Total stock
            const totalStock = inventoryData.reduce((sum, item) => sum + item.remainingStock, 0);
            document.getElementById('totalStock').textContent = totalStock.toLocaleString();
        }

        function renderTopStockChart() {
            const canvas = document.getElementById('topStockChart');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (inventoryData.length === 0) {
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '16px Kanit';
                ctx.textAlign = 'center';
                ctx.fillText('ไม่มีข้อมูลสต็อก', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            // Get top 5 jobs with highest stock
            const topJobs = inventoryData
                .filter(item => item.remainingStock > 0)
                .sort((a, b) => b.remainingStock - a.remainingStock)
                .slice(0, 5);
            
            if (topJobs.length === 0) {
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '16px Kanit';
                ctx.textAlign = 'center';
                ctx.fillText('ไม่มีสต็อกคงเหลือ', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const maxStock = Math.max(...topJobs.map(item => item.remainingStock));
            const chartWidth = canvas.width - 140;
            const chartHeight = canvas.height - 80;
            const barWidth = 50;
            const barSpacing = (chartWidth - (barWidth * topJobs.length)) / (topJobs.length + 1);
            
            // Colors for top 5 (gold, silver, bronze, etc.)
            const colors = ['#FFD700', '#C0C0C0', '#CD7F32', '#4F46E5', '#10B981'];
            
            topJobs.forEach((item, index) => {
                const x = barSpacing + (index * (barWidth + barSpacing));
                const barHeight = (item.remainingStock / maxStock) * (chartHeight - 60);
                const y = chartHeight - barHeight + 20;
                
                // Draw bar with gradient effect
                const gradient = ctx.createLinearGradient(0, y, 0, y + barHeight);
                gradient.addColorStop(0, colors[index]);
                gradient.addColorStop(1, colors[index] + '80');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Draw border
                ctx.strokeStyle = colors[index];
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, barWidth, barHeight);
                
                // Draw rank badge
                ctx.fillStyle = colors[index];
                ctx.beginPath();
                ctx.arc(x + barWidth/2, y - 10, 12, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 12px Kanit';
                ctx.textAlign = 'center';
                ctx.fillText((index + 1).toString(), x + barWidth/2, y - 6);
                
                // Draw job number (rotated)
                ctx.save();
                ctx.translate(x + barWidth/2, chartHeight + 35);
                ctx.rotate(-Math.PI / 4);
                ctx.fillStyle = '#374151';
                ctx.font = '12px Kanit';
                ctx.textAlign = 'center';
                ctx.fillText(item.jobNo, 0, 0);
                ctx.restore();
                
                // Draw stock value on top of bar
                ctx.fillStyle = '#374151';
                ctx.font = 'bold 11px Kanit';
                ctx.textAlign = 'center';
                ctx.fillText(item.remainingStock.toLocaleString(), x + barWidth/2, y - 25);
                
                // Draw customer name (truncated)
                ctx.fillStyle = '#6B7280';
                ctx.font = '10px Kanit';
                const customerName = item.customerName.length > 8 ? 
                    item.customerName.substring(0, 8) + '...' : item.customerName;
                ctx.fillText(customerName, x + barWidth/2, chartHeight + 55);
            });
            
            // Draw title
            ctx.fillStyle = '#1F2937';
            ctx.font = 'bold 14px Kanit';
            ctx.textAlign = 'center';
            ctx.fillText('🏆 Top 5 Jobs ที่มีสต็อกสูงสุด', canvas.width / 2, 15);
        }

        function renderRealTimeHeatmap() {
            const container = document.getElementById('heatmapContainer');
            container.innerHTML = '';
            
            const zones = ['A1', 'A2', 'A3', 'A4', 'A5', 'B1', 'B2', 'B3', 'B4', 'B5', 'C1', 'C2', 'C3', 'C4', 'C5', 'D1', 'D2', 'D3', 'D4', 'D5'];
            
            // Calculate stock for each zone using the same logic as inventory calculation
            let maxZoneStock = 0;
            const zoneData = zones.map(zone => {
                // Get all receives in this zone
                const zoneReceives = receiveHistory.filter(r => r.storageArea === zone);
                
                // Calculate remaining stock per job in this zone
                let zoneStock = 0;
                const jobsInZone = new Set();
                
                zoneReceives.forEach(receive => {
                    const jobNo = receive.jobNo;
                    jobsInZone.add(jobNo);
                    
                    // Calculate total received for this job across all zones
                    const totalJobReceived = receiveHistory
                        .filter(r => r.jobNo === jobNo)
                        .reduce((sum, r) => sum + (r.receiveQuantity || 0), 0);
                    
                    // Calculate total issued for this job across all zones
                    const totalJobIssued = issueHistory
                        .filter(i => i.jobNo === jobNo)
                        .reduce((sum, i) => sum + (i.issueQuantity || 0), 0);
                    
                    // Calculate remaining stock for this job
                    const jobRemainingStock = Math.max(0, totalJobReceived - totalJobIssued);
                    
                    // If this job has remaining stock, add it to zone stock
                    // (assuming remaining stock is distributed proportionally across zones)
                    if (jobRemainingStock > 0) {
                        const jobReceivedInZone = receiveHistory
                            .filter(r => r.jobNo === jobNo && r.storageArea === zone)
                            .reduce((sum, r) => sum + (r.receiveQuantity || 0), 0);
                        
                        if (jobReceivedInZone > 0 && totalJobReceived > 0) {
                            // Proportional allocation of remaining stock to this zone
                            const zoneRatio = jobReceivedInZone / totalJobReceived;
                            zoneStock += Math.floor(jobRemainingStock * zoneRatio);
                        }
                    }
                });
                
                maxZoneStock = Math.max(maxZoneStock, zoneStock);
                
                return {
                    zone: zone,
                    stock: zoneStock,
                    jobs: jobsInZone.size
                };
            });
            
            zoneData.forEach(data => {
                const { zone, stock, jobs } = data;
                
                // Calculate utilization percentage based on actual max stock
                const utilization = maxZoneStock > 0 ? stock / maxZoneStock : 0;
                
                // Enhanced color scheme with more granular levels
                let bgColor, textColor, borderColor, intensity;
                
                if (stock === 0) {
                    bgColor = 'bg-gray-100';
                    textColor = 'text-gray-600';
                    borderColor = 'border-gray-300';
                    intensity = 'ว่าง';
                } else if (utilization <= 0.3) {
                    bgColor = 'bg-green-200';
                    textColor = 'text-green-800';
                    borderColor = 'border-green-400';
                    intensity = 'น้อย';
                } else if (utilization <= 0.7) {
                    bgColor = 'bg-yellow-400';
                    textColor = 'text-yellow-900';
                    borderColor = 'border-yellow-600';
                    intensity = 'ปานกลาง';
                } else {
                    bgColor = 'bg-red-500';
                    textColor = 'text-white';
                    borderColor = 'border-red-700';
                    intensity = 'เต็ม';
                }
                
                const zoneDiv = document.createElement('div');
                zoneDiv.className = `${bgColor} ${textColor} ${borderColor} p-3 rounded-lg text-center cursor-pointer hover:scale-105 transition-all duration-200 border-2 shadow-sm hover:shadow-md`;
                
                // Add pulse animation for high utilization zones
                if (utilization > 0.8) {
                    zoneDiv.classList.add('animate-pulse');
                }
                
                zoneDiv.innerHTML = `
                    <div class="font-bold text-lg mb-1">${zone}</div>
                    <div class="text-sm font-medium">${stock.toLocaleString()}</div>
                    <div class="text-xs opacity-90">${jobs} Jobs</div>
                    <div class="text-xs font-medium mt-1">${intensity}</div>
                    <div class="w-full bg-white bg-opacity-30 rounded-full h-1 mt-2">
                        <div class="bg-current h-1 rounded-full transition-all duration-300" style="width: ${utilization * 100}%"></div>
                    </div>
                `;
                
                // Enhanced click handler with zone details
                zoneDiv.onclick = () => {
                    filterByZone(zone);
                    showZoneDetails(zone, stock, jobs, intensity);
                };
                
                // Tooltip on hover
                zoneDiv.title = `โซน ${zone}\nสต็อก: ${stock.toLocaleString()} ชิ้น\nจำนวน Jobs: ${jobs}\nสถานะ: ${intensity} (${Math.round(utilization * 100)}%)`;
                
                container.appendChild(zoneDiv);
            });
        }

        function showZoneDetails(zone, stock, jobs, intensity) {
            // Show zone details in a temporary notification
            const details = `โซน ${zone}: ${stock.toLocaleString()} ชิ้น | ${jobs} Jobs | สถานะ: ${intensity}`;
            showNotification(details, 'info');
        }

        function renderInventoryTable() {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';
            
            if (inventoryData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                            <i class="fas fa-chart-bar text-4xl mb-2 opacity-50"></i>
                            <div>ไม่มีข้อมูลสต็อก</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            inventoryData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-colors';
                
                const statusBadge = item.status === 'instock' ? 
                    '<span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded-full">มีสต็อก</span>' :
                    item.status === 'lowstock' ?
                    '<span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded-full">สต็อกต่ำ</span>' :
                    '<span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">หมดสต็อก</span>';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm font-medium text-blue-600">${item.jobNo}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${item.productCode}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${item.productName}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${item.customerName}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${item.totalReceived.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${item.totalIssued.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm font-medium ${item.remainingStock > 0 ? 'text-green-600' : 'text-red-600'}">${item.remainingStock.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${item.storageZones.join(', ') || '-'}</td>
                    <td class="px-4 py-3 text-sm">${statusBadge}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function filterInventory() {
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            const zoneFilter = document.getElementById('zoneFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;
            
            const tbody = document.getElementById('inventoryTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length === 1) return; // Skip empty state row
                
                const jobNo = cells[0].textContent.toLowerCase();
                const productCode = cells[1].textContent.toLowerCase();
                const productName = cells[2].textContent.toLowerCase();
                const zones = cells[7].textContent;
                const status = cells[8].querySelector('span')?.textContent;
                
                let showRow = true;
                
                // Search filter
                if (searchTerm && !jobNo.includes(searchTerm) && 
                    !productCode.includes(searchTerm) && !productName.includes(searchTerm)) {
                    showRow = false;
                }
                
                // Zone filter
                if (zoneFilter && !zones.includes(zoneFilter)) {
                    showRow = false;
                }
                
                // Stock filter
                if (stockFilter) {
                    const statusMap = {
                        'instock': 'มีสต็อก',
                        'lowstock': 'สต็อกต่ำ',
                        'outofstock': 'หมดสต็อก'
                    };
                    if (status !== statusMap[stockFilter]) {
                        showRow = false;
                    }
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }

        function filterByZone(zone) {
            document.getElementById('zoneFilter').value = zone;
            filterInventory();
            showNotification(`กรองข้อมูลโซน ${zone}`, 'info');
        }

        function refreshCharts() {
            showUpdateIndicators();
            setTimeout(() => {
                updateDashboard();
                hideUpdateIndicators();
                showNotification('รีเฟรชข้อมูลเรียบร้อยแล้ว', 'success');
            }, 300);
        }

        function refreshInventory() {
            updateDashboard();
            showNotification('รีเฟรชรายงานสต็อกเรียบร้อยแล้ว', 'success');
        }

        function exportInventoryPDF() {
            if (inventoryData.length === 0) {
                showNotification('ไม่มีข้อมูลให้ Export', 'error');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            
            // Title
            pdf.setFontSize(16);
            pdf.text('Inventory Report', 20, 20);
            pdf.setFontSize(12);
            pdf.text(`Generated: ${new Date().toLocaleDateString('th-TH')}`, 20, 30);
            
            // Table headers
            const headers = ['Job No.', 'Product Code', 'Product Name', 'Customer', 'Received', 'Issued', 'Remaining', 'Zones', 'Status'];
            let yPosition = 50;
            
            // Draw headers
            pdf.setFontSize(10);
            headers.forEach((header, index) => {
                pdf.text(header, 20 + (index * 20), yPosition);
            });
            
            yPosition += 10;
            
            // Draw data
            inventoryData.forEach(item => {
                if (yPosition > 270) {
                    pdf.addPage();
                    yPosition = 20;
                }
                
                const row = [
                    item.jobNo,
                    item.productCode,
                    item.productName.substring(0, 15),
                    item.customerName.substring(0, 15),
                    item.totalReceived.toString(),
                    item.totalIssued.toString(),
                    item.remainingStock.toString(),
                    item.storageZones.join(','),
                    item.status === 'instock' ? 'In Stock' : item.status === 'lowstock' ? 'Low Stock' : 'Out of Stock'
                ];
                
                row.forEach((cell, index) => {
                    pdf.text(cell, 20 + (index * 20), yPosition);
                });
                
                yPosition += 8;
            });
            
            pdf.save(`inventory-report-${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('Export PDF เรียบร้อยแล้ว', 'success');
        }

        function exportInventoryExcel() {
            if (inventoryData.length === 0) {
                showNotification('ไม่มีข้อมูลให้ Export', 'error');
                return;
            }
            
            const headers = ['Job No.', 'รหัสสินค้า', 'ชื่อสินค้า', 'ลูกค้า', 'รับเข้า', 'จ่ายออก', 'คงเหลือ', 'โซนจัดเก็บ', 'สถานะ'];
            
            const data = inventoryData.map(item => [
                item.jobNo || '', item.productCode || '', item.productName || '', item.customerName || '',
                item.totalReceived || 0, item.totalIssued || 0, item.remainingStock || 0,
                item.storageZones.join(';') || '',
                item.status === 'instock' ? 'มีสต็อก' : item.status === 'lowstock' ? 'สต็อกต่ำ' : 'หมดสต็อก'
            ]);
            
            const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Inventory Report');
            
            // Auto-size columns
            const colWidths = headers.map((_, i) => {
                const maxLength = Math.max(
                    headers[i].length,
                    ...data.map(row => String(row[i] || '').length)
                );
                return { wch: Math.min(maxLength + 2, 30) };
            });
            ws['!cols'] = colWidths;
            
            // Add formatting for numbers
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                for (let C = 4; C <= 6; ++C) { // Columns E, F, G (received, issued, remaining)
                    const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                    if (ws[cellAddress]) {
                        ws[cellAddress].t = 'n'; // Set as number type
                        ws[cellAddress].z = '#,##0'; // Number format with comma separator
                    }
                }
            }
            
            XLSX.writeFile(wb, `inventory-report-${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('Export Excel รายงานสต็อกเรียบร้อยแล้ว', 'success');
        }

        function selectAutoPosition() {
            if (!selectedMainZone) {
                showNotification('กรุณาเลือกโซนหลักก่อน', 'error');
                return;
            }
            
            const positions = document.querySelectorAll('#positionGrid button:not(:disabled)');
            const firstAvailable = Array.from(positions).find(btn => !btn.disabled);
            
            if (firstAvailable) {
                firstAvailable.click();
                showNotification('เลือกตำแหน่งว่างอัตโนมัติแล้ว', 'success');
            } else {
                showNotification('ไม่มีตำแหน่งว่างในโซนนี้', 'error');
            }
        }

        function showToast(message, type = "success") {
            const container = document.getElementById("toast-container");
            const bg = {
                success: "bg-green-500", 
                error: "bg-red-500", 
                warning: "bg-yellow-500",
                info: "bg-blue-500"
            }[type] || "bg-gray-800";
            
            const icon = {
                success: "fa-check-circle",
                error: "fa-exclamation-triangle", 
                warning: "fa-exclamation-circle",
                info: "fa-info-circle"
            }[type] || "fa-bell";
            
            const toast = document.createElement("div");
            toast.className = `toast ${bg} text-white px-4 py-3 rounded-xl shadow-lg flex items-center space-x-3 min-w-64 max-w-sm`;
            toast.innerHTML = `
                <div class="flex-shrink-0">
                    <i class="fas ${icon} text-lg"></i>
                </div>
                <div class="flex-1">
                    <span class="font-medium text-sm">${message}</span>
                </div>
                <button onclick="this.parentElement.remove()" class="flex-shrink-0 text-white hover:text-gray-200 transition-colors">
                    <i class="fas fa-times text-sm"></i>
                </button>
            `;
            
            container.appendChild(toast);
            
            // Enhanced fade-in animation with bounce effect
            setTimeout(() => {
                toast.style.transform = 'translateX(0) scale(1.05)';
                toast.style.opacity = '1';
                
                setTimeout(() => {
                    toast.style.transform = 'translateX(0) scale(1)';
                }, 150);
            }, 50);
            
            // Auto remove after 4 seconds with enhanced fade-out
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 4000);
        }

        // Loading State Functions
        function showLoadingState(type) {
            const spinner = document.getElementById(`${type}Spinner`);
            const icon = document.getElementById(`${type}Icon`);
            const btn = document.getElementById(`${type}Btn`);
            
            if (spinner && icon && btn) {
                spinner.classList.remove('hidden');
                icon.classList.add('hidden');
                btn.disabled = true;
                btn.classList.add('opacity-75', 'cursor-not-allowed');
            }
        }
        
        function hideLoadingState(type) {
            const spinner = document.getElementById(`${type}Spinner`);
            const icon = document.getElementById(`${type}Icon`);
            const btn = document.getElementById(`${type}Btn`);
            
            if (spinner && icon && btn) {
                spinner.classList.add('hidden');
                icon.classList.remove('hidden');
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-not-allowed');
            }
        }
        
        // Dashboard Period Filter
        let currentDashboardPeriod = 'month';
        
        function updateDashboardPeriod() {
            currentDashboardPeriod = document.getElementById('dashboardPeriod').value;
            showLoadingState('dashboard');
            
            setTimeout(() => {
                updateDashboard();
                hideLoadingState('dashboard');
                showNotification(`อัปเดตข้อมูลช่วง${getPeriodText(currentDashboardPeriod)}แล้ว`, 'success');
            }, 800);
        }
        
        function getPeriodText(period) {
            const texts = {
                'today': 'วันนี้',
                'week': '7 วันที่ผ่านมา',
                'month': '30 วันที่ผ่านมา',
                'all': 'ทั้งหมด'
            };
            return texts[period] || 'ทั้งหมด';
        }
        
        function getDateFilter(period) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            switch (period) {
                case 'today':
                    return { start: today, end: new Date(today.getTime() + 24 * 60 * 60 * 1000) };
                case 'week':
                    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return { start: weekAgo, end: new Date(today.getTime() + 24 * 60 * 60 * 1000) };
                case 'month':
                    const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
                    return { start: monthAgo, end: new Date(today.getTime() + 24 * 60 * 60 * 1000) };
                case 'all':
                default:
                    return { start: new Date(2020, 0, 1), end: new Date(2030, 11, 31) };
            }
        }
        
        function refreshDashboard() {
            showLoadingState('dashboard');
            
            setTimeout(() => {
                updateDashboard();
                hideLoadingState('dashboard');
                showNotification('รีเฟรชแดชบอร์ดเรียบร้อยแล้ว', 'success');
            }, 1000);
        }
        
        function refreshTrendChart() {
            document.getElementById('trendUpdateIndicator').classList.remove('hidden');
            
            setTimeout(() => {
                renderStockTrendChart();
                document.getElementById('trendUpdateIndicator').classList.add('hidden');
                showNotification('รีเฟรชกราฟแนวโน้มเรียบร้อยแล้ว', 'success');
            }, 800);
        }
        
        // Stock Trend Chart Function
        function renderStockTrendChart() {
            const canvas = document.getElementById('stockTrendChart');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Get date filter
            const dateFilter = getDateFilter(currentDashboardPeriod);
            
            // Prepare data for the last 30 days (or filtered period)
            const days = [];
            const receiveData = [];
            const issueData = [];
            
            // Generate date range
            const dayCount = currentDashboardPeriod === 'today' ? 1 : 
                           currentDashboardPeriod === 'week' ? 7 : 
                           currentDashboardPeriod === 'month' ? 30 : 30;
            
            for (let i = dayCount - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                days.push(date.toLocaleDateString('th-TH', { month: 'short', day: 'numeric' }));
                
                // Calculate daily receive
                const dailyReceive = receiveHistory
                    .filter(r => r.receiveDate === dateStr)
                    .reduce((sum, r) => sum + (r.receiveQuantity || 0), 0);
                receiveData.push(dailyReceive);
                
                // Calculate daily issue
                const dailyIssue = issueHistory
                    .filter(i => i.issueDate === dateStr)
                    .reduce((sum, i) => sum + (i.issueQuantity || 0), 0);
                issueData.push(dailyIssue);
            }
            
            if (receiveData.every(val => val === 0) && issueData.every(val => val === 0)) {
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '16px Kanit';
                ctx.textAlign = 'center';
                ctx.fillText('ไม่มีข้อมูลในช่วงเวลานี้', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const maxValue = Math.max(...receiveData, ...issueData, 100);
            const chartWidth = canvas.width - 100;
            const chartHeight = canvas.height - 80;
            const stepX = chartWidth / (days.length - 1);
            
            // Draw grid lines
            ctx.strokeStyle = '#E5E7EB';
            ctx.lineWidth = 1;
            
            // Horizontal grid lines
            for (let i = 0; i <= 5; i++) {
                const y = 40 + (chartHeight / 5) * i;
                ctx.beginPath();
                ctx.moveTo(60, y);
                ctx.lineTo(60 + chartWidth, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#6B7280';
                ctx.font = '12px Kanit';
                ctx.textAlign = 'right';
                const value = Math.round(maxValue - (maxValue / 5) * i);
                ctx.fillText(value.toLocaleString(), 55, y + 4);
            }
            
            // Draw receive line (green)
            ctx.strokeStyle = '#10B981';
            ctx.lineWidth = 3;
            ctx.beginPath();
            receiveData.forEach((value, index) => {
                const x = 60 + index * stepX;
                const y = 40 + chartHeight - (value / maxValue) * chartHeight;
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Draw receive points
            ctx.fillStyle = '#10B981';
            receiveData.forEach((value, index) => {
                const x = 60 + index * stepX;
                const y = 40 + chartHeight - (value / maxValue) * chartHeight;
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            // Draw issue line (red)
            ctx.strokeStyle = '#EF4444';
            ctx.lineWidth = 3;
            ctx.beginPath();
            issueData.forEach((value, index) => {
                const x = 60 + index * stepX;
                const y = 40 + chartHeight - (value / maxValue) * chartHeight;
                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Draw issue points
            ctx.fillStyle = '#EF4444';
            issueData.forEach((value, index) => {
                const x = 60 + index * stepX;
                const y = 40 + chartHeight - (value / maxValue) * chartHeight;
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            // Draw X-axis labels
            ctx.fillStyle = '#6B7280';
            ctx.font = '11px Kanit';
            ctx.textAlign = 'center';
            days.forEach((day, index) => {
                if (index % Math.ceil(days.length / 8) === 0) { // Show every nth label to avoid crowding
                    const x = 60 + index * stepX;
                    ctx.fillText(day, x, chartHeight + 60);
                }
            });
            
            // Draw legend
            ctx.fillStyle = '#10B981';
            ctx.fillRect(chartWidth - 150, 15, 15, 15);
            ctx.fillStyle = '#374151';
            ctx.font = '12px Kanit';
            ctx.textAlign = 'left';
            ctx.fillText('รับเข้า', chartWidth - 130, 27);
            
            ctx.fillStyle = '#EF4444';
            ctx.fillRect(chartWidth - 60, 15, 15, 15);
            ctx.fillStyle = '#374151';
            ctx.fillText('จ่ายออก', chartWidth - 40, 27);
            
            // Title
            ctx.fillStyle = '#1F2937';
            ctx.font = 'bold 14px Kanit';
            ctx.textAlign = 'center';
            ctx.fillText(`📈 แนวโน้มสต็อก${getPeriodText(currentDashboardPeriod)}`, canvas.width / 2, 20);
        }
        
        // Alias for backward compatibility
        function showNotification(message, type = 'info') {
            showToast(message, type);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97f72f44541ad32d',t:'MTc1NzkyOTQ1Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
