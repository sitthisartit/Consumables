<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบเบิกจ่ายสินค้า</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Very light blue-gray background for the whole page */
        }
        /* Custom styles for button hover effects */
        .nav-button {
            background-image: linear-gradient(to right, var(--tw-gradient-stops));
            transition: all 0.3s ease-in-out;
            transform: scale(1);
        }
        .nav-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .nav-button.active {
            background-image: linear-gradient(to right, var(--tw-gradient-stops));
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useCallback, createContext, useContext, useMemo, useRef } from 'https://esm.sh/react@18.2.0';
        import ReactDOM from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, getDocs, onSnapshot, query, where, doc, updateDoc, writeBatch, deleteDoc, runTransaction } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            // Your actual Firebase configuration provided by the user
            apiKey: "AIzaSyCuzjjUtUotgymcA0kqoYTOrxqk49DfSws",
            authDomain: "inventorymanagementapp-eb01c.firebaseapp.com",
            projectId: "inventorymanagementapp-eb01c",
            storageBucket: "inventorymanagementapp-eb01c.firebasestorage.app",
            messagingSenderId: "313839397834",
            appId: "1:313839397834:web:7a831faf06cb6fd983bd33",
            measurementId: "G-9TQR31P0RR"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Create a Firebase Context
        const FirebaseContext = createContext(null);

        // Utility function to format date in Thai Buddhist calendar
        const formatDate = (timestamp) => {
            if (!timestamp) return '';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            // Example: 26 กรกฎาคม 2568
            return date.toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                calendar: 'buddhist'
            });
        };

        // --- Pagination Controls Component ---
        function Pagination({ totalItems, itemsPerPage, currentPage, onPageChange }) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const pageNumbers = [];
            for (let i = 1; i <= totalPages; i++) {
                pageNumbers.push(i);
            }

            if (totalPages <= 1) return null; // Don't show pagination if only one page

            return React.createElement(
                'nav',
                { className: 'flex justify-center items-center space-x-2 mt-6' },
                React.createElement(
                    'button',
                    {
                        onClick: () => onPageChange(currentPage - 1),
                        disabled: currentPage === 1,
                        className: 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200',
                    },
                    'ก่อนหน้า'
                ),
                pageNumbers.map(number =>
                    React.createElement(
                        'button',
                        {
                            key: number,
                            onClick: () => onPageChange(number),
                            className: `px-4 py-2 rounded-lg font-semibold ${
                                currentPage === number ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                            } transition-colors duration-200`,
                        },
                        number
                    )
                ),
                React.createElement(
                    'button',
                    {
                        onClick: () => onPageChange(currentPage + 1),
                        disabled: currentPage === totalPages,
                        className: 'px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200',
                    },
                    'ถัดไป'
                )
            );
        }

        // --- Confirmation Modal Component ---
        function ConfirmationModal({ isOpen, title, message, onConfirm, onCancel }) {
            if (!isOpen) return null;

            return React.createElement(
                'div',
                { className: 'fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4' },
                React.createElement(
                    'div',
                    { className: 'bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-auto border border-gray-200' },
                    React.createElement('h3', { className: 'text-xl font-bold text-gray-900 mb-4' }, title),
                    React.createElement('p', { className: 'text-gray-700 mb-6' }, message),
                    React.createElement(
                        'div',
                        { className: 'flex justify-end space-x-3' },
                        React.createElement(
                            'button',
                            {
                                onClick: onCancel,
                                className: 'px-5 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition-colors duration-200 shadow-md',
                            },
                            'ยกเลิก'
                        ),
                        React.createElement(
                            'button',
                            {
                                onClick: onConfirm,
                                className: 'px-5 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors duration-200 shadow-md',
                            },
                            'ยืนยัน'
                        )
                    )
                )
            );
        }

        // --- Message Display Component ---
        function MessageDisplay({ message, type, onClose }) {
            if (!message) return null;

            const bgColor = type === 'success' ? 'bg-green-50 border border-green-200 text-green-700' :
                            type === 'info' ? 'bg-blue-50 border border-blue-200 text-blue-700' :
                            'bg-red-50 border border-red-200 text-red-700';
            const icon = type === 'success' ? 'fas fa-check-circle' :
                         type === 'info' ? 'fas fa-info-circle' :
                         'fas fa-exclamation-triangle';

            return React.createElement(
                'div',
                { className: `p-4 mb-4 rounded-lg shadow-md flex items-center gap-3 ${bgColor}` },
                React.createElement('i', { className: `${icon} text-xl` }),
                React.createElement('span', { className: 'font-medium flex-grow' }, message),
                React.createElement('button', { onClick: onClose, className: 'text-gray-500 hover:text-gray-700' }, React.createElement('i', { className: 'fas fa-times' }))
            );
        }

        // --- Receive Items Component ---
        function ReceiveItems() {
            const { db, userId, publicDataPath } = useContext(FirebaseContext);
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [itemName, setItemName] = useState('');
            const [unit, setUnit] = useState('');
            const [quantity, setQuantity] = useState('');
            const [poNumber, setPoNumber] = useState('');
            const [ivNumber, setIvNumber] = useState('');
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');
            const [items, setItems] = useState([]); // List of existing items for dropdown
            const [recentTransactions, setRecentTransactions] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const fileInputRef = useRef(null); // Ref for file input

            // Pagination states
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 10;

            // Confirmation Modal states
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [transactionToDelete, setTransactionToDelete] = useState(null);

            // Validation states
            const [itemNameError, setItemNameError] = useState('');
            const [unitError, setUnitError] = useState('');
            const [quantityError, setQuantityError] = useState('');
            const [ivNumberError, setIvNumberError] = useState('');

            const itemsCollectionRef = collection(db, `${publicDataPath}/items`);
            const transactionsCollectionRef = collection(db, `${publicDataPath}/transactions`);

            // Fetch existing items for dropdown and recent transactions
            useEffect(() => {
                if (!db || !userId) return;
                setIsLoading(true);

                // Fetch items
                const unsubscribeItems = onSnapshot(itemsCollectionRef, (snapshot) => {
                    const itemsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setItems(itemsData);
                }, (error) => {
                    console.error("Error fetching items:", error);
                    setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลสินค้า.");
                    setMessageType('error');
                });

                // Fetch recent receive transactions
                const q = query(transactionsCollectionRef, where('type', '==', 'receive'));
                const unsubscribeTransactions = onSnapshot(q, (snapshot) => {
                    const transactionsData = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => b.date.toDate() - a.date.toDate()); // Sort in JavaScript
                    setRecentTransactions(transactionsData);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching recent transactions:", error);
                    setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลการรับเข้าล่าสุด.");
                    setMessageType('error');
                    setIsLoading(false);
                });

                return () => {
                    unsubscribeItems();
                    unsubscribeTransactions();
                };
            }, [db, userId, publicDataPath]);

            const handleItemNameChange = (e) => {
                const selectedName = e.target.value;
                setItemName(selectedName);
                const selectedItem = items.find(item => item.name === selectedName);
                if (selectedItem) {
                    setUnit(selectedItem.unit || '');
                    // Make unit read-only if item is selected from existing list
                    e.target.form.elements.unit.readOnly = true;
                } else {
                    setUnit(''); // Clear unit if a new item name is typed
                    e.target.form.elements.unit.readOnly = false;
                }
                setItemNameError(''); // Clear error on change
            };

            const handleUnitChange = (e) => {
                setUnit(e.target.value);
                setUnitError('');
            };

            const handleQuantityChange = (e) => {
                setQuantity(e.target.value);
                setQuantityError('');
            };

            const handleIvNumberChange = (e) => {
                setIvNumber(e.target.value);
                setIvNumberError('');
            };

            const validateForm = () => {
                let isValid = true;
                if (!itemName) {
                    setItemNameError('กรุณากรอกชื่อสินค้า');
                    isValid = false;
                } else {
                    setItemNameError('');
                }
                if (!unit) {
                    setUnitError('กรุณากรอกหน่วยนับ');
                    isValid = false;
                } else {
                    setUnitError('');
                }
                if (isNaN(parseFloat(quantity)) || parseFloat(quantity) <= 0) {
                    setQuantityError('จำนวนรับเข้าต้องเป็นตัวเลขและมากกว่า 0');
                    isValid = false;
                } else {
                    setQuantityError('');
                }
                if (!ivNumber) {
                    setIvNumberError('กรุณากรอกเลขที่ IV');
                    isValid = false;
                } else {
                    setIvNumberError('');
                }
                return isValid;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setMessage('');
                setMessageType('');

                if (!validateForm()) {
                    return;
                }

                setIsLoading(true);
                try {
                    await runTransaction(db, async (transaction) => {
                        // 1. Add/Update item master data
                        const existingItemQuery = query(itemsCollectionRef, where('name', '==', itemName));
                        const existingItemSnapshot = await transaction.get(existingItemQuery);

                        let itemDocRef;
                        if (existingItemSnapshot.empty) {
                            // Item does not exist, add new item
                            itemDocRef = doc(itemsCollectionRef); // Firestore will auto-generate ID
                            transaction.set(itemDocRef, {
                                name: itemName,
                                unit: unit,
                                minStock: 0, // Default minimum stock for new items
                            });
                        } else {
                            // Item exists, update its unit if changed (or just ensure it exists)
                            itemDocRef = existingItemSnapshot.docs[0].ref;
                            if (existingItemSnapshot.docs[0].data().unit !== unit) {
                                transaction.update(itemDocRef, { unit: unit });
                            }
                        }

                        // 2. Add transaction
                        const newTransactionRef = doc(transactionsCollectionRef); // Firestore will auto-generate ID
                        transaction.set(newTransactionRef, {
                            date: new Date(date),
                            itemName: itemName,
                            unit: unit,
                            quantity: parseFloat(quantity),
                            type: 'receive',
                            poNumber: poNumber,
                            ivNumber: ivNumber,
                            userId: userId,
                        });
                    });

                    setMessage('บันทึกการรับเข้าสินค้าเรียบร้อยแล้ว!');
                    setMessageType('success');
                    // Clear form
                    setItemName('');
                    setUnit('');
                    setQuantity('');
                    setPoNumber('');
                    setIvNumber('');
                    setDate(new Date().toISOString().split('T')[0]); // Reset date to today
                    // Clear validation errors
                    setItemNameError('');
                    setUnitError('');
                    setQuantityError('');
                    setIvNumberError('');
                    setCurrentPage(1); // Reset to first page after successful submission
                } catch (e) {
                    console.error("Error adding document: ", e);
                    setMessage('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + e.message);
                    setMessageType('error');
                } finally {
                    setIsLoading(false);
                }
            };

            const confirmDeleteTransaction = (transaction) => {
                setTransactionToDelete(transaction);
                setShowConfirmModal(true);
            };

            const handleDeleteTransaction = async () => {
                if (!transactionToDelete) return;

                setMessage('');
                setMessageType('');
                setIsLoading(true);
                setShowConfirmModal(false); // Close the modal immediately

                try {
                    await runTransaction(db, async (transaction) => {
                        const transactionRef = doc(transactionsCollectionRef, transactionToDelete.id);
                        transaction.delete(transactionRef);
                    });
                    setMessage('ลบรายการรับเข้าเรียบร้อยแล้ว!');
                    setMessageType('success');
                } catch (e) {
                    console.error("Error deleting transaction:", e);
                    setMessage('เกิดข้อผิดพลาดในการลบรายการ: ' + e.message);
                    setMessageType('error');
                } finally {
                    setIsLoading(false);
                    setTransactionToDelete(null);
                }
            };

            const cancelDelete = () => {
                setShowConfirmModal(false);
                setTransactionToDelete(null);
            };

            const handleExportCSV = () => {
                let csvContent = "\uFEFF" + "วันที่,ชื่อสินค้า,หน่วยนับ,จำนวน,เลขที่ PO,เลขที่ IV\n";
                filteredRecentTransactions.forEach(transaction => {
                    const dateFormatted = formatDate(transaction.date);
                    const po = transaction.poNumber || '';
                    csvContent += `"${dateFormatted}","${transaction.itemName}","${transaction.unit}",${transaction.quantity},"${po}","${transaction.ivNumber}"\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `รายการรับเข้า_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                if (file.type !== 'text/csv') {
                    setMessage('กรุณาอัปโหลดไฟล์ CSV เท่านั้น.');
                    setMessageType('error');
                    return;
                }

                setIsLoading(true);
                setMessage('');
                setMessageType('');

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    if (lines.length === 0) {
                        setMessage('ไฟล์ CSV ว่างเปล่า.');
                        setMessageType('error');
                        setIsLoading(false);
                        return;
                    }

                    const headers = lines[0].split(',').map(h => h.trim());
                    const expectedHeaders = ["วันที่", "ชื่อสินค้า", "หน่วยนับ", "จำนวน", "เลขที่ PO", "เลขที่ IV"];

                    // Basic header validation
                    if (!expectedHeaders.every(h => headers.includes(h))) {
                        setMessage(`โครงสร้างไฟล์ CSV ไม่ถูกต้อง. ต้องมีคอลัมน์: ${expectedHeaders.join(', ')}`);
                        setMessageType('error');
                        setIsLoading(false);
                        return;
                    }

                    const records = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        if (values.length !== headers.length) {
                            console.warn(`Skipping malformed row ${i + 1}: ${lines[i]}`);
                            continue; // Skip malformed rows
                        }
                        const record = {};
                        headers.forEach((header, index) => {
                            record[header] = values[index].trim();
                        });
                        records.push(record);
                    }

                    if (records.length === 0) {
                        setMessage('ไม่พบข้อมูลที่ถูกต้องในไฟล์ CSV.');
                        setMessageType('error');
                        setIsLoading(false);
                        return;
                    }

                    const batch = writeBatch(db);
                    let successCount = 0;
                    let errorCount = 0;
                    const errors = [];

                    for (const record of records) {
                        try {
                            const recordDate = new Date(record["วันที่"]);
                            const recordQuantity = parseFloat(record["จำนวน"]);

                            if (isNaN(recordDate.getTime())) {
                                throw new Error(`วันที่ไม่ถูกต้อง: ${record["วันที่"]}`);
                            }
                            if (isNaN(recordQuantity) || recordQuantity <= 0) {
                                throw new Error(`จำนวนไม่ถูกต้อง: ${record["จำนวน"]}`);
                            }
                            if (!record["ชื่อสินค้า"] || !record["หน่วยนับ"] || !record["เลขที่ IV"]) {
                                throw new Error(`ข้อมูลไม่ครบถ้วน (ชื่อสินค้า, หน่วยนับ, เลขที่ IV)`);
                            }

                            // 1. Add/Update item master data
                            const existingItemQuery = query(itemsCollectionRef, where('name', '==', record["ชื่อสินค้า"]));
                            const existingItemSnapshot = await getDocs(existingItemQuery); // Use getDocs for query

                            let itemDocRef;
                            if (existingItemSnapshot.empty) {
                                itemDocRef = doc(itemsCollectionRef);
                                batch.set(itemDocRef, {
                                    name: record["ชื่อสินค้า"],
                                    unit: record["หน่วยนับ"],
                                    minStock: 0,
                                });
                            } else {
                                itemDocRef = existingItemSnapshot.docs[0].ref;
                                if (existingItemSnapshot.docs[0].data().unit !== record["หน่วยนับ"]) {
                                    batch.update(itemDocRef, { unit: record["หน่วยนับ"] });
                                }
                            }

                            // 2. Add transaction
                            const newTransactionRef = doc(transactionsCollectionRef);
                            batch.set(newTransactionRef, {
                                date: recordDate,
                                itemName: record["ชื่อสินค้า"],
                                unit: record["หน่วยนับ"],
                                quantity: recordQuantity,
                                type: 'receive',
                                poNumber: record["เลขที่ PO"] || '',
                                ivNumber: record["เลขที่ IV"],
                                userId: userId,
                            });
                            successCount++;
                        } catch (error) {
                            errorCount++;
                            errors.push(`แถว: ${record["ชื่อสินค้า"]} (IV: ${record["เลขที่ IV"]}) - ${error.message}`);
                            console.error("Error processing record:", record, error);
                        }
                    }

                    try {
                        await batch.commit();
                        if (errors.length > 0) {
                            setMessage(`อัปโหลดเสร็จสิ้น. สำเร็จ ${successCount} รายการ, ผิดพลาด ${errorCount} รายการ: ${errors.join('; ')}`);
                            setMessageType('warning');
                        } else {
                            setMessage(`อัปโหลดสำเร็จ ${successCount} รายการ!`);
                            setMessageType('success');
                        }
                    } catch (batchError) {
                        console.error("Batch commit failed:", batchError);
                        setMessage(`เกิดข้อผิดพลาดในการบันทึกข้อมูลที่อัปโหลด: ${batchError.message}`);
                        setMessageType('error');
                    } finally {
                        setIsLoading(false);
                        if (fileInputRef.current) {
                            fileInputRef.current.value = ''; // Clear file input
                        }
                    }
                };
                reader.onerror = () => {
                    setMessage('ไม่สามารถอ่านไฟล์ได้.');
                    setMessageType('error');
                    setIsLoading(false);
                };
                reader.readAsText(file);
            };

            // Filter recent transactions based on search term
            const filteredRecentTransactions = recentTransactions.filter(transaction =>
                transaction.itemName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                transaction.unit.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (transaction.poNumber && transaction.poNumber.toLowerCase().includes(searchTerm.toLowerCase())) ||
                transaction.ivNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
                formatDate(transaction.date).toLowerCase().includes(searchTerm.toLowerCase())
            );

            // Get current items for pagination
            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentItems = filteredRecentTransactions.slice(indexOfFirstItem, indexOfLastItem);

            const handlePageChange = (pageNumber) => setCurrentPage(pageNumber);

            return React.createElement(
                'div',
                { className: 'bg-white p-8 rounded-2xl shadow-lg border border-gray-100 mb-8' },
                React.createElement('h2', { className: 'text-3xl font-bold text-gray-800 mb-6 border-b pb-4' }, 'เมนูรับเข้าสินค้า'),
                React.createElement(MessageDisplay, { message: message, type: messageType, onClose: () => setMessage('') }),
                React.createElement(
                    'form',
                    { onSubmit: handleSubmit, className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'receiveDate', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'วันที่:'),
                        React.createElement('input', {
                            type: 'date',
                            id: 'receiveDate',
                            value: date,
                            onChange: (e) => setDate(e.target.value),
                            className: 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-400 focus:border-transparent sm:text-base',
                            required: true,
                        }),
                        // Display formatted date for user
                        date && React.createElement('p', { className: 'text-xs text-gray-500 mt-1' }, 'รูปแบบที่แสดงในรายงาน: ', formatDate(new Date(date)))
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'itemName', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'ชื่อสินค้า:'),
                        React.createElement('input', {
                            list: 'item-names',
                            id: 'itemName',
                            value: itemName,
                            onChange: handleItemNameChange,
                            className: `mt-1 block w-full px-4 py-2 border ${itemNameError ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-blue-400 focus:border-transparent sm:text-base`,
                            placeholder: 'เลือกหรือพิมพ์ชื่อสินค้า',
                            required: true,
                        }),
                        React.createElement(
                            'datalist',
                            { id: 'item-names' },
                            items.map(item => React.createElement('option', { key: item.id, value: item.name }))
                        ),
                        itemNameError && React.createElement('p', { className: 'text-red-500 text-xs mt-1' }, itemNameError)
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'unit', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'หน่วยนับ:'),
                        React.createElement('input', {
                            type: 'text',
                            id: 'unit',
                            value: unit,
                            onChange: handleUnitChange,
                            className: `mt-1 block w-full px-4 py-2 border ${unitError ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-blue-400 focus:border-transparent sm:text-base`,
                            placeholder: 'เช่น ชิ้น, กล่อง, กิโลกรัม',
                            required: true,
                        }),
                        unitError && React.createElement('p', { className: 'text-red-500 text-xs mt-1' }, unitError)
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'quantity', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'จำนวนรับเข้า:'),
                        React.createElement('input', {
                            type: 'number',
                            id: 'quantity',
                            value: quantity,
                            onChange: handleQuantityChange,
                            className: `mt-1 block w-full px-4 py-2 border ${quantityError ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-blue-400 focus:border-transparent sm:text-base`,
                            min: '1',
                            required: true,
                        }),
                        quantityError && React.createElement('p', { className: 'text-red-500 text-xs mt-1' }, quantityError)
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'poNumber', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'เลขที่ PO (ถ้ามี):'),
                        React.createElement('input', {
                            type: 'text',
                            id: 'poNumber',
                            value: poNumber,
                            onChange: (e) => setPoNumber(e.target.value),
                            className: 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-400 focus:border-transparent sm:text-base',
                        })
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'ivNumber', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'เลขที่ IV:'),
                        React.createElement('input', {
                            type: 'text',
                            id: 'ivNumber',
                            value: ivNumber,
                            onChange: (e) => handleIvNumberChange(e),
                            className: `mt-1 block w-full px-4 py-2 border ${ivNumberError ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-blue-400 focus:border-transparent sm:text-base`,
                            required: true,
                        }),
                        ivNumberError && React.createElement('p', { className: 'text-red-500 text-xs mt-1' }, ivNumberError)
                    ),
                    React.createElement(
                        'div',
                        { className: 'md:col-span-2 flex justify-end items-center mt-4' },
                        React.createElement(
                            'button',
                            {
                                type: 'submit',
                                className: 'px-8 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105',
                                disabled: isLoading,
                            },
                            isLoading ? 'กำลังบันทึก...' : 'บันทึกรับเข้า'
                        )
                    )
                ),
                React.createElement(
                    'div',
                    { className: 'mt-8 p-6 border border-gray-200 rounded-xl shadow-sm bg-gray-50' },
                    React.createElement('h3', { className: 'text-2xl font-bold text-gray-700 mb-4' }, 'อัปโหลดไฟล์ CSV (รับเข้าสินค้า)'),
                    React.createElement('p', { className: 'text-sm text-gray-600 mb-4' }, 'ไฟล์ CSV ควรมีหัวข้อ (headers) ดังนี้: ', React.createElement('code', { className: 'font-mono bg-gray-200 p-1 rounded' }, 'วันที่,ชื่อสินค้า,หน่วยนับ,จำนวน,เลขที่ PO,เลขที่ IV')),
                    React.createElement('input', {
                        type: 'file',
                        accept: '.csv',
                        onChange: handleFileUpload,
                        className: 'block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer',
                        ref: fileInputRef,
                        disabled: isLoading,
                    }),
                    isLoading && React.createElement('p', { className: 'text-blue-600 text-sm mt-2' }, 'กำลังอัปโหลดและประมวลผล...')
                ),
                React.createElement('h3', { className: 'text-2xl font-bold text-gray-800 mt-12 mb-6 border-b pb-4' }, 'รายการรับเข้าล่าสุด'),
                React.createElement(
                    'div',
                    { className: 'flex flex-col sm:flex-row justify-between items-center mb-6 gap-4' },
                    React.createElement('input', {
                        type: 'text',
                        placeholder: 'ค้นหารายการรับเข้า...',
                        value: searchTerm,
                        onChange: (e) => setSearchTerm(e.target.value),
                        className: 'w-full sm:w-auto flex-grow px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-400 focus:border-transparent sm:text-base',
                    }),
                    React.createElement(
                        'button',
                        {
                            onClick: handleExportCSV,
                            className: 'px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed',
                            disabled: isLoading || filteredRecentTransactions.length === 0,
                        },
                        'ส่งออกเป็น CSV'
                    )
                ),
                isLoading ? (
                    React.createElement('div', { className: 'text-center text-gray-600 py-8' }, 'กำลังโหลดรายการ...')
                ) : filteredRecentTransactions.length === 0 ? (
                    React.createElement('p', { className: 'text-gray-600 py-8 text-center' }, 'ไม่พบรายการรับเข้าที่ตรงกับคำค้นหา.')
                ) : (
                    React.createElement(
                        'div',
                        { className: 'overflow-x-auto rounded-xl shadow-md border border-gray-200' },
                        React.createElement(
                            'table',
                            { className: 'min-w-full divide-y divide-gray-200' },
                            React.createElement(
                                'thead',
                                { className: 'bg-blue-50' },
                                React.createElement(
                                    'tr',
                                    null,
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'วันที่'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'ชื่อสินค้า'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'หน่วยนับ'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'จำนวน'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'เลขที่ PO'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'เลขที่ IV'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'การดำเนินการ')
                                )
                            ),
                            React.createElement(
                                'tbody',
                                { className: 'bg-white divide-y divide-gray-200' },
                                currentItems.map((transaction) =>
                                    React.createElement(
                                        'tr',
                                        { key: transaction.id, className: 'hover:bg-gray-50' },
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, formatDate(transaction.date)),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, transaction.itemName),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, transaction.unit),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, transaction.quantity),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, transaction.poNumber || '-'),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, transaction.ivNumber),
                                        React.createElement(
                                            'td',
                                            { className: 'px-6 py-4 whitespace-nowrap text-sm' },
                                            React.createElement(
                                                'button',
                                                {
                                                    onClick: () => confirmDeleteTransaction(transaction),
                                                    className: 'text-red-600 hover:text-red-900 disabled:opacity-50 disabled:cursor-not-allowed font-medium',
                                                    disabled: isLoading,
                                                },
                                                'ลบ'
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    )
                ),
                React.createElement(Pagination, {
                    totalItems: filteredRecentTransactions.length,
                    itemsPerPage: itemsPerPage,
                    currentPage: currentPage,
                    onPageChange: handlePageChange,
                }),
                /* Confirmation Modal for Receive Items */
                React.createElement(ConfirmationModal, {
                    isOpen: showConfirmModal,
                    title: 'ยืนยันการลบรายการรับเข้า',
                    message: `คุณแน่ใจหรือไม่ที่จะลบรายการรับเข้าของ "${transactionToDelete?.itemName}" จำนวน ${transactionToDelete?.quantity} ${transactionToDelete?.unit} (เลขที่ IV: ${transactionToDelete?.ivNumber})? การดำเนินการนี้ไม่สามารถย้อนกลับได้.`,
                    onConfirm: handleDeleteTransaction,
                    onCancel: cancelDelete,
                })
            );
        }

        // --- Issue Items Component ---
        function IssueItems() {
            const { db, userId, publicDataPath } = useContext(FirebaseContext);
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [itemName, setItemName] = useState('');
            const [unit, setUnit] = useState('');
            const [quantity, setQuantity] = useState('');
            const [ivNumber, setIvNumber] = useState('');
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');
            const [items, setItems] = useState([]); // List of existing items for dropdown
            const [recentTransactions, setRecentTransactions] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [currentAvailableStock, setCurrentAvailableStock] = useState(null);
            const fileInputRef = useRef(null); // Ref for file input

            // Pagination states
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 10;

            // Confirmation Modal states
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [transactionToDelete, setTransactionToDelete] = useState(null);

            // Validation states
            const [itemNameError, setItemNameError] = useState('');
            const [unitError, setUnitError] = useState('');
            const [quantityError, setQuantityError] = useState('');
            const [ivNumberError, setIvNumberError] = useState('');

            const itemsCollectionRef = collection(db, `${publicDataPath}/items`);
            const transactionsCollectionRef = collection(db, `${publicDataPath}/transactions`);

            // Fetch existing items for dropdown and recent transactions
            useEffect(() => {
                if (!db || !userId) return;
                setIsLoading(true);

                // Fetch items
                const unsubscribeItems = onSnapshot(itemsCollectionRef, (snapshot) => {
                    const itemsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setItems(itemsData);
                }, (error) => {
                    console.error("Error fetching items:", error);
                    setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลสินค้า.");
                    setMessageType('error');
                });

                // Fetch recent issue transactions
                const q = query(transactionsCollectionRef, where('type', '==', 'issue'));
                const unsubscribeTransactions = onSnapshot(q, (snapshot) => {
                    const transactionsData = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => b.date.toDate() - a.date.toDate()); // Sort in JavaScript
                    setRecentTransactions(transactionsData);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching recent transactions:", error);
                    setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลการจ่ายออกล่าสุด.");
                    setMessageType('error');
                    setIsLoading(false);
                });

                return () => {
                    unsubscribeItems();
                    unsubscribeTransactions();
                };
            }, [db, userId, publicDataPath]);

            // Effect to update currentAvailableStock when itemName changes
            useEffect(() => {
                const fetchCurrentStock = async () => {
                    if (!db || !itemName) {
                        setCurrentAvailableStock(null);
                        return;
                    }

                    try {
                        const transactionsForItemQuery = query(transactionsCollectionRef, where('itemName', '==', itemName));
                        const transactionsForItemSnapshot = await getDocs(transactionsForItemQuery);
                        let stock = 0;
                        transactionsForItemSnapshot.docs.forEach(doc => {
                            stock += doc.data().quantity;
                        });
                        setCurrentAvailableStock(stock);
                    } catch (error) {
                        console.error("Error fetching current stock:", error);
                        setCurrentAvailableStock(null);
                    }
                };
                fetchCurrentStock();
            }, [itemName, db, transactionsCollectionRef]);


            const handleItemNameChange = (e) => {
                const selectedName = e.target.value;
                setItemName(selectedName);
                const selectedItem = items.find(item => item.name === selectedName);
                if (selectedItem) {
                    setUnit(selectedItem.unit || '');
                    e.target.form.elements.unitIssue.readOnly = true;
                } else {
                    setUnit(''); // Clear unit if a new item name is typed
                    e.target.form.elements.unitIssue.readOnly = false;
                }
                setItemNameError('');
            };

            const handleUnitChange = (e) => {
                setUnit(e.target.value);
                setUnitError('');
            };

            const handleQuantityChange = (e) => {
                setQuantity(e.target.value);
                setQuantityError('');
            };

            const handleIvNumberChange = (e) => {
                setIvNumber(e.target.value);
                setIvNumberError('');
            };

            const validateForm = () => {
                let isValid = true;
                if (!itemName) {
                    setItemNameError('กรุณาเลือกชื่อสินค้า');
                    isValid = false;
                } else {
                    setItemNameError('');
                }
                if (!unit) {
                    setUnitError('กรุณากรอกหน่วยนับ');
                    isValid = false;
                } else {
                    setUnitError('');
                }
                const parsedQuantity = parseFloat(quantity);
                if (isNaN(parsedQuantity) || parsedQuantity <= 0) {
                    setQuantityError('จำนวนจ่ายออกต้องเป็นตัวเลขและมากกว่า 0');
                    isValid = false;
                } else if (currentAvailableStock !== null && parsedQuantity > currentAvailableStock) {
                    setQuantityError(`จำนวนจ่ายออกเกินสต็อกที่มี. คงเหลือ: ${currentAvailableStock} ${unit}.`);
                    isValid = false;
                }
                else {
                    setQuantityError('');
                }
                if (!ivNumber) {
                    setIvNumberError('กรุณากรอกเลขที่ IV');
                    isValid = false;
                } else {
                    setIvNumberError('');
                }
                return isValid;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setMessage('');
                setMessageType('');

                if (!validateForm()) {
                    return;
                }

                setIsLoading(true);
                try {
                    await runTransaction(db, async (transaction) => {
                        // 1. Check if item exists in master data (read within transaction)
                        const existingItemQuery = query(itemsCollectionRef, where('name', '==', itemName));
                        const existingItemSnapshot = await transaction.get(existingItemQuery);

                        if (existingItemSnapshot.empty) {
                            throw new Error(`สินค้าชื่อ "${itemName}" ไม่มีอยู่ในระบบ กรุณารับเข้าสินค้าก่อน.`);
                        }

                        // 2. Calculate current stock (read all relevant transactions within transaction)
                        const transactionsForItemQuery = query(transactionsCollectionRef, where('itemName', '==', itemName));
                        const transactionsForItemSnapshot = await transaction.get(transactionsForItemQuery);
                        let currentStock = 0;
                        transactionsForItemSnapshot.docs.forEach(doc => {
                            currentStock += doc.data().quantity;
                        });

                        const quantityToIssue = parseFloat(quantity);
                        if (quantityToIssue > currentStock) {
                            throw new Error(`สินค้า "${itemName}" มีในสต็อกไม่เพียงพอ. คงเหลือ: ${currentStock} ${unit}.`);
                        }

                        // 3. Add transaction (write within transaction)
                        const newTransactionRef = doc(transactionsCollectionRef); // Firestore will auto-generate ID
                        transaction.set(newTransactionRef, {
                            date: new Date(date),
                            itemName: itemName,
                            unit: unit,
                            quantity: -quantityToIssue, // Negative for issue
                            type: 'issue',
                            poNumber: '', // PO Number is not applicable for issue
                            ivNumber: ivNumber,
                            userId: userId,
                        });
                    });

                    setMessage('บันทึกการจ่ายออกสินค้าเรียบร้อยแล้ว!');
                    setMessageType('success');
                    // Clear form
                    setItemName('');
                    setUnit('');
                    setQuantity('');
                    setIvNumber('');
                    setDate(new Date().toISOString().split('T')[0]); // Reset date to today
                    setCurrentAvailableStock(null); // Clear stock display
                    // Clear validation errors
                    setItemNameError('');
                    setUnitError('');
                    setQuantityError('');
                    setIvNumberError('');
                    setCurrentPage(1); // Reset to first page after successful submission
                } catch (e) {
                    console.error("Error adding document: ", e);
                    setMessage('เกิดข้อผิดพลาดในการบันทึกข้อมูล: ' + e.message);
                    setMessageType('error');
                } finally {
                    setIsLoading(false);
                }
            };

            const confirmDeleteTransaction = (transaction) => {
                setTransactionToDelete(transaction);
                setShowConfirmModal(true);
            };

            const handleDeleteTransaction = async () => {
                if (!transactionToDelete) return;

                setMessage('');
                setMessageType('');
                setIsLoading(true);
                setShowConfirmModal(false); // Close the modal immediately

                try {
                    await runTransaction(db, async (transaction) => {
                        const transactionRef = doc(transactionsCollectionRef, transactionToDelete.id);
                        transaction.delete(transactionRef);
                    });
                    setMessage('ลบรายการจ่ายออกเรียบร้อยแล้ว!');
                    setMessageType('success');
                } catch (e) {
                    console.error("Error deleting transaction:", e);
                    setMessage('เกิดข้อผิดพลาดในการลบรายการ: ' + e.message);
                    setMessageType('error');
                } finally {
                    setIsLoading(false);
                    setTransactionToDelete(null);
                }
            };

            const cancelDelete = () => {
                setShowConfirmModal(false);
                setTransactionToDelete(null);
            };

            const handleExportCSV = () => {
                let csvContent = "\uFEFF" + "วันที่,ชื่อสินค้า,หน่วยนับ,จำนวน,เลขที่ IV\n";
                filteredRecentTransactions.forEach(transaction => {
                    const dateFormatted = formatDate(transaction.date);
                    csvContent += `"${dateFormatted}","${transaction.itemName}","${transaction.unit}",${Math.abs(transaction.quantity)},"${transaction.ivNumber}"\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `รายการจ่ายออก_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                if (file.type !== 'text/csv') {
                    setMessage('กรุณาอัปโหลดไฟล์ CSV เท่านั้น.');
                    setMessageType('error');
                    return;
                }

                setIsLoading(true);
                setMessage('');
                setMessageType('');

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(line => line.trim() !== '');
                    if (lines.length === 0) {
                        setMessage('ไฟล์ CSV ว่างเปล่า.');
                        setMessageType('error');
                        setIsLoading(false);
                        return;
                    }

                    const headers = lines[0].split(',').map(h => h.trim());
                    const expectedHeaders = ["วันที่", "ชื่อสินค้า", "หน่วยนับ", "จำนวน", "เลขที่ IV"];

                    // Basic header validation
                    if (!expectedHeaders.every(h => headers.includes(h))) {
                        setMessage(`โครงสร้างไฟล์ CSV ไม่ถูกต้อง. ต้องมีคอลัมน์: ${expectedHeaders.join(', ')}`);
                        setMessageType('error');
                        setIsLoading(false);
                        return;
                    }

                    const records = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',');
                        if (values.length !== headers.length) {
                            console.warn(`Skipping malformed row ${i + 1}: ${lines[i]}`);
                            continue; // Skip malformed rows
                        }
                        const record = {};
                        headers.forEach((header, index) => {
                            record[header] = values[index].trim();
                        });
                        records.push(record);
                    }

                    if (records.length === 0) {
                        setMessage('ไม่พบข้อมูลที่ถูกต้องในไฟล์ CSV.');
                        setMessageType('error');
                        setIsLoading(false);
                        return;
                    }

                    const batch = writeBatch(db);
                    let successCount = 0;
                    let errorCount = 0;
                    const errors = [];

                    for (const record of records) {
                        try {
                            const recordDate = new Date(record["วันที่"]);
                            const recordQuantity = parseFloat(record["จำนวน"]);

                            if (isNaN(recordDate.getTime())) {
                                throw new Error(`วันที่ไม่ถูกต้อง: ${record["วันที่"]}`);
                            }
                            if (isNaN(recordQuantity) || recordQuantity <= 0) {
                                throw new Error(`จำนวนไม่ถูกต้อง: ${record["จำนวน"]}`);
                            }
                            if (!record["ชื่อสินค้า"] || !record["หน่วยนับ"] || !record["เลขที่ IV"]) {
                                throw new Error(`ข้อมูลไม่ครบถ้วน (ชื่อสินค้า, หน่วยนับ, เลขที่ IV)`);
                            }

                            // 1. Check if item exists in master data (important for issue)
                            const existingItemQuery = query(itemsCollectionRef, where('name', '==', record["ชื่อสินค้า"]));
                            const existingItemSnapshot = await getDocs(existingItemQuery);

                            if (existingItemSnapshot.empty) {
                                throw new Error(`สินค้า "${record["ชื่อสินค้า"]}" ไม่มีอยู่ในระบบ ไม่สามารถจ่ายออกได้.`);
                            }

                            // 2. Add transaction (quantity is negative for issue)
                            const newTransactionRef = doc(transactionsCollectionRef);
                            batch.set(newTransactionRef, {
                                date: recordDate,
                                itemName: record["ชื่อสินค้า"],
                                unit: record["หน่วยนับ"],
                                quantity: -recordQuantity, // Negative for issue
                                type: 'issue',
                                poNumber: '', // Not applicable for issue
                                ivNumber: record["เลขที่ IV"],
                                userId: userId,
                            });
                            successCount++;
                        } catch (error) {
                            errorCount++;
                            errors.push(`แถว: ${record["ชื่อสินค้า"]} (IV: ${record["เลขที่ IV"]}) - ${error.message}`);
                            console.error("Error processing record:", record, error);
                        }
                    }

                    try {
                        await batch.commit();
                        if (errors.length > 0) {
                            setMessage(`อัปโหลดเสร็จสิ้น. สำเร็จ ${successCount} รายการ, ผิดพลาด ${errorCount} รายการ: ${errors.join('; ')}`);
                            setMessageType('warning');
                        } else {
                            setMessage(`อัปโหลดสำเร็จ ${successCount} รายการ!`);
                            setMessageType('success');
                        }
                    } catch (batchError) {
                        console.error("Batch commit failed:", batchError);
                        setMessage(`เกิดข้อผิดพลาดในการบันทึกข้อมูลที่อัปโหลด: ${batchError.message}`);
                        setMessageType('error');
                    } finally {
                        setIsLoading(false);
                        if (fileInputRef.current) {
                            fileInputRef.current.value = ''; // Clear file input
                        }
                    }
                };
                reader.onerror = () => {
                    setMessage('ไม่สามารถอ่านไฟล์ได้.');
                    setMessageType('error');
                    setIsLoading(false);
                };
                reader.readAsText(file);
            };


            // Filter recent transactions based on search term
            const filteredRecentTransactions = recentTransactions.filter(transaction =>
                transaction.itemName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                transaction.unit.toLowerCase().includes(searchTerm.toLowerCase()) ||
                transaction.ivNumber.toLowerCase().includes(searchTerm.toLowerCase()) ||
                formatDate(transaction.date).toLowerCase().includes(searchTerm.toLowerCase())
            );

            // Get current items for pagination
            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentItems = filteredRecentTransactions.slice(indexOfFirstItem, indexOfLastItem);

            const handlePageChange = (pageNumber) => setCurrentPage(pageNumber);

            return React.createElement(
                'div',
                { className: 'bg-white p-8 rounded-2xl shadow-lg border border-gray-100 mb-8' },
                React.createElement('h2', { className: 'text-3xl font-bold text-gray-800 mb-6 border-b pb-4' }, 'เมนูจ่ายออกสินค้า'),
                React.createElement(MessageDisplay, { message: message, type: messageType, onClose: () => setMessage('') }),
                React.createElement(
                    'form',
                    { onSubmit: handleSubmit, className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'issueDate', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'วันที่:'),
                        React.createElement('input', {
                            type: 'date',
                            id: 'issueDate',
                            value: date,
                            onChange: (e) => setDate(e.target.value),
                            className: 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-400 focus:border-transparent sm:text-base',
                            required: true,
                        }),
                        // Display formatted date for user
                        date && React.createElement('p', { className: 'text-xs text-gray-500 mt-1' }, 'รูปแบบที่แสดงในรายงาน: ', formatDate(new Date(date)))
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'itemNameIssue', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'ชื่อสินค้า:'),
                        React.createElement('input', {
                            list: 'item-names-issue',
                            id: 'itemNameIssue',
                            value: itemName,
                            onChange: handleItemNameChange,
                            className: `mt-1 block w-full px-4 py-2 border ${itemNameError ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-blue-400 focus:border-transparent sm:text-base`,
                            placeholder: 'เลือกชื่อสินค้า',
                            required: true,
                        }),
                        React.createElement(
                            'datalist',
                            { id: 'item-names-issue' },
                            items.map(item => React.createElement('option', { key: item.id, value: item.name }))
                        ),
                        itemNameError && React.createElement('p', { className: 'text-red-500 text-xs mt-1' }, itemNameError)
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'unitIssue', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'หน่วยนับ:'),
                        React.createElement('input', {
                            type: 'text',
                            id: 'unitIssue',
                            value: unit,
                            onChange: handleUnitChange,
                            className: `mt-1 block w-full px-4 py-2 border ${unitError ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-blue-400 focus:border-transparent sm:text-base`,
                            placeholder: 'เช่น ชิ้น, กล่อง',
                            required: true,
                            readOnly: true, // Unit should be read-only if selected from existing items
                        }),
                        unitError && React.createElement('p', { className: 'text-red-500 text-xs mt-1' }, unitError)
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'quantityIssue', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'จำนวนจ่ายออก:'),
                        React.createElement('input', {
                            type: 'number',
                            id: 'quantityIssue',
                            value: quantity,
                            onChange: handleQuantityChange,
                            className: `mt-1 block w-full px-4 py-2 border ${quantityError ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-blue-400 focus:border-transparent sm:text-base`,
                            min: '1',
                            required: true,
                        }),
                        currentAvailableStock !== null && React.createElement('p', { className: 'text-xs text-gray-600 mt-1' }, 'สต็อกปัจจุบัน: ', currentAvailableStock, ' ', unit),
                        quantityError && React.createElement('p', { className: 'text-red-500 text-xs mt-1' }, quantityError)
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'ivNumberIssue', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'เลขที่ IV:'),
                        React.createElement('input', {
                            type: 'text',
                            id: 'ivNumberIssue',
                            value: ivNumber,
                            onChange: handleIvNumberChange,
                            className: `mt-1 block w-full px-4 py-2 border ${ivNumberError ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-blue-400 focus:border-transparent sm:text-base`,
                            required: true,
                        }),
                        ivNumberError && React.createElement('p', { className: 'text-red-500 text-xs mt-1' }, ivNumberError)
                    ),
                    React.createElement(
                        'div',
                        { className: 'md:col-span-2 flex justify-end items-center mt-4' },
                        React.createElement(
                            'button',
                            {
                                type: 'submit',
                                className: 'px-8 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105',
                                disabled: isLoading,
                            },
                            isLoading ? 'กำลังบันทึก...' : 'บันทึกจ่ายออก'
                        )
                    )
                ),
                React.createElement(
                    'div',
                    { className: 'mt-8 p-6 border border-gray-200 rounded-xl shadow-sm bg-gray-50' },
                    React.createElement('h3', { className: 'text-2xl font-bold text-gray-700 mb-4' }, 'อัปโหลดไฟล์ CSV (จ่ายออกสินค้า)'),
                    React.createElement('p', { className: 'text-sm text-gray-600 mb-4' }, 'ไฟล์ CSV ควรมีหัวข้อ (headers) ดังนี้: ', React.createElement('code', { className: 'font-mono bg-gray-200 p-1 rounded' }, 'วันที่,ชื่อสินค้า,หน่วยนับ,จำนวน,เลขที่ IV')),
                    React.createElement('input', {
                        type: 'file',
                        accept: '.csv',
                        onChange: handleFileUpload,
                        className: 'block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor:pointer',
                        ref: fileInputRef,
                        disabled: isLoading,
                    }),
                    isLoading && React.createElement('p', { className: 'text-blue-600 text-sm mt-2' }, 'กำลังอัปโหลดและประมวลผล...')
                ),
                React.createElement('h3', { className: 'text-2xl font-bold text-gray-800 mt-12 mb-6 border-b pb-4' }, 'รายการจ่ายออกล่าสุด'),
                React.createElement(
                    'div',
                    { className: 'flex flex-col sm:flex-row justify-between items-center mb-6 gap-4' },
                    React.createElement('input', {
                        type: 'text',
                        placeholder: 'ค้นหารายการจ่ายออก...',
                        value: searchTerm,
                        onChange: (e) => setSearchTerm(e.target.value),
                        className: 'w-full sm:w-auto flex-grow px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-400 focus:border-transparent sm:text-base',
                    }),
                    React.createElement(
                        'button',
                        {
                            onClick: handleExportCSV,
                            className: 'px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed',
                            disabled: isLoading || filteredRecentTransactions.length === 0,
                        },
                        'ส่งออกเป็น CSV'
                    )
                ),
                isLoading ? (
                    React.createElement('div', { className: 'text-center text-gray-600 py-8' }, 'กำลังโหลดรายการ...')
                ) : filteredRecentTransactions.length === 0 ? (
                    React.createElement('p', { className: 'text-gray-600 py-8 text-center' }, 'ไม่พบรายการจ่ายออกที่ตรงกับคำค้นหา.')
                ) : (
                    React.createElement(
                        'div',
                        { className: 'overflow-x-auto rounded-xl shadow-md border border-gray-200' },
                        React.createElement(
                            'table',
                            { className: 'min-w-full divide-y divide-gray-200' },
                            React.createElement(
                                'thead',
                                { className: 'bg-blue-50' },
                                React.createElement(
                                    'tr',
                                    null,
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'วันที่'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'ชื่อสินค้า'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'หน่วยนับ'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'จำนวน'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'เลขที่ IV'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'การดำเนินการ')
                                )
                            ),
                            React.createElement(
                                'tbody',
                                { className: 'bg-white divide-y divide-gray-200' },
                                currentItems.map((transaction) =>
                                    React.createElement(
                                        'tr',
                                        { key: transaction.id, className: 'hover:bg-gray-50' },
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, formatDate(transaction.date)),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, transaction.itemName),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, transaction.unit),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, Math.abs(transaction.quantity)),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, transaction.ivNumber),
                                        React.createElement(
                                            'td',
                                            { className: 'px-6 py-4 whitespace-nowrap text-sm' },
                                            React.createElement(
                                                'button',
                                                {
                                                    onClick: () => confirmDeleteTransaction(transaction),
                                                    className: 'text-red-600 hover:text-red-900 disabled:opacity-50 disabled:cursor-not-allowed font-medium',
                                                    disabled: isLoading,
                                                },
                                                'ลบ'
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    )
                ),
                React.createElement(Pagination, {
                    totalItems: filteredRecentTransactions.length,
                    itemsPerPage: itemsPerPage,
                    currentPage: currentPage,
                    onPageChange: handlePageChange,
                }),
                /* Confirmation Modal for Issue Items */
                React.createElement(ConfirmationModal, {
                    isOpen: showConfirmModal,
                    title: 'ยืนยันการลบรายการจ่ายออก',
                    message: `คุณแน่ใจหรือไม่ที่จะลบรายการจ่ายออกของ "${transactionToDelete?.itemName}" จำนวน ${Math.abs(transactionToDelete?.quantity)} ${transactionToDelete?.unit} (เลขที่ IV: ${transactionToDelete?.ivNumber})? การดำเนินการนี้ไม่สามารถย้อนกลับได้.`,
                    onConfirm: handleDeleteTransaction,
                    onCancel: cancelDelete,
                })
            );
        }

        // --- Stock Balance Component ---
        function StockBalance() {
            const { db, userId, publicDataPath } = useContext(FirebaseContext);
            const [stockItems, setStockItems] = useState([]);
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [sortColumn, setSortColumn] = useState('name'); // Default sort column
            const [sortDirection, setSortDirection] = useState('asc'); // 'asc' or 'desc'

            const itemsCollectionRef = collection(db, `${publicDataPath}/items`);
            const transactionsCollectionRef = collection(db, `${publicDataPath}/transactions`);

            // Function to calculate stock and reorder status
            const calculateStock = useCallback(async (itemsData, transactionsData) => {
                const stockMap = new Map();

                // Initialize stock with item master data
                itemsData.forEach(item => {
                    stockMap.set(item.name, {
                        name: item.name,
                        unit: item.unit,
                        currentStock: 0,
                        minStock: item.minStock || 0,
                        status: 'ปกติ',
                        id: item.id, // Keep item ID for updating minStock
                    });
                });

                // Apply transactions to calculate current stock
                transactionsData.forEach(transaction => {
                    if (stockMap.has(transaction.itemName)) {
                        const current = stockMap.get(transaction.itemName);
                        current.currentStock += transaction.quantity;
                        stockMap.set(transaction.itemName, current);
                    } else {
                        // If a transaction exists for an item not in master, add it
                        stockMap.set(transaction.itemName, {
                            name: transaction.itemName,
                            unit: transaction.unit,
                            currentStock: transaction.quantity,
                            minStock: 0, // Default min stock for items only in transactions
                            status: 'ปกติ',
                            id: null, // No item master ID
                        });
                    }
                });

                // Determine reorder status
                const calculatedStock = Array.from(stockMap.values()).map(item => {
                    item.status = item.currentStock < item.minStock ? 'ต้องเติม' : 'ปกติ';
                    return item;
                });

                setStockItems(calculatedStock); // Set unsorted, then sort in render logic
            }, []);

            // Fetch data for stock balance
            useEffect(() => {
                if (!db || !userId) return;
                setIsLoading(true);

                let unsubscribeItems;
                let unsubscribeTransactions;

                const fetchData = async () => {
                    try {
                        // Fetch all items
                        unsubscribeItems = onSnapshot(itemsCollectionRef, (itemSnapshot) => {
                            const itemsData = itemSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                            // Fetch all transactions
                            unsubscribeTransactions = onSnapshot(transactionsCollectionRef, (transactionSnapshot) => {
                                const transactionsData = transactionSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                calculateStock(itemsData, transactionsData);
                                setIsLoading(false);
                            }, (error) => {
                                console.error("Error fetching transactions for stock:", error);
                                setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลการเคลื่อนไหวสินค้า.");
                                setMessageType('error');
                                setIsLoading(false);
                            });
                        }, (error) => {
                            console.error("Error fetching items for stock:", error);
                            setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลสินค้า.");
                            setMessageType('error');
                            setIsLoading(false);
                        });

                    } catch (e) {
                        console.error("Error fetching stock data:", e);
                        setMessage("เกิดข้อผิดพลาดในการโหลดข้อมูลสินค้าคงเหลือ.");
                        setMessageType('error');
                        setIsLoading(false);
                    }
                };

                fetchData();

                return () => {
                    if (unsubscribeItems) unsubscribeItems();
                    if (unsubscribeTransactions) unsubscribeTransactions();
                };
            }, [db, userId, publicDataPath, calculateStock]);

            const handleMinStockChange = async (itemId, newMinStock) => {
                if (!db || !itemId) return;
                setMessage('');
                setMessageType('');

                if (isNaN(newMinStock) || parseFloat(newMinStock) < 0) {
                    setMessage('จำนวนขั้นต่ำต้องเป็นตัวเลขและไม่ติดลบ.');
                    setMessageType('error');
                    return;
                }

                try {
                    const itemDocRef = doc(db, `${publicDataPath}/items`, itemId);
                    await updateDoc(itemDocRef, { minStock: parseFloat(newMinStock) });
                    setMessage('อัปเดตจำนวนขั้นต่ำเรียบร้อยแล้ว!');
                    setMessageType('success');
                } catch (e) {
                    console.error("Error updating min stock:", e);
                    setMessage('เกิดข้อผิดพลาดในการอัปเดตจำนวนขั้นต่ำ: ' + e.message);
                    setMessageType('error');
                }
            };

            const handleSort = (column) => {
                if (sortColumn === column) {
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortColumn(column);
                    setSortDirection('asc');
                }
            };

            // Filter and sort the stock items
            const sortedAndFilteredStockItems = useMemo(() => {
                let currentItems = [...stockItems];

                // Filter
                currentItems = currentItems.filter(item =>
                    item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    item.unit.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    item.status.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    item.currentStock.toString().includes(searchTerm.toLowerCase()) ||
                    item.minStock.toString().includes(searchTerm.toLowerCase())
                );

                // Sort
                currentItems.sort((a, b) => {
                    let valA, valB;
                    if (sortColumn === 'name' || sortColumn === 'unit' || sortColumn === 'status') {
                        valA = a[sortColumn].toLowerCase();
                        valB = b[sortColumn].toLowerCase();
                    } else if (sortColumn === 'currentStock' || sortColumn === 'minStock') {
                        valA = a[sortColumn];
                        valB = b[sortColumn];
                    }

                    if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                    if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });

                return currentItems;
            }, [stockItems, searchTerm, sortColumn, sortDirection]);

            // Function to add sample data if collections are empty
            const addSampleData = async () => {
                if (!db || !userId) return;
                setMessage('');
                setMessageType('');
                setIsLoading(true);

                try {
                    const itemsSnapshot = await getDocs(itemsCollectionRef);
                    const transactionsSnapshot = await getDocs(transactionsCollectionRef);

                    if (itemsSnapshot.empty && transactionsSnapshot.empty) {
                        const batch = writeBatch(db);

                        // Sample Items
                        const sampleItems = [
                            { name: 'ปากกาเจลสีน้ำเงิน', unit: 'ด้าม', minStock: 20 },
                            { name: 'กระดาษ A4', unit: 'รีม', minStock: 5 },
                            { name: 'แฟ้มเอกสาร', unit: 'อัน', minStock: 10 },
                            { name: 'หมึกพิมพ์ HP 680', unit: 'ตลับ', minStock: 3 },
                            { name: 'เทปกาวใส', unit: 'ม้วน', minStock: 15 },
                        ];

                        sampleItems.forEach(item => {
                            const itemDocRef = doc(itemsCollectionRef);
                            batch.set(itemDocRef, item);
                        });

                        // Sample Transactions
                        const sampleTransactions = [
                            { date: new Date('2024-07-01'), itemName: 'ปากกาเจลสีน้ำเงิน', unit: 'ด้าม', quantity: 50, type: 'receive', poNumber: 'PO001', ivNumber: 'IV001', userId: userId },
                            { date: new Date('2024-07-02'), itemName: 'กระดาษ A4', unit: 'รีม', quantity: 10, type: 'receive', poNumber: 'PO002', ivNumber: 'IV002', userId: userId },
                            { date: new Date('2024-07-03'), itemName: 'ปากกาเจลสีน้ำเงิน', unit: 'ด้าม', quantity: -5, type: 'issue', ivNumber: 'IV003', userId: userId },
                            { date: new Date('2024-07-05'), itemName: 'แฟ้มเอกสาร', unit: 'อัน', quantity: 20, type: 'receive', poNumber: 'PO003', ivNumber: 'IV004', userId: userId },
                            { date: new Date('2024-07-06'), itemName: 'กระดาษ A4', unit: 'รีม', quantity: -2, type: 'issue', ivNumber: 'IV005', userId: userId },
                            { date: new Date('2024-07-08'), itemName: 'หมึกพิมพ์ HP 680', unit: 'ตลับ', quantity: 5, type: 'receive', poNumber: 'PO004', ivNumber: 'IV006', userId: userId },
                            { date: new Date('2024-07-10'), itemName: 'ปากกาเจลสีน้ำเงิน', unit: 'ด้าม', quantity: -10, type: 'issue', ivNumber: 'IV007', userId: userId },
                            { date: new Date('2024-07-12'), itemName: 'เทปกาวใส', unit: 'ม้วน', quantity: 30, type: 'receive', poNumber: 'PO005', ivNumber: 'IV008', userId: userId },
                            { date: new Date('2024-07-15'), itemName: 'แฟ้มเอกสาร', unit: 'อัน', quantity: -3, type: 'issue', ivNumber: 'IV009', userId: userId },
                            { date: new Date('2024-07-18'), itemName: 'หมึกพิมพ์ HP 680', unit: 'ตลับ', quantity: -1, type: 'issue', ivNumber: 'IV010', userId: userId },
                        ];

                        sampleTransactions.forEach(transaction => {
                            const transactionDocRef = doc(transactionsCollectionRef);
                            batch.set(transactionDocRef, transaction);
                        });

                        await batch.commit();
                        setMessage('เพิ่มข้อมูลตัวอย่างเรียบร้อยแล้ว!');
                        setMessageType('success');
                    } else {
                        setMessage('มีข้อมูลอยู่ในระบบแล้ว ไม่ได้เพิ่มข้อมูลตัวอย่าง.');
                        setMessageType('info');
                    }
                } catch (e) {
                    console.error("Error adding sample data:", e);
                    setMessage('เกิดข้อผิดพลาดในการเพิ่มข้อมูลตัวอย่าง: ' + e.message);
                    setMessageType('error');
                } finally {
                    setIsLoading(false);
                }
            };

            const handleExportCSV = () => {
                let csvContent = "\uFEFF" + "ชื่อสินค้า,หน่วยนับ,จำนวนสินค้าคงเหลือ,จำนวนขั้นต่ำ,สถานะการเติมสินค้า\n";
                sortedAndFilteredStockItems.forEach(item => {
                    csvContent += `"${item.name}","${item.unit}",${item.currentStock},${item.minStock},"${item.status}"\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `สินค้าคงเหลือ_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };


            return React.createElement(
                'div',
                { className: 'bg-white p-8 rounded-2xl shadow-lg border border-gray-100 mb-8' },
                React.createElement('h2', { className: 'text-3xl font-bold text-gray-800 mb-6 border-b pb-4' }, 'เมนูสินค้าคงเหลือ'),
                React.createElement(MessageDisplay, { message: message, type: messageType, onClose: () => setMessage('') }),
                React.createElement(
                    'div',
                    { className: 'flex flex-col sm:flex-row justify-between items-center mb-6 gap-4' },
                    React.createElement(
                        'button',
                        {
                            onClick: addSampleData,
                            className: 'px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105',
                            disabled: isLoading,
                        },
                        isLoading ? 'กำลังเพิ่มข้อมูล...' : 'เพิ่มข้อมูลตัวอย่าง (ถ้าว่าง)'
                    ),
                    React.createElement(
                        'div',
                        { className: 'w-full sm:w-auto' },
                        React.createElement('input', {
                            type: 'text',
                            placeholder: 'ค้นหาสินค้า...',
                            value: searchTerm,
                            onChange: (e) => setSearchTerm(e.target.value),
                            className: 'w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-400 focus:border-transparent sm:text-base',
                        })
                    ),
                    React.createElement(
                        'button',
                        {
                            onClick: handleExportCSV,
                            className: 'px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed',
                            disabled: isLoading || sortedAndFilteredStockItems.length === 0,
                        },
                        'ส่งออกเป็น CSV'
                    )
                ),
                isLoading ? (
                    React.createElement('div', { className: 'text-center text-gray-600 py-8' }, 'กำลังโหลดข้อมูลสินค้าคงเหลือ...')
                ) : sortedAndFilteredStockItems.length === 0 ? (
                    React.createElement('p', { className: 'text-gray-600 py-8 text-center' }, 'ไม่พบข้อมูลสินค้าคงเหลือที่ตรงกับคำค้นหา.')
                ) : (
                    React.createElement(
                        'div',
                        { className: 'overflow-x-auto rounded-xl shadow-md border border-gray-200' },
                        React.createElement(
                            'table',
                            { className: 'min-w-full divide-y divide-gray-200' },
                            React.createElement(
                                'thead',
                                { className: 'bg-blue-50' },
                                React.createElement(
                                    'tr',
                                    null,
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider cursor-pointer', onClick: () => handleSort('name') },
                                        'ชื่อสินค้า',
                                        sortColumn === 'name' && React.createElement('i', { className: `ml-2 fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'}` })
                                    ),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider cursor-pointer', onClick: () => handleSort('unit') },
                                        'หน่วยนับ',
                                        sortColumn === 'unit' && React.createElement('i', { className: `ml-2 fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'}` })
                                    ),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider cursor-pointer', onClick: () => handleSort('currentStock') },
                                        'จำนวนสินค้าคงเหลือ',
                                        sortColumn === 'currentStock' && React.createElement('i', { className: `ml-2 fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'}` })
                                    ),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider cursor-pointer', onClick: () => handleSort('minStock') },
                                        'จำนวนขั้นต่ำ',
                                        sortColumn === 'minStock' && React.createElement('i', { className: `ml-2 fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'}` })
                                    ),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider cursor-pointer', onClick: () => handleSort('status') },
                                        'สถานะการเติมสินค้า',
                                        sortColumn === 'status' && React.createElement('i', { className: `ml-2 fas fa-sort-${sortDirection === 'asc' ? 'up' : 'down'}` })
                                    )
                                )
                            ),
                            React.createElement(
                                'tbody',
                                { className: 'bg-white divide-y divide-gray-200' },
                                sortedAndFilteredStockItems.map((item) =>
                                    React.createElement(
                                        'tr',
                                        { key: item.name, className: item.status === 'ต้องเติม' ? 'bg-red-50 hover:bg-red-100' : 'hover:bg-gray-50' }, // Highlight rows needing reorder
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, item.name),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, item.unit),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, item.currentStock),
                                        React.createElement(
                                            'td',
                                            { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' },
                                            React.createElement('input', {
                                                type: 'number',
                                                value: item.minStock,
                                                onChange: (e) => handleMinStockChange(item.id, e.target.value),
                                                className: 'w-24 px-2 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-blue-400 focus:border-transparent',
                                                min: '0',
                                            })
                                        ),
                                        React.createElement(
                                            'td',
                                            { className: `px-6 py-4 whitespace-nowrap text-sm font-semibold ${item.status === 'ต้องเติม' ? 'text-red-600' : 'text-green-600'}` },
                                            item.status
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            );
        }

        // --- Stock Balance by IV Component ---
        function StockBalanceByIV({ setCurrentPage, setReportSelectedItem }) {
            const { db, userId, publicDataPath } = useContext(FirebaseContext);
            const [allTransactions, setAllTransactions] = useState([]); // Store all transactions
            const [itemsListForDropdown, setItemsListForDropdown] = useState([]); // List of unique item names for dropdown
            const [selectedItemName, setSelectedItemName] = useState(''); // Selected item from the dropdown
            const [stockByIVSummary, setStockByIVSummary] = useState([]); // Summarized stock by IV
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [searchTermIV, setSearchTermIV] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');

            const transactionsCollectionRef = collection(db, `${publicDataPath}/transactions`);

            // Fetch all transactions and unique item names for dropdown
            useEffect(() => {
                if (!db || !userId) return;
                setIsLoading(true);

                const unsubscribe = onSnapshot(transactionsCollectionRef, (snapshot) => {
                    const fetchedTransactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setAllTransactions(fetchedTransactions);

                    // Extract unique item names for the dropdown
                    const uniqueItemNames = [...new Set(fetchedTransactions.map(t => t.itemName))].sort();
                    setItemsListForDropdown(uniqueItemNames);

                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching transactions:", error);
                    setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลรายการ.");
                    setMessageType('error');
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [db, userId, publicDataPath]);

            // Process and filter transactions whenever allTransactions or filters change
            useEffect(() => {
                const ivAggregates = {};
                const sDate = startDate ? new Date(startDate + 'T00:00:00') : null; // Ensure start of day
                const eDate = endDate ? new Date(endDate + 'T23:59:59') : null;   // Ensure end of day

                allTransactions.forEach(data => {
                    const iv = data.ivNumber;
                    if (!iv) return; // Skip if no IV number

                    // Filter by IV number search term
                    if (searchTermIV && !iv.toLowerCase().includes(searchTermIV.toLowerCase())) {
                        return;
                    }

                    // Filter by date range
                    const transactionDate = data.date.toDate();
                    if (sDate && transactionDate < sDate) return;
                    if (eDate && transactionDate > eDate) return;

                    // Filter by selected item name from dropdown
                    if (selectedItemName && data.itemName !== selectedItemName) {
                        return;
                    }

                    if (!ivAggregates[iv]) {
                        ivAggregates[iv] = {
                            ivNumber: iv,
                            totalRemaining: 0,
                            itemsInIV: new Map(), // To store item details within this IV if needed for export
                        };
                    }

                    ivAggregates[iv].totalRemaining += data.quantity;

                    // Store item details for CSV export if a specific item is selected
                    if (selectedItemName) {
                        const currentItemQuantity = ivAggregates[iv].itemsInIV.get(data.itemName) || 0;
                        ivAggregates[iv].itemsInIV.set(data.itemName, currentItemQuantity + data.quantity);
                    }
                });

                // Convert aggregated data to an array and sort by totalRemaining
                const finalSummary = Object.values(ivAggregates)
                    .filter(ivData => ivData.totalRemaining !== 0) // Only show IVs with remaining stock
                    .sort((a, b) => b.totalRemaining - a.totalRemaining); // Sort by totalRemaining (descending)

                setStockByIVSummary(finalSummary);
            }, [allTransactions, searchTermIV, startDate, endDate, selectedItemName]);


            const handleExportCSV = () => {
                let csvContent = "\uFEFF"; // BOM for UTF-8

                if (selectedItemName) {
                    // Export detailed view for selected item
                    csvContent += `ชื่อสินค้า,IV,คงเหลือ\n`;
                    stockByIVSummary.forEach(ivData => {
                        const itemQuantity = ivData.itemsInIV.get(selectedItemName);
                        if (itemQuantity !== undefined && itemQuantity !== 0) {
                            csvContent += `"${selectedItemName}","${ivData.ivNumber}",${itemQuantity}\n`;
                        }
                    });
                } else {
                    // Export summarized view for all IVs
                    csvContent += `เลขที่ IV,คงเหลือรวม\n`;
                    stockByIVSummary.forEach(ivData => {
                        csvContent += `"${ivData.ivNumber}",${ivData.totalRemaining}\n`;
                    });
                }


                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `สินค้าคงเหลือ_แยกIV_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            const navigateToReport = (itemName) => {
                setReportSelectedItem(itemName);
                setCurrentPage('report');
            };


            return React.createElement(
                'div',
                { className: 'bg-white p-8 rounded-2xl shadow-lg border border-gray-100 mb-8' },
                React.createElement('h2', { className: 'text-3xl font-bold text-gray-800 mb-6 border-b pb-4' }, 'เมนูสินค้าคงเหลือ (แยกเลขที่ IV)'),
                React.createElement(MessageDisplay, { message: message, type: messageType, onClose: () => setMessage('') }),

                /* Filter Section */
                React.createElement(
                    'div',
                    { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 p-4 border border-gray-200 rounded-xl shadow-sm bg-gray-50' },
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'selectItemForIV', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'เลือกสินค้า:'),
                        React.createElement(
                            'select',
                            {
                                id: 'selectItemForIV',
                                value: selectedItemName,
                                onChange: (e) => setSelectedItemName(e.target.value),
                                className: 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base',
                            },
                            React.createElement('option', { value: '' }, '-- แสดงสินค้าทั้งหมด --'),
                            itemsListForDropdown.map((name, index) =>
                                React.createElement('option', { key: index, value: name }, name)
                            )
                        )
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'searchIV', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'ค้นหาเลขที่ IV:'),
                        React.createElement('input', {
                            type: 'text',
                            id: 'searchIV',
                            value: searchTermIV,
                            onChange: (e) => setSearchTermIV(e.target.value),
                            className: 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base',
                            placeholder: 'ค้นหาเลขที่ IV',
                        })
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'startDate', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'วันที่เริ่มต้น:'),
                        React.createElement('input', {
                            type: 'date',
                            id: 'startDate',
                            value: startDate,
                            onChange: (e) => setStartDate(e.target.value),
                            className: 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base',
                        }),
                        // Display formatted date for user
                        startDate && React.createElement('p', { className: 'text-xs text-gray-500 mt-1' }, 'รูปแบบที่แสดงในรายงาน: ', formatDate(new Date(startDate)))
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'endDate', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'วันที่สิ้นสุด:'),
                        React.createElement('input', {
                            type: 'date',
                            id: 'endDate',
                            value: endDate,
                            onChange: (e) => setEndDate(e.target.value),
                            className: 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base',
                        }),
                        // Display formatted date for user
                        endDate && React.createElement('p', { className: 'text-xs text-gray-500 mt-1' }, 'รูปแบบที่แสดงในรายงาน: ', formatDate(new Date(endDate)))
                    ),
                    React.createElement(
                        'div',
                        { className: 'md:col-span-3 flex justify-end mt-4' },
                        React.createElement(
                            'button',
                            {
                                onClick: handleExportCSV,
                                className: 'px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed',
                                disabled: isLoading || stockByIVSummary.length === 0,
                            },
                            'ส่งออกเป็น CSV'
                        )
                    )
                ),

                isLoading ? (
                    React.createElement('div', { className: 'text-center text-gray-600 py-8' }, 'กำลังโหลดรายการตามเลขที่ IV...')
                ) : stockByIVSummary.length === 0 ? (
                    React.createElement('p', { className: 'text-gray-600 py-8 text-center' }, 'ไม่พบรายการเคลื่อนไหวสินค้าที่ระบุเลขที่ IV ที่ตรงกับเงื่อนไข.')
                ) : (
                    React.createElement(
                        'div',
                        { className: 'overflow-x-auto rounded-xl shadow-md border border-gray-200' },
                        React.createElement(
                            'table',
                            { className: 'min-w-full divide-y divide-gray-200' },
                            React.createElement(
                                'thead',
                                { className: 'bg-blue-50' },
                                React.createElement(
                                    'tr',
                                    null,
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'เลขที่ IV'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'คงเหลือรวม')
                                )
                            ),
                            React.createElement(
                                'tbody',
                                { className: 'bg-white divide-y divide-gray-200' },
                                stockByIVSummary.map((ivData) =>
                                    React.createElement(
                                        'tr',
                                        { key: ivData.ivNumber, className: 'hover:bg-gray-50' },
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, ivData.ivNumber),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, ivData.totalRemaining)
                                    )
                                )
                            )
                        )
                    )
                )
            );
        }

        // --- Item Movement Report Component ---
        function ItemMovementReport({ initialSelectedItem, setInitialSelectedItem }) {
            const { db, userId, publicDataPath } = useContext(FirebaseContext);
            const [selectedItem, setSelectedItem] = useState(initialSelectedItem || '');
            const [items, setItems] = useState([]);
            const [itemMovements, setItemMovements] = useState([]);
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');
            const [isLoading, setIsLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [startDate, setStartDate] = useState('');
            const [endDate, setEndDate] = useState('');

            // Pagination states
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 10;

            const itemsCollectionRef = collection(db, `${publicDataPath}/items`);
            const transactionsCollectionRef = collection(db, `${publicDataPath}/transactions`);

            // Set initial selected item when component mounts or initialSelectedItem changes
            useEffect(() => {
                if (initialSelectedItem) {
                    setSelectedItem(initialSelectedItem);
                    setInitialSelectedItem(''); // Clear it after setting to avoid re-triggering
                }
            }, [initialSelectedItem, setInitialSelectedItem]);

            // Fetch all item names for the dropdown
            useEffect(() => {
                if (!db || !userId) return;
                setIsLoading(true);

                const unsubscribe = onSnapshot(itemsCollectionRef, (snapshot) => {
                    const itemsData = snapshot.docs.map(doc => doc.data().name);
                    setItems(itemsData);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching item names:", error);
                    setMessage("เกิดข้อผิดพลาดในการดึงชื่อสินค้า.");
                    setMessageType('error');
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [db, userId, publicDataPath]);

            // Fetch movements for selected item and calculate running balance
            useEffect(() => {
                if (!db || !userId || !selectedItem) {
                    setItemMovements([]);
                    return;
                }
                setIsLoading(true);

                let q = query(
                    transactionsCollectionRef,
                    where('itemName', '==', selectedItem)
                );

                const sDate = startDate ? new Date(startDate + 'T00:00:00') : null;
                const eDate = endDate ? new Date(endDate + 'T23:59:59') : null;

                // Filter by date range if dates are provided
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    let currentBalance = 0;
                    const movements = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(movement => {
                            const transactionDate = movement.date.toDate();
                            if (sDate && transactionDate < sDate) return false;
                            if (eDate && transactionDate > eDate) return false;
                            return true;
                        })
                        .sort((a, b) => a.date.toDate() - b.date.toDate()) // Ensure sorted by date for correct running balance
                        .map(movement => {
                            currentBalance += movement.quantity;
                            return { ...movement, runningBalance: currentBalance };
                        });
                    setItemMovements(movements);
                    setIsLoading(false);
                    setCurrentPage(1); // Reset to first page when item or filters change
                }, (error) => {
                    console.error("Error fetching item movements:", error);
                    setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลการเคลื่อนไหวสินค้า.");
                    setMessageType('error');
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [db, userId, selectedItem, publicDataPath, startDate, endDate]); // Add startDate, endDate to dependencies

            // Filtered movements based on search term
            const filteredMovements = itemMovements.filter(movement =>
                movement.itemName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                movement.unit.toLowerCase().includes(searchTerm.toLowerCase()) ||
                movement.type.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (movement.poNumber && movement.poNumber.toLowerCase().includes(searchTerm.toLowerCase())) ||
                (movement.ivNumber && movement.ivNumber.toLowerCase().includes(searchTerm.toLowerCase())) ||
                formatDate(movement.date).toLowerCase().includes(searchTerm.toLowerCase()) ||
                movement.runningBalance.toString().includes(searchTerm.toLowerCase()) // Allow search by running balance
            );

            // Get current items for pagination
            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentItems = filteredMovements.slice(indexOfFirstItem, indexOfLastItem);

            const handlePageChange = (pageNumber) => setCurrentPage(pageNumber);

            const handleExportCSV = () => {
                let csvContent = "\uFEFF" + "วันที่,ประเภท,จำนวน,หน่วยนับ,เลขที่ PO,เลขที่ IV,ยอดคงเหลือ\n";
                filteredMovements.forEach(movement => {
                    const dateFormatted = formatDate(movement.date);
                    const typeText = movement.type === 'receive' ? 'รับเข้า' : movement.type === 'issue' ? 'จ่ายออก' : movement.type === 'adjustment_in' ? 'ปรับเพิ่ม' : 'ปรับลด';
                    const po = movement.poNumber || '';
                    const iv = movement.ivNumber || '';
                    csvContent += `"${dateFormatted}","${typeText}",${Math.abs(movement.quantity)},"${movement.unit}","${po}","${iv}",${movement.runningBalance}\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `รายงานเคลื่อนไหว_${selectedItem}_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            return React.createElement(
                'div',
                { className: 'bg-white p-8 rounded-2xl shadow-lg border border-gray-100 mb-8' },
                React.createElement('h2', { className: 'text-3xl font-bold text-gray-800 mb-6 border-b pb-4' }, 'รายงานเคลื่อนไหวสินค้ารายตัว'),
                React.createElement(MessageDisplay, { message: message, type: messageType, onClose: () => setMessage('') }),
                React.createElement(
                    'div',
                    { className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6 p-4 border border-gray-200 rounded-xl shadow-sm bg-gray-50' },
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'selectItem', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'เลือกสินค้า:'),
                        React.createElement(
                            'select',
                            {
                                id: 'selectItem',
                                value: selectedItem,
                                onChange: (e) => setSelectedItem(e.target.value),
                                className: 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base',
                            },
                            React.createElement('option', { value: '' }, '-- เลือกสินค้า --'),
                            items.map((name, index) =>
                                React.createElement('option', { key: index, value: name }, name)
                            )
                        )
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'reportStartDate', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'วันที่เริ่มต้น:'),
                        React.createElement('input', {
                            type: 'date',
                            id: 'reportStartDate',
                            value: startDate,
                            onChange: (e) => setStartDate(e.target.value),
                            className: 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base',
                        }),
                        // Display formatted date for user
                        startDate && React.createElement('p', { className: 'text-xs text-gray-500 mt-1' }, 'รูปแบบที่แสดงในรายงาน: ', formatDate(new Date(startDate)))
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'reportEndDate', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'วันที่สิ้นสุด:'),
                        React.createElement('input', {
                            type: 'date',
                            id: 'reportEndDate',
                            value: endDate,
                            onChange: (e) => setEndDate(e.target.value),
                            className: 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base',
                        }),
                        // Display formatted date for user
                        endDate && React.createElement('p', { className: 'text-xs text-gray-500 mt-1' }, 'รูปแบบที่แสดงในรายงาน: ', formatDate(new Date(endDate)))
                    ),
                    selectedItem &&
                    React.createElement(
                        'div',
                        { className: 'md:col-span-3 flex flex-col sm:flex-row justify-between items-center mt-4 gap-4' },
                        React.createElement('input', {
                            type: 'text',
                            id: 'searchMovement',
                            placeholder: 'ค้นหาด้วยชื่อ, หน่วยนับ, เลขที่ IV/PO, ยอดคงเหลือ...',
                            value: searchTerm,
                            onChange: (e) => setSearchTerm(e.target.value),
                            className: 'w-full sm:w-auto flex-grow px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base',
                        }),
                        React.createElement(
                            'button',
                            {
                                onClick: handleExportCSV,
                                className: 'px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed',
                                disabled: isLoading || filteredMovements.length === 0,
                            },
                            'ส่งออกเป็น CSV'
                        )
                    )
                ),

                selectedItem &&
                React.createElement(
                    React.Fragment,
                    null,
                    React.createElement(
                        'h3',
                        { className: 'text-2xl font-bold text-gray-800 mt-12 mb-6 border-b pb-4' },
                        'รายงานการเคลื่อนไหวของ: ',
                        selectedItem
                    ),
                    isLoading ? (
                        React.createElement('div', { className: 'text-center text-gray-600 py-8' }, 'กำลังโหลดรายการเคลื่อนไหว...')
                    ) : filteredMovements.length === 0 ? (
                        React.createElement('p', { className: 'text-gray-600 py-8 text-center' }, 'ไม่พบการเคลื่อนไหวสำหรับสินค้านี้ที่ตรงกับคำค้นหา.')
                    ) : (
                        React.createElement(
                            'div',
                            { className: 'overflow-x-auto rounded-xl shadow-md border border-gray-200' },
                            React.createElement(
                                'table',
                                { className: 'min-w-full divide-y divide-gray-200' },
                                React.createElement(
                                    'thead',
                                    { className: 'bg-blue-50' },
                                    React.createElement(
                                        'tr',
                                        null,
                                        React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'วันที่'),
                                        React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'ประเภท'),
                                        React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'จำนวน'),
                                        React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'หน่วยนับ'),
                                        React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'เลขที่ PO'),
                                        React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'เลขที่ IV'),
                                        React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'ยอดคงเหลือ')
                                    )
                                ),
                                React.createElement(
                                    'tbody',
                                    { className: 'bg-white divide-y divide-gray-200' },
                                    currentItems.map((movement) =>
                                        React.createElement(
                                            'tr',
                                            { key: movement.id, className: 'hover:bg-gray-50' },
                                            React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, formatDate(movement.date)),
                                            React.createElement(
                                                'td',
                                                { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' },
                                                React.createElement(
                                                    'span',
                                                    {
                                                        className: `px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                            movement.type === 'receive' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                                        }`,
                                                    },
                                                    movement.type === 'receive' ? 'รับเข้า' : 'จ่ายออก'
                                                )
                                            ),
                                            React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, Math.abs(movement.quantity)),
                                            React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, movement.unit),
                                            React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, movement.poNumber || '-'),
                                            React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, movement.ivNumber),
                                            React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900' }, movement.runningBalance)
                                        )
                                    )
                                )
                            )
                        )
                    )
                ),
                React.createElement(Pagination, {
                    totalItems: filteredMovements.length,
                    itemsPerPage: itemsPerPage,
                    currentPage: currentPage,
                    onPageChange: handlePageChange,
                })
            );
        }

        // --- Stock Adjustment Component (NEW) ---
        function StockAdjustment() {
            const { db, userId, publicDataPath } = useContext(FirebaseContext);
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [itemName, setItemName] = useState('');
            const [unit, setUnit] = useState('');
            const [quantity, setQuantity] = useState('');
            const [adjustmentType, setAdjustmentType] = useState('increase'); // 'increase' or 'decrease'
            const [reason, setReason] = useState('');
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');
            const [items, setItems] = useState([]); // List of existing items for dropdown
            const [recentAdjustments, setRecentAdjustments] = useState([]);
            const [isLoading, setIsLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [currentAvailableStock, setCurrentAvailableStock] = useState(null); // Declared here

            // Pagination states
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 10;

            // Confirmation Modal states
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [transactionToDelete, setTransactionToDelete] = useState(null);

            // Validation states
            const [itemNameError, setItemNameError] = useState('');
            const [unitError, setUnitError] = useState('');
            const [quantityError, setQuantityError] = useState('');
            const [reasonError, setReasonError] = useState('');

            const itemsCollectionRef = collection(db, `${publicDataPath}/items`);
            const transactionsCollectionRef = collection(db, `${publicDataPath}/transactions`);

            // Fetch existing items for dropdown and recent adjustments
            useEffect(() => {
                if (!db || !userId) return;
                setIsLoading(true);

                // Fetch items
                const unsubscribeItems = onSnapshot(itemsCollectionRef, (snapshot) => {
                    const itemsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setItems(itemsData);
                }, (error) => {
                    console.error("Error fetching items:", error);
                    setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลสินค้า.");
                    setMessageType('error');
                });

                // Fetch recent adjustment transactions
                const q = query(
                    transactionsCollectionRef,
                    where('type', 'in', ['adjustment_in', 'adjustment_out'])
                );
                const unsubscribeAdjustments = onSnapshot(q, (snapshot) => {
                    const adjustmentsData = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => b.date.toDate() - a.date.toDate()); // Sort in JavaScript
                    setRecentAdjustments(adjustmentsData);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching recent adjustments:", error);
                    setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลการปรับปรุงล่าสุด.");
                    setMessageType('error');
                    setIsLoading(false);
                });

                return () => {
                    unsubscribeItems();
                    unsubscribeAdjustments();
                };
            }, [db, userId, publicDataPath]);

            // Effect to update currentAvailableStock when itemName changes
            useEffect(() => {
                const fetchCurrentStock = async () => {
                    if (!db || !itemName) {
                        setCurrentAvailableStock(null);
                        return;
                    }
                    try {
                        const transactionsForItemQuery = query(transactionsCollectionRef, where('itemName', '==', itemName));
                        const transactionsForItemSnapshot = await getDocs(transactionsForItemQuery);
                        let stock = 0;
                        transactionsForItemSnapshot.docs.forEach(doc => {
                            stock += doc.data().quantity;
                        });
                        setCurrentAvailableStock(stock);
                    } catch (error) {
                        console.error("Error fetching current stock for adjustment:", error);
                        setCurrentAvailableStock(null);
                    }
                };
                fetchCurrentStock();
            }, [itemName, db, transactionsCollectionRef]);

            const handleItemNameChange = (e) => {
                const selectedName = e.target.value;
                setItemName(selectedName);
                const selectedItem = items.find(item => item.name === selectedName);
                if (selectedItem) {
                    setUnit(selectedItem.unit || '');
                    e.target.form.elements.unitAdjustment.readOnly = true;
                } else {
                    setUnit('');
                    e.target.form.elements.unitAdjustment.readOnly = false;
                }
                setItemNameError('');
            };

            const handleUnitChange = (e) => {
                setUnit(e.target.value);
                setUnitError('');
            };

            const handleQuantityChange = (e) => {
                setQuantity(e.target.value);
                setQuantityError('');
            };

            const handleReasonChange = (e) => {
                setReason(e.target.value);
                setReasonError('');
            };

            const validateForm = () => {
                let isValid = true;
                if (!itemName) {
                    setItemNameError('กรุณากรอกชื่อสินค้า');
                    isValid = false;
                }
                if (!unit) {
                    setUnitError('กรุณากรอกหน่วยนับ');
                    isValid = false;
                }
                const parsedQuantity = parseFloat(quantity);
                if (isNaN(parsedQuantity) || parsedQuantity <= 0) {
                    setQuantityError('จำนวนต้องเป็นตัวเลขและมากกว่า 0');
                    isValid = false;
                } else if (adjustmentType === 'decrease' && currentAvailableStock !== null && parsedQuantity > currentAvailableStock) {
                    setQuantityError(`จำนวนปรับลดเกินสต็อกที่มี. คงเหลือ: ${currentAvailableStock} ${unit}.`);
                    isValid = false;
                }
                else {
                    setQuantityError('');
                }
                if (!reason) {
                    setReasonError('กรุณากรอกเหตุผลในการปรับปรุง');
                    isValid = false;
                }
                return isValid;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setMessage('');
                setMessageType('');

                if (!validateForm()) {
                    return;
                }

                setIsLoading(true);
                try {
                    await runTransaction(db, async (transaction) => {
                        const quantityValue = parseFloat(quantity);

                        // Ensure item exists in master data or create it if adjusting in
                        const existingItemQuery = query(itemsCollectionRef, where('name', '==', itemName));
                        const existingItemSnapshot = await transaction.get(existingItemQuery);

                        let itemDocRef;
                        if (existingItemSnapshot.empty) {
                            if (adjustmentType === 'decrease') {
                                throw new Error(`สินค้า "${itemName}" ไม่มีอยู่ในระบบ ไม่สามารถปรับลดได้.`);
                            }
                            // Create new item if adjusting in and it doesn't exist
                            itemDocRef = doc(itemsCollectionRef);
                            transaction.set(itemDocRef, {
                                name: itemName,
                                unit: unit,
                                minStock: 0,
                            });
                        } else {
                            itemDocRef = existingItemSnapshot.docs[0].ref;
                            // Update unit if different
                            if (existingItemSnapshot.docs[0].data().unit !== unit) {
                                transaction.update(itemDocRef, { unit: unit });
                            }
                        }

                        // Stock check for decrease adjustment
                        if (adjustmentType === 'decrease') {
                            const transactionsForItemQuery = query(transactionsCollectionRef, where('itemName', '==', itemName));
                            const transactionsForItemSnapshot = await transaction.get(transactionsForItemQuery);
                            let currentStock = 0;
                            transactionsForItemSnapshot.docs.forEach(doc => {
                                currentStock += doc.data().quantity;
                            });

                            if (quantityValue > currentStock) {
                                throw new Error(`สินค้า "${itemName}" มีในสต็อกไม่เพียงพอสำหรับการปรับลด. คงเหลือ: ${currentStock} ${unit}.`);
                            }
                        }

                        // Add adjustment transaction
                        const finalQuantity = adjustmentType === 'increase' ? quantityValue : -quantityValue;
                        const newTransactionRef = doc(transactionsCollectionRef);
                        transaction.set(newTransactionRef, {
                            date: new Date(date),
                            itemName: itemName,
                            unit: unit,
                            quantity: finalQuantity,
                            type: adjustmentType === 'increase' ? 'adjustment_in' : 'adjustment_out',
                            reason: reason,
                            userId: userId,
                        });
                    });

                    setMessage('บันทึกการปรับปรุงสต็อกเรียบร้อยแล้ว!');
                    setMessageType('success');
                    // Clear form
                    setItemName('');
                    setUnit('');
                    setQuantity('');
                    setReason('');
                    setDate(new Date().toISOString().split('T')[0]);
                    setAdjustmentType('increase');
                    setCurrentAvailableStock(null); // Clear stock display
                    // Clear validation errors
                    setItemNameError('');
                    setUnitError('');
                    setQuantityError('');
                    setReasonError('');
                    setCurrentPage(1); // Reset to first page after successful submission
                } catch (e) {
                    console.error("Error adding adjustment:", e);
                    setMessage('เกิดข้อผิดพลาดในการบันทึกการปรับปรุง: ' + e.message);
                    setMessageType('error');
                } finally {
                    setIsLoading(false);
                }
            };

            const confirmDeleteTransaction = (transaction) => {
                setTransactionToDelete(transaction);
                setShowConfirmModal(true);
            };

            const handleDeleteTransaction = async () => {
                if (!transactionToDelete) return;

                setMessage('');
                setMessageType('');
                setIsLoading(true);
                setShowConfirmModal(false); // Close the modal immediately

                try {
                    await runTransaction(db, async (transaction) => {
                        const transactionRef = doc(transactionsCollectionRef, transactionToDelete.id);
                        transaction.delete(transactionRef);
                    });
                    setMessage('ลบรายการปรับปรุงเรียบร้อยแล้ว!');
                    setMessageType('success');
                } catch (e) {
                    console.error("Error deleting transaction:", e);
                    setMessage('เกิดข้อผิดพลาดในการลบรายการ: ' + e.message);
                    setMessageType('error');
                } finally {
                    setIsLoading(false);
                    setTransactionToDelete(null);
                }
            };

            const cancelDelete = () => {
                setShowConfirmModal(false);
                setTransactionToDelete(null);
            };

            const handleExportCSV = () => {
                let csvContent = "\uFEFF" + "วันที่,ชื่อสินค้า,หน่วยนับ,จำนวน,ประเภท,เหตุผล\n";
                filteredRecentAdjustments.forEach(transaction => {
                    const dateFormatted = formatDate(transaction.date);
                    const typeText = transaction.type === 'adjustment_in' ? 'เพิ่มสต็อก' : 'ลดสต็อก';
                    csvContent += `"${dateFormatted}","${transaction.itemName}","${transaction.unit}",${Math.abs(transaction.quantity)},"${typeText}","${transaction.reason || '-'}"\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `รายการปรับปรุงสต็อก_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            // Filter recent adjustments based on search term
            const filteredRecentAdjustments = recentAdjustments.filter(transaction =>
                transaction.itemName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                transaction.unit.toLowerCase().includes(searchTerm.toLowerCase()) ||
                (transaction.reason && transaction.reason.toLowerCase().includes(searchTerm.toLowerCase())) ||
                formatDate(transaction.date).toLowerCase().includes(searchTerm.toLowerCase())
            );

            // Get current items for pagination
            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentItems = filteredRecentAdjustments.slice(indexOfFirstItem, indexOfLastItem);

            const handlePageChange = (pageNumber) => setCurrentPage(pageNumber);

            return React.createElement(
                'div',
                { className: 'bg-white p-8 rounded-2xl shadow-lg border border-gray-100 mb-8' },
                React.createElement('h2', { className: 'text-3xl font-bold text-gray-800 mb-6 border-b pb-4' }, 'เมนูปรับปรุงสต็อก'),
                React.createElement(MessageDisplay, { message: message, type: messageType, onClose: () => setMessage('') }),
                React.createElement(
                    'form',
                    { onSubmit: handleSubmit, className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'adjustmentDate', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'วันที่:'),
                        React.createElement('input', {
                            type: 'date',
                            id: 'adjustmentDate',
                            value: date,
                            onChange: (e) => setDate(e.target.value),
                            className: 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base',
                            required: true,
                        }),
                        // Display formatted date for user
                        date && React.createElement('p', { className: 'text-xs text-gray-500 mt-1' }, 'รูปแบบที่แสดงในรายงาน: ', formatDate(new Date(date)))
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'itemNameAdjustment', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'ชื่อสินค้า:'),
                        React.createElement('input', {
                            list: 'item-names-adjustment',
                            id: 'itemNameAdjustment',
                            value: itemName,
                            onChange: handleItemNameChange,
                            className: `mt-1 block w-full px-4 py-2 border ${itemNameError ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base`,
                            placeholder: 'เลือกหรือพิมพ์ชื่อสินค้า',
                            required: true,
                        }),
                        React.createElement(
                            'datalist',
                            { id: 'item-names-adjustment' },
                            items.map(item => React.createElement('option', { key: item.id, value: item.name }))
                        ),
                        itemNameError && React.createElement('p', { className: 'text-red-500 text-xs mt-1' }, itemNameError)
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'unitAdjustment', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'หน่วยนับ:'),
                        React.createElement('input', {
                            type: 'text',
                            id: 'unitAdjustment',
                            value: unit,
                            onChange: handleUnitChange,
                            className: `mt-1 block w-full px-4 py-2 border ${unitError ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base`,
                            placeholder: 'เช่น ชิ้น, กล่อง',
                            required: true,
                        }),
                        unitError && React.createElement('p', { className: 'text-red-500 text-xs mt-1' }, unitError)
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'quantityAdjustment', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'จำนวน:'),
                        React.createElement('input', {
                            type: 'number',
                            id: 'quantityAdjustment',
                            value: quantity,
                            onChange: handleQuantityChange,
                            className: `mt-1 block w-full px-4 py-2 border ${quantityError ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base`,
                            min: '1',
                            required: true,
                        }),
                        currentAvailableStock !== null && React.createElement('p', { className: 'text-xs text-gray-600 mt-1' }, 'สต็อกปัจจุบัน: ', currentAvailableStock, ' ', unit),
                        quantityError && React.createElement('p', { className: 'text-red-500 text-xs mt-1' }, quantityError)
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'ประเภทการปรับปรุง:'),
                        React.createElement(
                            'select',
                            {
                                value: adjustmentType,
                                onChange: (e) => setAdjustmentType(e.target.value),
                                className: 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base',
                            },
                            React.createElement('option', { value: 'increase' }, 'เพิ่มสต็อก'),
                            React.createElement('option', { value: 'decrease' }, 'ลดสต็อก')
                        )
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'reasonAdjustment', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'เหตุผล:'),
                        React.createElement('input', {
                            type: 'text',
                            id: 'reasonAdjustment',
                            value: reason,
                            onChange: handleReasonChange,
                            className: `mt-1 block w-full px-4 py-2 border ${reasonError ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base`,
                            placeholder: 'เช่น สินค้าชำรุด, นับผิด',
                            required: true,
                        }),
                        reasonError && React.createElement('p', { className: 'text-red-500 text-xs mt-1' }, reasonError)
                    ),
                    React.createElement(
                        'div',
                        { className: 'md:col-span-2 flex justify-end items-center mt-4' },
                        React.createElement(
                            'button',
                            {
                                type: 'submit',
                                className: 'px-8 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105',
                                disabled: isLoading,
                            },
                            isLoading ? 'กำลังบันทึก...' : 'บันทึกปรับปรุง'
                        )
                    )
                ),
                React.createElement('h3', { className: 'text-2xl font-bold text-gray-800 mt-12 mb-6 border-b pb-4' }, 'รายการปรับปรุงล่าสุด'),
                React.createElement(
                    'div',
                    { className: 'flex flex-col sm:flex-row justify-between items-center mb-6 gap-4' },
                    React.createElement('input', {
                        type: 'text',
                        placeholder: 'ค้นหารายการปรับปรุง...',
                        value: searchTerm,
                        onChange: (e) => setSearchTerm(e.target.value),
                        className: 'w-full sm:w-auto flex-grow px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base',
                    }),
                    React.createElement(
                        'button',
                        {
                            onClick: handleExportCSV,
                            className: 'px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed',
                            disabled: isLoading || filteredRecentAdjustments.length === 0,
                        },
                        'ส่งออกเป็น CSV'
                    )
                ),
                isLoading ? (
                    React.createElement('div', { className: 'text-center text-gray-600 py-8' }, 'กำลังโหลดรายการ...')
                ) : filteredRecentAdjustments.length === 0 ? (
                    React.createElement('p', { className: 'text-gray-600 py-8 text-center' }, 'ไม่พบรายการปรับปรุงสต็อกที่ตรงกับคำค้นหา.')
                ) : (
                    React.createElement(
                        'div',
                        { className: 'overflow-x-auto rounded-xl shadow-md border border-gray-200' },
                        React.createElement(
                            'table',
                            { className: 'min-w-full divide-y divide-gray-200' },
                            React.createElement(
                                'thead',
                                { className: 'bg-blue-50' },
                                React.createElement(
                                    'tr',
                                    null,
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'วันที่'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'ชื่อสินค้า'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'หน่วยนับ'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'จำนวน'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'ประเภท'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'เหตุผล'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'การดำเนินการ')
                                )
                            ),
                            React.createElement(
                                'tbody',
                                { className: 'bg-white divide-y divide-gray-200' },
                                currentItems.map((transaction) =>
                                    React.createElement(
                                        'tr',
                                        { key: transaction.id, className: 'hover:bg-gray-50' },
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, formatDate(transaction.date)),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, transaction.itemName),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, transaction.unit),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, Math.abs(transaction.quantity)),
                                        React.createElement(
                                            'td',
                                            { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' },
                                            React.createElement(
                                                'span',
                                                {
                                                    className: `px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                                                        transaction.type === 'adjustment_in' ? 'bg-blue-100 text-blue-800' : 'bg-orange-100 text-orange-800'
                                                    }`,
                                                },
                                                transaction.type === 'adjustment_in' ? 'เพิ่มสต็อก' : 'ลดสต็อก'
                                            )
                                        ),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, transaction.reason || '-'),
                                        React.createElement(
                                            'td',
                                            { className: 'px-6 py-4 whitespace-nowrap text-sm' },
                                            React.createElement(
                                                'button',
                                                {
                                                    onClick: () => confirmDeleteTransaction(transaction),
                                                    className: 'text-red-600 hover:text-red-900 disabled:opacity-50 disabled:cursor-not-allowed font-medium',
                                                    disabled: isLoading,
                                                },
                                                'ลบ'
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    )
                ),
                React.createElement(Pagination, {
                    totalItems: filteredRecentAdjustments.length,
                    itemsPerPage: itemsPerPage,
                    currentPage: currentPage,
                    onPageChange: handlePageChange,
                }),
                /* Confirmation Modal for Adjustment Items */
                React.createElement(ConfirmationModal, {
                    isOpen: showConfirmModal,
                    title: 'ยืนยันการลบรายการปรับปรุง',
                    message: `คุณแน่ใจหรือไม่ที่จะลบรายการปรับปรุงของ "${transactionToDelete?.itemName}" จำนวน ${Math.abs(transactionToDelete?.quantity)} ${transactionToDelete?.unit} (เหตุผล: ${transactionToDelete?.reason})? การดำเนินการนี้ไม่สามารถย้อนกลับได้.`,
                    onConfirm: handleDeleteTransaction,
                    onCancel: cancelDelete,
                })
            );
        }

        // --- Summary Report Component (NEW) ---
        function SummaryReport() {
            const { db, userId, publicDataPath } = useContext(FirebaseContext);
            const [totalUniqueItems, setTotalUniqueItems] = useState(0);
            const [totalStockQuantity, setTotalStockQuantity] = useState(0);
            const [topReceivedItems, setTopReceivedItems] = useState([]);
            const [topIssuedItems, setTopIssuedItems] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');
            const [reportStartDate, setReportStartDate] = useState(() => {
                const d = new Date();
                d.setDate(d.getDate() - 30); // Default to last 30 days
                return d.toISOString().split('T')[0];
            });
            const [reportEndDate, setReportEndDate] = useState(new Date().toISOString().split('T')[0]);

            const itemsCollectionRef = collection(db, `${publicDataPath}/items`);
            const transactionsCollectionRef = collection(db, `${publicDataPath}/transactions`);

            const fetchSummaryData = useCallback(async () => {
                if (!db || !userId) return;
                setIsLoading(true);
                setMessage('');
                setMessageType('');

                try {
                    // Fetch all items for unique count
                    const itemsSnapshot = await getDocs(itemsCollectionRef);
                    setTotalUniqueItems(itemsSnapshot.size);

                    // Fetch all transactions for stock calculation and top items
                    const transactionsSnapshot = await getDocs(transactionsCollectionRef);
                    const allTransactions = transactionsSnapshot.docs.map(doc => doc.data());

                    // Calculate total stock quantity
                    let currentTotalStock = 0;
                    const stockMap = new Map(); // To calculate current stock per item
                    allTransactions.forEach(trans => {
                        stockMap.set(trans.itemName, (stockMap.get(trans.itemName) || 0) + trans.quantity);
                    });
                    stockMap.forEach(quantity => {
                        currentTotalStock += quantity;
                    });
                    setTotalStockQuantity(currentTotalStock);

                    // Calculate top received/issued items within the date range
                    const sDate = new Date(reportStartDate + 'T00:00:00');
                    const eDate = new Date(reportEndDate + 'T23:59:59');

                    const filteredTransactions = allTransactions.filter(trans => {
                        const transDate = trans.date.toDate();
                        return transDate >= sDate && transDate <= eDate;
                    });

                    const receivedAggregates = {};
                    const issuedAggregates = {};

                    filteredTransactions.forEach(trans => {
                        if (trans.type === 'receive') {
                            receivedAggregates[trans.itemName] = (receivedAggregates[trans.itemName] || 0) + trans.quantity;
                        } else if (trans.type === 'issue') {
                            issuedAggregates[trans.itemName] = (issuedAggregates[trans.itemName] || 0) + Math.abs(trans.quantity);
                        }
                    });

                    const sortedReceived = Object.entries(receivedAggregates)
                        .map(([name, quantity]) => ({ name, quantity }))
                        .sort((a, b) => b.quantity - a.quantity)
                        .slice(0, 5); // Top 5
                    setTopReceivedItems(sortedReceived);

                    const sortedIssued = Object.entries(issuedAggregates)
                        .map(([name, quantity]) => ({ name, quantity }))
                        .sort((a, b) => b.quantity - a.quantity)
                        .slice(0, 5); // Top 5
                    setTopIssuedItems(sortedIssued);

                } catch (e) {
                    console.error("Error fetching summary data:", e);
                    setMessage('เกิดข้อผิดพลาดในการดึงข้อมูลสรุป: ' + e.message);
                    setMessageType('error');
                } finally {
                    setIsLoading(false);
                }
            }, [db, userId, publicDataPath, reportStartDate, reportEndDate]);

            useEffect(() => {
                fetchSummaryData();
            }, [fetchSummaryData]);

            const handleExportCSV = () => {
                let csvContent = "\uFEFF" + "ประเภทรายงาน,ชื่อสินค้า,จำนวน,หน่วยนับ\n";

                csvContent += `"ภาพรวมสต็อก",,"${totalUniqueItems} ชนิด",\n`;
                csvContent += `,"ยอดรวมสินค้าคงเหลือทั้งหมด","${totalStockQuantity} หน่วย",\n\n`;

                csvContent += `"สินค้า 5 อันดับแรกที่รับเข้ามากที่สุด",,,\n`;
                topReceivedItems.forEach(item => {
                    csvContent += `,"${item.name}",${item.quantity},"หน่วย"\n`;
                });
                csvContent += `\n`;

                csvContent += `"สินค้า 5 อันดับแรกที่จ่ายออกมากที่สุด",,,\n`;
                topIssuedItems.forEach(item => {
                    csvContent += `,"${item.name}",${item.quantity},"หน่วย"\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `รายงานสรุป_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            return React.createElement(
                'div',
                { className: 'bg-white p-8 rounded-2xl shadow-lg border border-gray-100 mb-8' },
                React.createElement('h2', { className: 'text-3xl font-bold text-gray-800 mb-6 border-b pb-4' }, 'รายงานสรุป'),
                React.createElement(MessageDisplay, { message: message, type: messageType, onClose: () => setMessage('') }),

                isLoading ? (
                    React.createElement('div', { className: 'text-center text-gray-600 py-8' }, 'กำลังโหลดข้อมูลสรุป...')
                ) : (
                    React.createElement(
                        'div',
                        { className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },
                        React.createElement(
                            'div',
                            { className: 'bg-pink-50 p-6 rounded-xl shadow-sm border border-pink-100' },
                            React.createElement('h3', { className: 'text-xl font-bold text-pink-800 mb-4' }, 'ภาพรวมสต็อก'),
                            React.createElement('p', { className: 'text-gray-700 text-lg mb-2' }, React.createElement('strong', null, 'จำนวนชนิดสินค้าทั้งหมด:'), ' ', React.createElement('span', { className: 'text-pink-700 font-semibold' }, totalUniqueItems), ' ชนิด'),
                            React.createElement('p', { className: 'text-gray-700 text-lg' }, React.createElement('strong', null, 'ยอดรวมสินค้าคงเหลือทั้งหมด:'), ' ', React.createElement('span', { className: 'text-pink-700 font-semibold' }, totalStockQuantity), ' หน่วย')
                        ),
                        React.createElement(
                            'div',
                            { className: 'md:col-span-2 bg-gray-50 p-6 rounded-xl shadow-sm border border-gray-200' },
                            React.createElement('h3', { className: 'text-xl font-bold text-gray-800 mb-4' }, 'ตัวกรองรายงานยอดนิยม'),
                            React.createElement(
                                'div',
                                { className: 'grid grid-cols-1 sm:grid-cols-2 gap-4' },
                                React.createElement(
                                    'div',
                                    null,
                                    React.createElement('label', { htmlFor: 'reportSummaryStartDate', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'วันที่เริ่มต้น:'),
                                    React.createElement('input', {
                                        type: 'date',
                                        id: 'reportSummaryStartDate',
                                        value: reportStartDate,
                                        onChange: (e) => setReportStartDate(e.target.value),
                                        className: 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base',
                                    }),
                                    // Display formatted date for user
                                    reportStartDate && React.createElement('p', { className: 'text-xs text-gray-500 mt-1' }, 'รูปแบบที่แสดงในรายงาน: ', formatDate(new Date(reportStartDate)))
                                ),
                                React.createElement(
                                    'div',
                                    null,
                                    React.createElement('label', { htmlFor: 'reportSummaryEndDate', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'วันที่สิ้นสุด:'),
                                    React.createElement('input', {
                                        type: 'date',
                                        id: 'reportSummaryEndDate',
                                        value: reportEndDate,
                                        onChange: (e) => setReportEndDate(e.target.value),
                                        className: 'mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base',
                                    }),
                                    // Display formatted date for user
                                    reportEndDate && React.createElement('p', { className: 'text-xs text-gray-500 mt-1' }, 'รูปแบบที่แสดงในรายงาน: ', formatDate(new Date(reportEndDate)))
                                )
                            ),
                            React.createElement(
                                'div',
                                { className: 'md:col-span-2 flex justify-end mt-4' },
                                React.createElement(
                                    'button',
                                    {
                                        onClick: handleExportCSV,
                                        className: 'px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed',
                                        disabled: isLoading || (topReceivedItems.length === 0 && topIssuedItems.length === 0),
                                    },
                                    'ส่งออกเป็น CSV'
                                )
                            )
                        ),
                        React.createElement(
                            'div',
                            { className: 'bg-green-50 p-6 rounded-xl shadow-sm border border-green-100' },
                            React.createElement('h3', { className: 'text-xl font-bold text-green-800 mb-4' }, 'สินค้า 5 อันดับแรกที่รับเข้ามากที่สุด'),
                            topReceivedItems.length === 0 ? (
                                React.createElement('p', { className: 'text-gray-600' }, 'ไม่พบข้อมูล.')
                            ) : (
                                React.createElement(
                                    'ul',
                                    { className: 'list-disc list-inside text-gray-700 space-y-2' },
                                    topReceivedItems.map((item, index) =>
                                        React.createElement('li', { key: index }, React.createElement('span', { className: 'font-semibold' }, item.name), ': ', item.quantity, ' หน่วย')
                                    )
                                )
                            )
                        ),
                        React.createElement(
                            'div',
                            { className: 'bg-red-50 p-6 rounded-xl shadow-sm border border-red-100' },
                            React.createElement('h3', { className: 'text-xl font-bold text-red-800 mb-4' }, 'สินค้า 5 อันดับแรกที่จ่ายออกมากที่สุด'),
                            topIssuedItems.length === 0 ? (
                                React.createElement('p', { className: 'text-gray-600' }, 'ไม่พบข้อมูล.')
                            ) : (
                                React.createElement(
                                    'ul',
                                    { className: 'list-disc list-inside text-gray-700 space-y-2' },
                                    topIssuedItems.map((item, index) =>
                                        React.createElement('li', { key: index }, React.createElement('span', { className: 'font-semibold' }, item.name), ': ', item.quantity, ' หน่วย')
                                    )
                                )
                            )
                        )
                    )
                )
            );
        }

        // --- Item Master Component ---
        function ItemMaster() {
            const { db, userId, publicDataPath } = useContext(FirebaseContext);
            const [items, setItems] = useState([]);
            const [itemName, setItemName] = useState('');
            const [unit, setUnit] = useState('');
            const [minStock, setMinStock] = useState('');
            const [message, setMessage] = useState('');
            const [messageType, setMessageType] = useState('');
            const [editingItem, setEditingItem] = useState(null); // Stores item being edited
            const [isLoading, setIsLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');

            // Pagination states
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 10;

            // Confirmation Modal states
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [itemToDelete, setItemToDelete] = useState(null);

            // Validation states
            const [itemNameError, setItemNameError] = useState('');
            const [unitError, setUnitError] = useState('');
            const [minStockError, setMinStockError] = useState('');

            const itemsCollectionRef = collection(db, `${publicDataPath}/items`);
            const transactionsCollectionRef = collection(db, `${publicDataPath}/transactions`);

            // Fetch items from Firestore
            useEffect(() => {
                if (!db || !userId) return;
                setIsLoading(true);

                const unsubscribe = onSnapshot(itemsCollectionRef, (snapshot) => {
                    const itemsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setItems(itemsData.sort((a, b) => a.name.localeCompare(b.name))); // Sort by name
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching items:", error);
                    setMessage("เกิดข้อผิดพลาดในการดึงข้อมูลสินค้า.");
                    setMessageType('error');
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [db, userId, publicDataPath]);

            const validateForm = () => {
                let isValid = true;
                if (!itemName) {
                    setItemNameError('กรุณากรอกชื่อสินค้า');
                    isValid = false;
                } else {
                    setItemNameError('');
                }
                if (!unit) {
                    setUnitError('กรุณากรอกหน่วยนับ');
                    isValid = false;
                } else {
                    setUnitError('');
                }
                if (isNaN(parseFloat(minStock)) || parseFloat(minStock) < 0) {
                    setMinStockError('จำนวนขั้นต่ำต้องเป็นตัวเลขและไม่ติดลบ');
                    isValid = false;
                } else {
                    setMinStockError('');
                }
                return isValid;
            };

            const handleAddItem = async (e) => {
                e.preventDefault();
                setMessage('');
                setMessageType('');

                if (!validateForm()) {
                    return;
                }

                setIsLoading(true);
                try {
                    // Check if item name already exists
                    const existingItemQuery = query(itemsCollectionRef, where('name', '==', itemName));
                    const existingItemSnapshot = await getDocs(existingItemQuery);

                    if (!existingItemSnapshot.empty) {
                        setMessage(`ชื่อสินค้า "${itemName}" มีอยู่ในระบบแล้ว.`);
                        setMessageType('error');
                        setIsLoading(false);
                        return;
                    }

                    await addDoc(itemsCollectionRef, {
                        name: itemName,
                        unit: unit,
                        minStock: parseFloat(minStock),
                    });
                    setMessage('เพิ่มสินค้าใหม่เรียบร้อยแล้ว!');
                    setMessageType('success');
                    setItemName('');
                    setUnit('');
                    setMinStock('');
                    // Clear validation errors
                    setItemNameError('');
                    setUnitError('');
                    setMinStockError('');
                    setCurrentPage(1); // Reset to first page after successful submission
                } catch (e) {
                    console.error("Error adding item:", e);
                    setMessage('เกิดข้อผิดพลาดในการเพิ่มสินค้า: ' + e.message);
                    setMessageType('error');
                } finally {
                    setIsLoading(false);
                }
            };

            const handleUpdateItem = async (e) => {
                e.preventDefault();
                setMessage('');
                setMessageType('');

                if (!editingItem) return; // Should not happen if editingItem is set
                // Re-validate only unit and minStock as itemName is readOnly
                let isValid = true;
                if (!unit) {
                    setUnitError('กรุณากรอกหน่วยนับ');
                    isValid = false;
                } else {
                    setUnitError('');
                }
                if (isNaN(parseFloat(minStock)) || parseFloat(minStock) < 0) {
                    setMinStockError('จำนวนขั้นต่ำต้องเป็นตัวเลขและไม่ติดลบ');
                    isValid = false;
                } else {
                    setMinStockError('');
                }
                if (!isValid) return;


                setIsLoading(true);
                try {
                    const itemDocRef = doc(db, `${publicDataPath}/items`, editingItem.id);
                    await updateDoc(itemDocRef, {
                        unit: unit,
                        minStock: parseFloat(minStock),
                    });
                    setMessage('อัปเดตข้อมูลสินค้าเรียบร้อยแล้ว!');
                    setMessageType('success');
                    setEditingItem(null);
                    setItemName('');
                    setUnit('');
                    setMinStock('');
                    // Clear validation errors
                    setItemNameError('');
                    setUnitError('');
                    setMinStockError('');
                } catch (e) {
                    console.error("Error updating item:", e);
                    setMessage('เกิดข้อผิดพลาดในการอัปเดตสินค้า: ' + e.message);
                    setMessageType('error');
                } finally {
                    setIsLoading(false);
                }
            };

            const confirmDeleteItem = (item) => {
                setItemToDelete(item);
                setShowConfirmModal(true);
            };

            const handleActualDelete = async () => {
                if (!itemToDelete) return;

                setMessage('');
                setMessageType('');
                setIsLoading(true);
                setShowConfirmModal(false); // Close the modal immediately

                try {
                    // Before deleting item, check if there are any transactions associated with it
                    const transactionsQuery = query(transactionsCollectionRef, where('itemName', '==', itemToDelete.name));
                    const transactionsSnapshot = await getDocs(transactionsQuery);

                    if (!transactionsSnapshot.empty) {
                        setMessage(`ไม่สามารถลบสินค้า "${itemToDelete.name}" ได้ เนื่องจากมีรายการเคลื่อนไหวสินค้าที่เกี่ยวข้อง. กรุณาลบรายการเคลื่อนไหวสินค้านั้นก่อน.`);
                        setMessageType('error');
                        return;
                    }

                    const itemDocRef = doc(db, `${publicDataPath}/items`, itemToDelete.id);
                    await deleteDoc(itemDocRef);
                    setMessage('ลบสินค้าเรียบร้อยแล้ว!');
                    setMessageType('success');
                } catch (e) {
                    console.error("Error deleting item:", e);
                    setMessage('เกิดข้อผิดพลาดในการลบสินค้า: ' + e.message);
                    setMessageType('error');
                } finally {
                    setIsLoading(false);
                    setItemToDelete(null);
                }
            };

            const cancelDelete = () => {
                setShowConfirmModal(false);
                setItemToDelete(null);
            };

            const startEditing = (item) => {
                setEditingItem(item);
                setItemName(item.name);
                setUnit(item.unit);
                setMinStock(item.minStock);
                // Clear previous validation errors when starting edit
                setItemNameError('');
                setUnitError('');
                setMinStockError('');
            };

            const cancelEditing = () => {
                setEditingItem(null);
                setItemName('');
                setUnit('');
                setMinStock('');
                setMessage('');
                setMessageType('');
                // Clear validation errors
                setItemNameError('');
                setUnitError('');
                setMinStockError('');
            };

            const handleExportCSV = () => {
                let csvContent = "\uFEFF" + "ชื่อสินค้า,หน่วยนับ,จำนวนขั้นต่ำ\n";
                filteredItems.forEach(item => {
                    csvContent += `"${item.name}","${item.unit}",${item.minStock}\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `รายการสินค้าหลัก_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };

            // Filter items based on search term
            const filteredItems = items.filter(item =>
                item.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.unit.toLowerCase().includes(searchTerm.toLowerCase()) ||
                item.minStock.toString().includes(searchTerm.toLowerCase())
            );

            // Get current items for pagination
            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentItems = filteredItems.slice(indexOfFirstItem, indexOfLastItem);

            const handlePageChange = (pageNumber) => setCurrentPage(pageNumber);

            return React.createElement(
                'div',
                { className: 'bg-white p-8 rounded-2xl shadow-lg border border-gray-100 mb-8' },
                React.createElement('h2', { className: 'text-3xl font-bold text-gray-800 mb-6 border-b pb-4' }, 'เมนูสินค้า'),
                React.createElement(MessageDisplay, { message: message, type: messageType, onClose: () => setMessage('') }),

                /* Form for Add/Edit Item */
                React.createElement(
                    'form',
                    { onSubmit: editingItem ? handleUpdateItem : handleAddItem, className: 'grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 p-6 border border-gray-200 rounded-xl shadow-sm bg-gray-50' },
                    React.createElement(
                        'h3',
                        { className: 'md:col-span-2 text-2xl font-bold text-gray-700 mb-4' },
                        editingItem ? 'แก้ไขข้อมูลสินค้า' : 'เพิ่มสินค้าใหม่'
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'itemNameMaster', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'ชื่อสินค้า:'),
                        React.createElement('input', {
                            type: 'text',
                            id: 'itemNameMaster',
                            value: itemName,
                            onChange: (e) => { setItemName(e.target.value); setItemNameError(''); },
                            className: `mt-1 block w-full px-4 py-2 border ${itemNameError ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base`,
                            placeholder: 'ชื่อสินค้า',
                            required: true,
                            readOnly: !!editingItem, // Make item name read-only when editing
                        }),
                        editingItem && React.createElement('p', { className: 'text-xs text-gray-500 mt-1' }, 'ไม่สามารถแก้ไขชื่อสินค้าได้เมื่ออยู่ในโหมดแก้ไข'),
                        itemNameError && React.createElement('p', { className: 'text-red-500 text-xs mt-1' }, itemNameError)
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'unitMaster', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'หน่วยนับ:'),
                        React.createElement('input', {
                            type: 'text',
                            id: 'unitMaster',
                            value: unit,
                            onChange: (e) => { setUnit(e.target.value); setUnitError(''); },
                            className: `mt-1 block w-full px-4 py-2 border ${unitError ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base`,
                            placeholder: 'เช่น ชิ้น, กล่อง',
                            required: true,
                        }),
                        unitError && React.createElement('p', { className: 'text-red-500 text-xs mt-1' }, unitError)
                    ),
                    React.createElement(
                        'div',
                        null,
                        React.createElement('label', { htmlFor: 'minStockMaster', className: 'block text-sm font-semibold text-gray-700 mb-1' }, 'จำนวนขั้นต่ำ:'),
                        React.createElement('input', {
                            type: 'number',
                            id: 'minStockMaster',
                            value: minStock,
                            onChange: (e) => { setMinStock(e.target.value); setMinStockError(''); },
                            className: `mt-1 block w-full px-4 py-2 border ${minStockError ? 'border-red-500' : 'border-gray-300'} rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base`,
                            min: '0',
                            required: true,
                        }),
                        minStockError && React.createElement('p', { className: 'text-red-500 text-xs mt-1' }, minStockError)
                    ),
                    React.createElement(
                        'div',
                        { className: 'md:col-span-2 flex justify-end gap-3 items-center mt-4' },
                        React.createElement(
                            'button',
                            {
                                type: 'submit',
                                className: 'px-8 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105',
                                disabled: isLoading,
                            },
                            isLoading ? (editingItem ? 'กำลังบันทึก...' : 'กำลังเพิ่ม...') : (editingItem ? 'บันทึกการแก้ไข' : 'เพิ่มสินค้า')
                        ),
                        editingItem &&
                        React.createElement(
                            'button',
                            {
                                type: 'button',
                                onClick: cancelEditing,
                                className: 'px-8 py-3 bg-gray-500 text-white font-bold rounded-lg shadow-lg hover:bg-gray-600 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed transform hover:scale-105',
                                disabled: isLoading,
                            },
                            'ยกเลิก'
                        )
                    )
                ),

                /* Item List Table */
                React.createElement('h3', { className: 'text-2xl font-bold text-gray-800 mt-12 mb-6 border-b pb-4' }, 'รายการสินค้าทั้งหมด'),
                React.createElement(
                    'div',
                    { className: 'flex flex-col sm:flex-row justify-between items-center mb-6 gap-4' },
                    React.createElement('input', {
                        type: 'text',
                        placeholder: 'ค้นหาสินค้า...',
                        value: searchTerm,
                        onChange: (e) => setSearchTerm(e.target.value),
                        className: 'w-full sm:w-auto flex-grow px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-400 focus:border-transparent sm:text-base',
                    }),
                    React.createElement(
                        'button',
                        {
                            onClick: handleExportCSV,
                            className: 'px-6 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed',
                            disabled: isLoading || filteredItems.length === 0,
                        },
                        'ส่งออกเป็น CSV'
                    )
                ),
                isLoading ? (
                    React.createElement('div', { className: 'text-center text-gray-600 py-8' }, 'กำลังโหลดรายการสินค้า...')
                ) : filteredItems.length === 0 ? (
                    React.createElement('p', { className: 'text-gray-600 py-8 text-center' }, 'ไม่พบสินค้าที่ตรงกับคำค้นหา.')
                ) : (
                    React.createElement(
                        'div',
                        { className: 'overflow-x-auto rounded-xl shadow-md border border-gray-200' },
                        React.createElement(
                            'table',
                            { className: 'min-w-full divide-y divide-gray-200' },
                            React.createElement(
                                'thead',
                                { className: 'bg-blue-50' },
                                React.createElement(
                                    'tr',
                                    null,
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'ชื่อสินค้า'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'หน่วยนับ'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'จำนวนขั้นต่ำ'),
                                    React.createElement('th', { className: 'px-6 py-3 text-left text-xs font-semibold text-blue-800 uppercase tracking-wider' }, 'การดำเนินการ')
                                )
                            ),
                            React.createElement(
                                'tbody',
                                { className: 'bg-white divide-y divide-gray-200' },
                                currentItems.map((item) =>
                                    React.createElement(
                                        'tr',
                                        { key: item.id, className: 'hover:bg-gray-50' },
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, item.name),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, item.unit),
                                        React.createElement('td', { className: 'px-6 py-4 whitespace-nowrap text-sm text-gray-900' }, item.minStock),
                                        React.createElement(
                                            'td',
                                            { className: 'px-6 py-4 whitespace-nowrap text-sm' },
                                            React.createElement(
                                                'button',
                                                {
                                                    onClick: () => startEditing(item),
                                                    className: 'text-blue-600 hover:text-blue-900 mr-4 disabled:opacity-50 disabled:cursor-not-allowed font-medium',
                                                    disabled: isLoading,
                                                },
                                                'แก้ไข'
                                            ),
                                            React.createElement(
                                                'button',
                                                {
                                                    onClick: () => confirmDeleteItem(item),
                                                    className: 'text-red-600 hover:text-red-900 disabled:opacity-50 disabled:cursor-not-allowed font-medium',
                                                    disabled: isLoading,
                                                },
                                                'ลบ'
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    )
                ),
                React.createElement(Pagination, {
                    totalItems: filteredItems.length,
                    itemsPerPage: itemsPerPage,
                    currentPage: currentPage,
                    onPageChange: handlePageChange,
                }),
                /* Confirmation Modal */
                React.createElement(ConfirmationModal, {
                    isOpen: showConfirmModal,
                    title: 'ยืนยันการลบสินค้า',
                    message: `คุณแน่ใจหรือไม่ที่จะลบสินค้า "${itemToDelete?.name}"? การดำเนินการนี้ไม่สามารถย้อนกลับได้.`,
                    onConfirm: handleActualDelete,
                    onCancel: cancelDelete,
                })
            );
        }

        // --- Main App Component ---
        function App() {
            const [currentPage, setCurrentPage] = useState('receive'); // 'receive', 'issue', 'stock', 'stockByIV', 'report', 'items', 'adjustment', 'summary'
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [reportSelectedItem, setReportSelectedItem] = useState(''); // State to pass item name to report page

            // Initialize Firebase and authenticate
            useEffect(() => {
                try {
                    // Check if firebaseConfig is valid before initializing
                    if (!firebaseConfig || !firebaseConfig.apiKey || !firebaseConfig.authDomain || !firebaseConfig.projectId) {
                        setError("Failed to initialize Firebase: Missing or invalid Firebase configuration. Please ensure __firebase_config is correctly set in your Canvas environment.");
                        setLoading(false);
                        return;
                    }

                    const app = initializeApp(firebaseConfig);
                    const firestore = getFirestore(app);
                    const firebaseAuth = getAuth(app);

                    setDb(firestore);
                    setAuth(firebaseAuth);

                    const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                        if (user) {
                            setUserId(user.uid);
                        } else {
                            // Sign in anonymously if no initial token or user
                            try {
                                if (initialAuthToken) {
                                    await signInWithCustomToken(firebaseAuth, initialAuthToken);
                                } else {
                                    await signInAnonymously(firebaseAuth);
                                }
                            } catch (authError) {
                                console.error("Firebase Auth Error:", authError);
                                setError("Failed to authenticate. Please try again.");
                            }
                        }
                        setIsAuthReady(true); // Auth state is ready
                        setLoading(false);
                    });

                    return () => unsubscribe();
                } catch (e) {
                    console.error("Failed to initialize Firebase:", e);
                    setError("Failed to initialize the application. Please check your Firebase configuration: " + e.message);
                    setLoading(false);
                }
            }, []);

            if (loading) {
                return React.createElement(
                    'div',
                    { className: 'flex items-center justify-center min-h-screen bg-gray-100' },
                    React.createElement('div', { className: 'text-xl font-semibold text-gray-700' }, 'กำลังโหลด...')
                );
            }

            if (error) {
                return React.createElement(
                    'div',
                    { className: 'flex items-center justify-center min-h-screen bg-red-100 text-red-700 p-4 rounded-lg' },
                    React.createElement('div', { className: 'text-xl font-semibold' }, 'เกิดข้อผิดพลาด: ', error)
                );
            }

            if (!isAuthReady || !userId) {
                return React.createElement(
                    'div',
                    { className: 'flex items-center justify-center min-h-screen bg-gray-100' },
                    React.createElement('div', { className: 'text-xl font-semibold text-gray-700' }, 'กำลังตรวจสอบสิทธิ์ผู้ใช้...')
                );
            }

            // Base path for public data
            const publicDataPath = `artifacts/${appId}/public/data`;

            return React.createElement(
                FirebaseContext.Provider,
                { value: { db, auth, userId, publicDataPath } },
                React.createElement(
                    'div',
                    { className: 'min-h-screen bg-gray-100 font-sans antialiased flex flex-col' },
                    React.createElement(
                        'header',
                        { className: 'bg-gradient-to-br from-pink-200 to-purple-200 text-white shadow-2xl py-6 px-4 sm:px-6 lg:px-8 rounded-b-2xl' },
                        React.createElement(
                            'div',
                            { className: 'container mx-auto flex flex-col sm:flex-row justify-between items-center' },
                            React.createElement('h1', { className: 'text-3xl sm:text-4xl font-bold mb-4 sm:mb-0 text-gray-800' }, 'ระบบเบิกจ่ายสินค้า'),
                            React.createElement(
                                'nav',
                                { className: 'flex flex-wrap justify-center gap-2 sm:gap-4' },
                                React.createElement(
                                    'button',
                                    {
                                        onClick: () => setCurrentPage('receive'),
                                        className: `nav-button px-4 py-2 rounded-full font-semibold text-gray-800 transition-all duration-300 ease-in-out transform ${
                                            currentPage === 'receive' ? 'bg-gradient-to-r from-pink-300 to-purple-300 shadow-xl' : 'bg-gradient-to-r from-pink-100 to-purple-100 hover:from-pink-200 hover:to-purple-200'
                                        }`,
                                    },
                                    'รับเข้าสินค้า'
                                ),
                                React.createElement(
                                    'button',
                                    {
                                        onClick: () => setCurrentPage('issue'),
                                        className: `nav-button px-4 py-2 rounded-full font-semibold text-gray-800 transition-all duration-300 ease-in-out transform ${
                                            currentPage === 'issue' ? 'bg-gradient-to-r from-pink-300 to-purple-300 shadow-xl' : 'bg-gradient-to-r from-pink-100 to-purple-100 hover:from-pink-200 hover:to-purple-200'
                                        }`,
                                    },
                                    'จ่ายออกสินค้า'
                                ),
                                React.createElement(
                                    'button',
                                    {
                                        onClick: () => setCurrentPage('stock'),
                                        className: `nav-button px-4 py-2 rounded-full font-semibold text-gray-800 transition-all duration-300 ease-in-out transform ${
                                            currentPage === 'stock' ? 'bg-gradient-to-r from-pink-300 to-purple-300 shadow-xl' : 'bg-gradient-to-r from-pink-100 to-purple-100 hover:from-pink-200 hover:to-purple-200'
                                        }`,
                                    },
                                    'สินค้าคงเหลือ'
                                ),
                                React.createElement(
                                    'button',
                                    {
                                        onClick: () => setCurrentPage('stockByIV'),
                                        className: `nav-button px-4 py-2 rounded-full font-semibold text-gray-800 transition-all duration-300 ease-in-out transform ${
                                            currentPage === 'stockByIV' ? 'bg-gradient-to-r from-pink-300 to-purple-300 shadow-xl' : 'bg-gradient-to-r from-pink-100 to-purple-100 hover:from-pink-200 hover:to-purple-200'
                                        }`,
                                    },
                                    'สินค้าคงเหลือ (แยกเลขที่ IV)'
                                ),
                                React.createElement(
                                    'button',
                                    {
                                        onClick: () => setCurrentPage('report'),
                                        className: `nav-button px-4 py-2 rounded-full font-semibold text-gray-800 transition-all duration-300 ease-in-out transform ${
                                            currentPage === 'report' ? 'bg-gradient-to-r from-pink-300 to-purple-300 shadow-xl' : 'bg-gradient-to-r from-pink-100 to-purple-100 hover:from-pink-200 hover:to-purple-200'
                                        }`,
                                    },
                                    'รายงานเคลื่อนไหวสินค้ารายตัว'
                                ),
                                React.createElement(
                                    'button',
                                    {
                                        onClick: () => setCurrentPage('adjustment'),
                                        className: `nav-button px-4 py-2 rounded-full font-semibold text-gray-800 transition-all duration-300 ease-in-out transform ${
                                            currentPage === 'adjustment' ? 'bg-gradient-to-r from-pink-300 to-purple-300 shadow-xl' : 'bg-gradient-to-r from-pink-100 to-purple-100 hover:from-pink-200 hover:to-purple-200'
                                        }`,
                                    },
                                    'ปรับปรุงสต็อก'
                                ),
                                React.createElement(
                                    'button',
                                    {
                                        onClick: () => setCurrentPage('summary'),
                                        className: `nav-button px-4 py-2 rounded-full font-semibold text-gray-800 transition-all duration-300 ease-in-out transform ${
                                            currentPage === 'summary' ? 'bg-gradient-to-r from-pink-300 to-purple-300 shadow-xl' : 'bg-gradient-to-r from-pink-100 to-purple-100 hover:from-pink-200 hover:to-purple-200'
                                        }`,
                                    },
                                    'รายงานสรุป'
                                ),
                                React.createElement(
                                    'button',
                                    {
                                        onClick: () => setCurrentPage('items'),
                                        className: `nav-button px-4 py-2 rounded-full font-semibold text-gray-800 transition-all duration-300 ease-in-out transform ${
                                            currentPage === 'items' ? 'bg-gradient-to-r from-pink-300 to-purple-300 shadow-xl' : 'bg-gradient-to-r from-pink-100 to-purple-100 hover:from-pink-200 hover:to-purple-200'
                                        }`,
                                    },
                                    'เมนูสินค้า'
                                )
                            )
                        )
                    ),
                    React.createElement(
                        'main',
                        { className: 'flex-grow container mx-auto p-4 sm:p-6 lg:p-8 mt-8 mb-12 bg-white rounded-2xl shadow-xl' },
                        currentPage === 'receive' && React.createElement(ReceiveItems),
                        currentPage === 'issue' && React.createElement(IssueItems),
                        currentPage === 'stock' && React.createElement(StockBalance),
                        currentPage === 'stockByIV' && React.createElement(StockBalanceByIV, { setCurrentPage: setCurrentPage, setReportSelectedItem: setReportSelectedItem }),
                        currentPage === 'report' && React.createElement(ItemMovementReport, { initialSelectedItem: reportSelectedItem, setInitialSelectedItem: setReportSelectedItem }),
                        currentPage === 'adjustment' && React.createElement(StockAdjustment),
                        currentPage === 'summary' && React.createElement(SummaryReport),
                        currentPage === 'items' && React.createElement(ItemMaster)
                    ),
                    React.createElement(
                        'footer',
                        { className: 'bg-gray-900 text-gray-300 p-4 text-center text-sm rounded-t-lg shadow-inner' },
                        React.createElement('p', null, '© 2024 ระบบเบิกจ่ายสินค้า. ผู้ใช้งาน ID: ', userId)
                    )
                )
            );
        }

        // Render the App component into the root div
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(React.createElement(App));
    </script>
</body>
</html>
